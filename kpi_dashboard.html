<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Review | KPI Dashboard</title>
    <!-- SheetJS for Excel parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            /* Colors - Modern Premium Palette */
            --navy: #1B365D;
            --navy-dark: #0F1D35;
            --navy-light: #2A4A7A;
            --steel-blue: #3B82F6;
            --light-steel: #DBEAFE;
            --positive: #10B981;
            --positive-light: #D1FAE5;
            --negative: #EF4444;
            --negative-light: #FEE2E2;
            --neutral: #F59E0B;
            --neutral-light: #FEF3C7;
            --positive-soft: #34D399;
            --negative-soft: #F87171;
            --neutral-soft: #FBBF24;
            --white: #FFFFFF;
            --light-bg: #F8FAFC;
            --light-bg-gradient: linear-gradient(135deg, #F8FAFC 0%, #EEF2FF 100%);
            --text-dark: #1B365D;
            --text-muted: #64748B;
            --shadow-sm: 0 1px 2px rgba(27, 54, 93, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(27, 54, 93, 0.1), 0 2px 4px -1px rgba(27, 54, 93, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(27, 54, 93, 0.1), 0 4px 6px -2px rgba(27, 54, 93, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(27, 54, 93, 0.1), 0 10px 10px -5px rgba(27, 54, 93, 0.04);
            --shadow-glow-positive: 0 0 20px rgba(16, 185, 129, 0.3);
            --shadow-glow-negative: 0 0 20px rgba(239, 68, 68, 0.3);

            /* Typography Scale - Enhanced for readability */
            --font-display: 56px;      /* Hero values - larger */
            --font-h1: 28px;           /* Page title */
            --font-h2: 24px;           /* Section titles */
            --font-h3: 20px;           /* Chart titles, subsections */
            --font-value-xl: 36px;     /* Large card values */
            --font-value-lg: 28px;     /* Medium card values */
            --font-value-md: 22px;     /* Small card values */
            --font-value-sm: 17px;     /* Table cell values */
            --font-body-lg: 16px;      /* Large body text */
            --font-body: 15px;         /* Default body text */
            --font-body-sm: 14px;      /* Small body text */
            --font-caption: 13px;      /* Captions, badges */
            --font-label: 12px;        /* Small uppercase labels */
            --font-micro: 11px;        /* Tiny text */

            /* Animation Timing */
            --transition-fast: 150ms ease;
            --transition-normal: 250ms ease;
            --transition-slow: 400ms ease;
            --transition-bounce: 400ms cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--light-bg-gradient);
            background-attachment: fixed;
            color: var(--text-dark);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Google Font Import */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

        /* Animation Keyframes */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        @keyframes countUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes drawLine {
            to { stroke-dashoffset: 0; }
        }

        @keyframes glowPulse {
            0%, 100% { box-shadow: var(--shadow-md); }
            50% { box-shadow: var(--shadow-lg); }
        }

        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .animate-fade-in { animation: fadeIn var(--transition-slow) ease forwards; }
        .animate-fade-in-up { animation: fadeInUp var(--transition-slow) ease forwards; }
        .animate-slide-in { animation: slideInRight var(--transition-slow) ease forwards; }
        .animate-scale-in { animation: scaleIn var(--transition-bounce) forwards; }

        .header {
            background: var(--white);
            padding: 20px 48px;
            border-bottom: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-md);
            position: relative;
            z-index: 50;
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--navy) 0%, var(--steel-blue) 50%, var(--navy) 100%);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 32px;
        }

        .logo-container {
            background: var(--white);
            padding: 8px;
        }

        .logo-container svg,
        .logo-container img {
            height: 70px;
            width: auto;
            max-width: 200px;
            object-fit: contain;
        }

        .header-text h1 {
            font-size: var(--font-h1);
            font-weight: 700;
            color: var(--navy);
        }

        .header-text p {
            color: var(--text-muted);
            font-size: var(--font-body);
        }

        .header-badge {
            background: var(--navy);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: var(--font-body-sm);
            font-weight: 600;
        }

        .nav-tabs {
            display: flex;
            gap: 4px;
            padding: 0 48px;
            background: var(--white);
            border-bottom: 1px solid var(--light-steel);
            position: sticky;
            top: 0;
            z-index: 40;
            box-shadow: var(--shadow-sm);
        }

        .nav-tab {
            padding: 16px 28px;
            color: var(--text-muted);
            font-size: var(--font-body);
            font-weight: 500;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all var(--transition-normal);
            position: relative;
        }

        .nav-tab:hover {
            color: var(--navy);
            background: var(--light-bg);
        }

        .nav-tab.active {
            color: var(--navy);
            border-bottom-color: var(--steel-blue);
            font-weight: 600;
            background: linear-gradient(180deg, transparent 0%, rgba(59, 130, 246, 0.05) 100%);
        }

        .main {
            padding: 32px 48px;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Executive Summary Cards */
        .exec-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 24px;
            margin-bottom: 32px;
        }

        .metric-card {
            background: var(--white);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(219, 234, 254, 0.8);
            border-top: 4px solid var(--navy);
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--navy) 0%, var(--steel-blue) 100%);
            opacity: 0;
            transition: opacity var(--transition-normal);
        }

        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
            border-color: transparent;
        }

        .metric-card:hover::before {
            opacity: 1;
        }

        .metric-card.positive { border-top-color: var(--positive); }
        .metric-card.positive::before { background: linear-gradient(90deg, var(--positive) 0%, var(--positive-soft) 100%); }
        .metric-card.negative { border-top-color: var(--negative); }
        .metric-card.negative::before { background: linear-gradient(90deg, var(--negative) 0%, var(--negative-soft) 100%); }
        .metric-card.neutral { border-top-color: var(--neutral); }
        .metric-card.neutral::before { background: linear-gradient(90deg, var(--neutral) 0%, var(--neutral-soft) 100%); }

        .metric-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .metric-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--light-bg) 0%, var(--light-steel) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--navy);
            box-shadow: var(--shadow-sm);
        }

        .metric-label {
            font-size: var(--font-label);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: 600;
        }

        .metric-value {
            font-size: var(--font-value-xl);
            font-weight: 800;
            color: var(--navy);
            margin-bottom: 18px;
            letter-spacing: -1px;
            font-variant-numeric: tabular-nums;
        }

        /* Target comparison - primary */
        .metric-target-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: linear-gradient(135deg, var(--light-bg) 0%, rgba(219, 234, 254, 0.5) 100%);
            border-radius: 10px;
            margin-bottom: 12px;
            border: 1px solid rgba(219, 234, 254, 0.5);
        }

        .metric-target-left {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: var(--font-body-sm);
            color: var(--text-muted);
        }

        .metric-target-val {
            font-weight: 700;
            color: var(--navy);
            font-size: var(--font-body-sm);
        }

        .metric-target-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: 700;
            font-size: var(--font-body-sm);
            transition: all var(--transition-fast);
        }

        .metric-target-badge.up {
            background: linear-gradient(135deg, var(--positive-light) 0%, rgba(16, 185, 129, 0.2) 100%);
            color: var(--positive);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
        }

        .metric-target-badge.down {
            background: linear-gradient(135deg, var(--negative-light) 0%, rgba(239, 68, 68, 0.2) 100%);
            color: var(--negative);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.2);
        }

        .metric-target-badge.neutral {
            background: linear-gradient(135deg, var(--neutral-light) 0%, rgba(245, 158, 11, 0.2) 100%);
            color: var(--neutral);
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.2);
        }

        /* vs LY - secondary with arrow */
        .metric-vs-row {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: var(--font-caption);
            color: var(--text-muted);
        }

        .metric-vs-arrow {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            font-weight: 600;
        }

        .metric-vs-arrow.up { color: var(--positive); }
        .metric-vs-arrow.down { color: var(--negative); }
        .metric-vs-arrow.neutral { color: var(--neutral); }

        .metric-vs-arrow svg {
            width: 14px;
            height: 14px;
        }

        /* Share Tile - for middle row with new/returning split */
        .share-tile {
            background: var(--white);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(219, 234, 254, 0.8);
            border-top: 4px solid var(--navy);
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .share-tile::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--navy) 0%, var(--steel-blue) 100%);
            opacity: 0;
            transition: opacity var(--transition-normal);
        }

        .share-tile:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
            border-color: transparent;
        }

        .share-tile:hover::before {
            opacity: 1;
        }

        .share-tile-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .share-tile-icon {
            width: 32px;
            height: 32px;
            color: var(--navy);
        }

        .share-tile-label {
            font-size: var(--font-label);
            color: var(--text-muted);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .share-tile-main {
            display: flex;
            align-items: baseline;
            gap: 12px;
            margin-bottom: 12px;
        }

        .share-tile-value {
            font-size: var(--font-value-lg);
            font-weight: 700;
            color: var(--navy);
        }

        .share-tile-change {
            font-size: var(--font-body-sm);
            font-weight: 600;
        }

        .share-tile-split {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--light-steel);
        }

        .share-split-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .share-split-label {
            font-size: var(--font-label);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .share-split-row {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .share-split-value {
            font-size: var(--font-body);
            font-weight: 600;
            color: var(--navy);
        }

        .share-split-pct {
            font-size: var(--font-caption);
            color: var(--text-muted);
            font-weight: 500;
        }

        .share-split-change {
            font-size: var(--font-label);
            font-weight: 600;
        }

        .share-split-change.up { color: var(--positive); }
        .share-split-change.down { color: var(--negative); }
        .share-split-change.neutral { color: var(--neutral); }

        .share-split-vs {
            display: flex;
            align-items: center;
            gap: 3px;
            margin-top: 2px;
        }

        .share-split-arrow {
            display: inline-flex;
            align-items: center;
        }

        .share-split-arrow svg {
            width: 12px;
            height: 12px;
        }

        .share-split-arrow.up { color: var(--positive); }
        .share-split-arrow.down { color: var(--negative); }
        .share-split-arrow.neutral { color: var(--neutral); }

        .share-split-vs-label {
            font-size: var(--font-micro);
            color: var(--text-muted);
            margin-left: 2px;
        }

        /* Small Tile - for bottom row (AOV, Frequency, ACV, UPT) */
        .small-tile {
            background: var(--white);
            border-radius: 14px;
            padding: 20px;
            border: 1px solid rgba(219, 234, 254, 0.8);
            border-top: 3px solid var(--navy);
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-normal);
        }

        .small-tile:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .small-tile-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .small-tile-icon {
            width: 24px;
            height: 24px;
            color: var(--navy);
        }

        .small-tile-label {
            font-size: var(--font-label);
            color: var(--text-muted);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.4px;
        }

        .small-tile-value {
            font-size: var(--font-value-md);
            font-weight: 700;
            color: var(--navy);
            margin-bottom: 4px;
        }

        .small-tile-footer {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: var(--font-label);
        }

        .small-tile-change {
            font-weight: 600;
        }

        .small-tile-label-vs {
            color: var(--text-muted);
        }

        .small-tile-target {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: var(--font-label);
            color: var(--text-muted);
            margin-bottom: 6px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--light-steel);
        }

        .small-tile-target-badge {
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .small-tile-target-badge.up {
            background: rgba(46, 125, 90, 0.15);
            color: var(--positive);
        }

        .small-tile-target-badge.down {
            background: rgba(196, 49, 75, 0.15);
            color: var(--negative);
        }

        .small-tile-target-badge.neutral {
            background: rgba(184, 134, 11, 0.15);
            color: var(--neutral);
        }

        .small-tile-arrow {
            display: inline-flex;
            align-items: center;
        }

        .small-tile-arrow svg {
            width: 14px;
            height: 14px;
        }

        .small-tile-arrow.up { color: var(--positive); }
        .small-tile-arrow.down { color: var(--negative); }
        .small-tile-arrow.neutral { color: var(--neutral); }

        /* KPI Rows Layout */
        .kpi-row-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .kpi-row-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .kpi-row-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        /* Section Headers */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 28px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--light-steel);
        }

        .section-title {
            font-size: var(--font-h2);
            font-weight: 700;
            color: var(--navy);
            letter-spacing: -0.3px;
            position: relative;
            padding-left: 16px;
        }

        .section-title::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 24px;
            background: linear-gradient(180deg, var(--steel-blue) 0%, var(--navy) 100%);
            border-radius: 2px;
        }

        .section-subtitle {
            color: var(--text-muted);
            font-size: var(--font-body);
        }

        /* Market Comparison Table */
        .market-table {
            width: 100%;
            background: var(--white);
            border-radius: 16px;
            overflow: hidden;
            border: none;
            margin-bottom: 40px;
            border-collapse: separate;
            border-spacing: 0;
            box-shadow: var(--shadow-md);
        }

        .market-table th {
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-dark) 100%);
            padding: 18px 20px;
            text-align: center;
            font-size: var(--font-caption);
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: 600;
        }

        .market-table th.left { text-align: left; }

        .market-table td {
            padding: 18px 20px;
            border-bottom: 1px solid rgba(219, 234, 254, 0.5);
            font-size: var(--font-body);
            text-align: center;
            transition: background var(--transition-fast);
        }

        .market-table tr:hover td {
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.05) 0%, transparent 100%);
        }

        .market-table tr.total-row td {
            background: linear-gradient(90deg, rgba(27, 54, 93, 0.08) 0%, rgba(27, 54, 93, 0.03) 100%);
            font-weight: 600;
            border-top: 2px solid var(--navy);
        }

        .market-name {
            font-weight: 600;
            color: var(--navy);
            text-align: left !important;
            white-space: nowrap;
        }

        .market-name.total {
            color: var(--navy);
        }

        .cell-value {
            font-weight: 700;
            font-size: var(--font-value-sm);
            color: var(--navy);
        }

        .cell-changes {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            margin-top: 4px;
            font-size: var(--font-caption);
            font-weight: 500;
        }

        .cell-change-item.up { color: var(--positive); }
        .cell-change-item.down { color: var(--negative); }
        .cell-change-item.neutral { color: var(--neutral); }
        .cell-divider { color: var(--text-muted); }

        .cell-sub {
            font-size: var(--font-label);
            font-weight: 500;
        }

        .cell-sub.up { color: var(--positive); }
        .cell-sub.down { color: var(--negative); }
        .cell-sub.neutral { color: var(--neutral); }

        /* Insights Panel */
        .insights-panel {
            background: linear-gradient(135deg, var(--white) 0%, rgba(219, 234, 254, 0.3) 100%);
            border-radius: 16px;
            padding: 32px;
            border: 1px solid rgba(219, 234, 254, 0.8);
            border-left: 5px solid var(--steel-blue);
            margin-bottom: 40px;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }

        .insights-panel::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.05) 0%, transparent 70%);
            pointer-events: none;
        }

        .insights-title {
            font-size: var(--font-h3);
            font-weight: 700;
            color: var(--navy);
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .insights-title::before {
            content: 'ðŸ’¡';
            font-size: 20px;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .insight-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 18px 20px;
            background: var(--white);
            border-radius: 12px;
            transition: all var(--transition-normal);
            border: 1px solid transparent;
            box-shadow: var(--shadow-sm);
        }

        .insight-item:hover {
            transform: translateX(4px);
            border-color: var(--light-steel);
            box-shadow: var(--shadow-md);
        }

        .insight-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            flex-shrink: 0;
        }

        .insight-icon.green {
            background: linear-gradient(135deg, var(--positive-light) 0%, rgba(16, 185, 129, 0.2) 100%);
        }
        .insight-icon.amber {
            background: linear-gradient(135deg, var(--neutral-light) 0%, rgba(245, 158, 11, 0.2) 100%);
        }
        .insight-icon.blue {
            background: linear-gradient(135deg, var(--light-steel) 0%, rgba(59, 130, 246, 0.2) 100%);
        }

        .insight-text {
            font-size: var(--font-body);
            color: var(--text-dark);
            line-height: 1.6;
        }

        .insight-text strong {
            color: var(--navy);
            font-weight: 600;
        }

        /* Collapsible Insights Panel */
        .insights-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
        }

        .insights-toggle {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: rgba(59, 130, 246, 0.1);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-normal);
            color: var(--steel-blue);
            font-size: 16px;
        }

        .insights-toggle:hover {
            background: rgba(59, 130, 246, 0.2);
        }

        .insights-toggle svg {
            transition: transform var(--transition-normal);
        }

        .insights-panel.collapsed .insights-toggle svg {
            transform: rotate(-90deg);
        }

        .insights-content {
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            max-height: 1000px;
            opacity: 1;
        }

        .insights-panel.collapsed .insights-content {
            max-height: 0;
            opacity: 0;
        }

        .insights-panel.collapsed .insights-title {
            margin-bottom: 0;
        }

        /* Filters */
        .filter-row {
            display: flex;
            gap: 20px;
            margin-bottom: 28px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group label {
            display: block;
            font-size: var(--font-label);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .filter-select {
            background: var(--white);
            border: 2px solid var(--light-steel);
            color: var(--navy);
            padding: 14px 48px 14px 18px;
            border-radius: 10px;
            font-size: var(--font-body);
            font-weight: 600;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%231B365D' viewBox='0 0 16 16'%3E%3Cpath d='M8 12L2 6h12l-6 6z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            min-width: 200px;
            transition: all var(--transition-normal);
            box-shadow: var(--shadow-sm);
        }

        .filter-select:hover {
            border-color: var(--steel-blue);
            box-shadow: var(--shadow-md);
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--steel-blue);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
        }

        .filter-select option {
            padding: 12px 16px;
            font-size: var(--font-body-lg);
            color: var(--navy);
            background: var(--white);
        }

        .filter-select option:checked {
            background: var(--light-steel);
        }

        .filter-select optgroup {
            font-weight: 700;
            color: var(--navy);
            background: var(--light-bg);
            font-size: var(--font-body-sm);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-select optgroup option {
            font-weight: 400;
            text-transform: none;
            letter-spacing: normal;
            padding-left: 16px;
        }

        /* Upload Overlay */
        .upload-overlay {
            position: fixed;
            inset: 0;
            background: rgba(27, 54, 93, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .upload-box {
            background: var(--white);
            border-radius: 16px;
            padding: 48px 64px;
            text-align: center;
            max-width: 480px;
        }

        .upload-logo { margin-bottom: 24px; }
        .upload-logo svg { height: 100px; }

        .upload-box h2 { font-size: var(--font-h1); color: var(--navy); margin-bottom: 8px; }
        .upload-box p { color: var(--text-muted); margin-bottom: 24px; }

        .dropzone {
            border: 2px dashed var(--light-steel);
            border-radius: 12px;
            padding: 32px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 16px;
        }

        .dropzone:hover { border-color: var(--navy); background: var(--light-bg); }
        .dropzone-text { color: var(--text-muted); }
        .dropzone-text span { color: var(--navy); font-weight: 600; }

        .btn-primary {
            background: var(--navy);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            font-size: var(--font-body);
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-primary:hover { background: #152a4a; }

        /* Chart Container */
        .chart-container {
            background: var(--white);
            border-radius: 16px;
            padding: 32px;
            border: 1px solid rgba(219, 234, 254, 0.8);
            margin-bottom: 24px;
            box-shadow: var(--shadow-md);
            transition: all var(--transition-normal);
        }

        .chart-container:hover {
            box-shadow: var(--shadow-lg);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--light-steel);
        }

        .chart-title {
            font-size: var(--font-h3);
            font-weight: 700;
            color: var(--navy);
            letter-spacing: -0.3px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(180deg, var(--steel-blue) 0%, var(--navy) 100%);
            border-radius: 2px;
        }

        .chart-legend {
            display: flex;
            gap: 20px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: var(--font-body-sm);
            color: var(--text-muted);
        }

        .legend-dot {
            width: 16px;
            height: 3px;
            border-radius: 2px;
        }

        .legend-dot.solid { background: var(--navy); }
        .legend-dot.dashed { background: repeating-linear-gradient(90deg, var(--steel-blue) 0, var(--steel-blue) 4px, transparent 4px, transparent 8px); }
        .legend-dot.target { background: var(--positive); }

        .chart-svg {
            width: 100%;
            height: 420px;
        }

        /* KPI Hero Card - Primary value display */
        .kpi-hero-card {
            background: linear-gradient(135deg, var(--white) 0%, rgba(219, 234, 254, 0.2) 100%);
            border-radius: 20px;
            padding: 28px 32px;
            border: 1px solid rgba(219, 234, 254, 0.8);
            border-top: 5px solid var(--navy);
            margin-bottom: 24px;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        .kpi-hero-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--navy) 0%, var(--steel-blue) 100%);
        }

        .kpi-hero-card::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.08) 0%, transparent 70%);
            pointer-events: none;
        }

        .kpi-hero-card.up { border-top-color: var(--positive); }
        .kpi-hero-card.up::before { background: linear-gradient(90deg, var(--positive) 0%, var(--positive-soft) 100%); }
        .kpi-hero-card.down { border-top-color: var(--negative); }
        .kpi-hero-card.down::before { background: linear-gradient(90deg, var(--negative) 0%, var(--negative-soft) 100%); }
        .kpi-hero-card.neutral { border-top-color: var(--neutral); }
        .kpi-hero-card.neutral::before { background: linear-gradient(90deg, var(--neutral) 0%, var(--neutral-soft) 100%); }

        .kpi-hero-label {
            font-size: var(--font-caption);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        /* Hero card main layout - two columns */
        .kpi-hero-content {
            display: flex;
            align-items: stretch;
            gap: 24px;
            position: relative;
            z-index: 1;
        }

        .kpi-hero-main {
            flex: 1;
            min-width: 0;
        }

        .kpi-hero-value {
            font-size: 44px;
            font-weight: 800;
            color: var(--navy);
            margin-bottom: 16px;
            letter-spacing: -1.5px;
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Primary comparison - vs Target (prominent) */
        .kpi-hero-target {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: linear-gradient(135deg, var(--light-bg) 0%, rgba(219, 234, 254, 0.5) 100%);
            border-radius: 10px;
            border: 1px solid rgba(219, 234, 254, 0.5);
            gap: 16px;
        }

        .kpi-hero-target-info {
            display: flex;
            flex-direction: column;
            gap: 1px;
        }

        .kpi-hero-target-label {
            font-size: var(--font-label);
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .kpi-hero-target-detail {
            font-size: var(--font-caption);
            color: var(--navy);
            font-weight: 600;
        }

        .kpi-hero-target-badge {
            font-size: var(--font-body-lg);
            font-weight: 700;
            padding: 4px 12px;
            border-radius: 6px;
            white-space: nowrap;
        }

        .kpi-hero-target-badge.up {
            background: rgba(46, 125, 90, 0.12);
            color: var(--positive);
        }

        .kpi-hero-target-badge.down {
            background: rgba(196, 49, 75, 0.12);
            color: var(--negative);
        }

        .kpi-hero-target-badge.neutral {
            background: rgba(184, 134, 11, 0.12);
            color: var(--neutral);
        }

        /* Right section - secondary comparisons */
        .kpi-hero-secondary {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding-left: 24px;
            border-left: 1px solid var(--light-steel);
            justify-content: center;
            min-width: 0;
        }

        /* Hero row with market breakdown */
        .kpi-hero-row {
            display: flex;
            gap: 24px;
            margin-bottom: 24px;
        }

        .kpi-hero-row .kpi-hero-card {
            flex: 2;
            margin-bottom: 0;
        }

        /* Market breakdown tile */
        .market-breakdown-card {
            flex: 1;
            background: var(--white);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--light-steel);
        }

        .market-breakdown-title {
            font-size: var(--font-body-sm);
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 20px;
        }

        .breakdown-single-value {
            font-size: var(--font-value-md);
            font-weight: 600;
            color: var(--navy);
            text-align: center;
            padding: 30px 0;
        }

        .market-breakdown-list {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .market-breakdown-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .market-breakdown-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .market-breakdown-name {
            font-size: var(--font-body-sm);
            font-weight: 600;
            color: var(--navy);
        }

        .market-breakdown-value {
            font-size: var(--font-body-sm);
            font-weight: 700;
            color: var(--navy);
        }

        .market-breakdown-bar-bg {
            height: 8px;
            background: var(--light-bg);
            border-radius: 4px;
            overflow: hidden;
        }

        .market-breakdown-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .market-breakdown-bar.bar-1 { background: var(--navy); }
        .market-breakdown-bar.bar-2 { background: var(--steel-blue); }
        .market-breakdown-bar.bar-3 { background: var(--light-steel); }
        .market-breakdown-bar.bar-4 { background: #A8C5DA; }

        .kpi-secondary-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            padding: 16px 20px;
            background: var(--light-bg);
            border-radius: 10px;
        }

        .kpi-secondary-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .kpi-secondary-label {
            font-size: var(--font-body);
            font-weight: 700;
            color: var(--navy);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .kpi-secondary-detail {
            font-size: var(--font-body);
            color: var(--text-muted);
        }

        .kpi-secondary-value {
            font-size: var(--font-value-md);
            font-weight: 700;
        }

        .kpi-secondary-value.up { color: var(--positive); }
        .kpi-secondary-value.down { color: var(--negative); }
        .kpi-secondary-value.neutral { color: var(--neutral); }

        /* Legacy - keep for backwards compat */
        .kpi-hero-comparisons {
            display: flex;
            gap: 32px;
            padding-top: 20px;
            border-top: 1px solid var(--light-steel);
        }

        .kpi-comparison-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .kpi-comp-label {
            font-size: var(--font-label);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .kpi-comp-value {
            font-size: var(--font-h3);
            font-weight: 700;
        }

        .kpi-comp-value.up { color: var(--positive); }
        .kpi-comp-value.down { color: var(--negative); }
        .kpi-comp-value.neutral { color: var(--neutral); }

        .kpi-comp-detail {
            font-size: var(--font-caption);
            color: var(--text-muted);
        }

        /* Chart with badges side-by-side layout */
        .chart-with-badges {
            display: flex;
            gap: 24px;
            align-items: stretch;
        }

        .chart-with-badges .chart-container {
            flex: 3;
            margin-bottom: 0;
        }

        .trend-badges-right {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(6, 1fr);
            gap: 10px;
            background: var(--white);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--light-steel);
        }

        .trend-badges {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 12px;
            margin-top: 24px;
        }

        .trend-badge {
            background: var(--white);
            padding: 14px 12px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(219, 234, 254, 0.8);
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-normal);
        }

        .trend-badge:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .trend-badges-right .trend-badge {
            padding: 8px 6px;
            background: var(--light-bg);
            border: none;
        }

        .trend-badges-right .trend-badge-month {
            font-size: var(--font-label);
            margin-bottom: 4px;
        }

        .trend-badges-right .trend-badge-actual {
            font-size: var(--font-body);
            margin-bottom: 4px;
        }

        .trend-badges-right .trend-badge-value {
            font-size: var(--font-caption);
        }

        .trend-badges-right .trend-badge-label {
            font-size: var(--font-micro);
        }

        .trend-badge-month {
            font-size: var(--font-body-sm);
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .trend-badge-actual {
            font-size: var(--font-h3);
            font-weight: 700;
            color: var(--navy);
            margin-bottom: 6px;
        }

        .trend-badge-value {
            font-size: var(--font-body);
            font-weight: 600;
        }

        .trend-badge-value.up { color: var(--positive); }
        .trend-badge-value.down { color: var(--negative); }
        .trend-badge-value.neutral { color: var(--neutral); }

        .trend-badge-label {
            font-weight: 400;
            color: var(--text-muted);
            font-size: var(--font-caption);
        }

        /* Modern Market Table */
        .market-analysis-grid {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 40px;
            align-items: start;
        }

        .modern-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 12px;
            overflow: hidden;
        }

        .modern-table th {
            padding: 18px 20px;
            text-align: center;
            font-size: var(--font-caption);
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: 600;
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-dark) 100%);
        }

        .modern-table th:first-child {
            text-align: left;
            border-radius: 12px 0 0 0;
        }
        .modern-table th:last-child {
            border-radius: 0 12px 0 0;
        }
        .modern-table th.right { text-align: right; }
        .modern-table th.center { text-align: center; }

        .modern-table td {
            padding: 18px 20px;
            font-size: var(--font-body);
            border-bottom: 1px solid rgba(219, 234, 254, 0.5);
            vertical-align: middle;
            transition: background var(--transition-fast);
        }

        .modern-table tbody tr:hover td {
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.05) 0%, transparent 100%);
        }

        .modern-table tr:last-child td {
            border-bottom: none;
        }

        .modern-table tr:last-child td:first-child {
            border-radius: 0 0 0 12px;
        }

        .modern-table tr:last-child td:last-child {
            border-radius: 0 0 12px 0;
        }

        .modern-table .market-cell {
            font-weight: 600;
            color: var(--navy);
            white-space: nowrap;
            font-size: var(--font-body);
        }

        .modern-table .value-cell {
            text-align: center;
            font-weight: 700;
            color: var(--navy);
            font-variant-numeric: tabular-nums;
            font-size: var(--font-value-sm);
        }

        .modern-table .compare-cell {
            text-align: center;
        }

        .modern-table .compare-group {
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .modern-table .compare-value {
            color: var(--text-muted);
            font-size: var(--font-body);
            font-variant-numeric: tabular-nums;
        }

        .modern-table .compare-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: var(--font-caption);
            font-weight: 600;
            min-width: 56px;
            text-align: center;
            transition: all var(--transition-fast);
        }

        .modern-table .compare-badge.up {
            background: linear-gradient(135deg, var(--positive-light) 0%, rgba(16, 185, 129, 0.15) 100%);
            color: var(--positive);
        }

        .modern-table .compare-badge.down {
            background: linear-gradient(135deg, var(--negative-light) 0%, rgba(239, 68, 68, 0.15) 100%);
            color: var(--negative);
        }

        .modern-table .compare-badge.neutral {
            background: linear-gradient(135deg, var(--neutral-light) 0%, rgba(245, 158, 11, 0.15) 100%);
            color: var(--neutral);
        }

        .modern-table .total-row {
            background: linear-gradient(90deg, rgba(27, 54, 93, 0.08) 0%, rgba(27, 54, 93, 0.02) 100%);
        }

        .modern-table .total-row td {
            font-weight: 600;
            border-top: 2px solid var(--navy);
        }

        .modern-table .total-row td {
            border-top: 2px solid var(--navy);
            border-bottom: none;
            padding-top: 16px;
            padding-bottom: 16px;
        }

        .modern-table .total-row .market-cell {
            font-weight: 700;
        }

        /* Share Bar */
        .share-cell {
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
        }

        .share-value {
            font-weight: 600;
            color: var(--navy);
            min-width: 36px;
            text-align: right;
        }

        .share-bar-bg {
            width: 80px;
            height: 8px;
            background: rgba(184, 212, 232, 0.3);
            border-radius: 4px;
            overflow: hidden;
        }

        .share-bar {
            height: 100%;
            background: var(--navy);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* Donut Chart */
        .donut-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background: var(--light-bg);
            border-radius: 12px;
        }

        .donut-title {
            font-size: var(--font-caption);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            font-weight: 700;
            margin-bottom: 20px;
        }

        .donut-wrapper {
            position: relative;
            width: 240px;
            height: 240px;
        }

        .donut-chart {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .donut-chart svg {
            transform: rotate(-90deg);
        }

        .donut-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .donut-center-value {
            font-size: var(--font-value-md);
            font-weight: 700;
            color: var(--navy);
        }

        .donut-center-label {
            font-size: var(--font-label);
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .donut-callouts {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .donut-callout {
            position: absolute;
            font-size: var(--font-label);
            font-weight: 600;
            white-space: nowrap;
        }

        .donut-callout-label {
            color: var(--navy);
            font-size: var(--font-caption);
        }

        .donut-callout-value {
            color: var(--text-muted);
            font-size: var(--font-label);
        }

        .donut-legend {
            display: none;
            font-size: var(--font-caption);
        }

        .donut-legend-color {
            width: 10px;
            height: 10px;
            border-radius: 2px;
        }

        .donut-legend-label {
            flex: 1;
            color: var(--text-dark);
        }

        .donut-legend-value {
            color: var(--text-muted);
            font-variant-numeric: tabular-nums;
        }

        .cell-na {
            color: var(--text-muted);
            font-style: italic;
        }

        /* Inline compare values for Market Summary table */
        .cell-compare-inline {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            margin-top: 4px;
            font-size: var(--font-caption);
            flex-wrap: wrap;
        }

        .cell-compare-label {
            color: var(--text-muted);
            font-weight: 500;
        }

        .cell-compare-value {
            font-weight: 600;
        }

        .cell-compare-value.up { color: var(--positive); }
        .cell-compare-value.down { color: var(--negative); }
        .cell-compare-value.neutral { color: var(--neutral); }

        .cell-divider {
            color: var(--light-steel);
            margin: 0 4px;
        }

        /* Tooltip */
        .chart-tooltip {
            position: fixed;
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-dark) 100%);
            color: white;
            padding: 14px 18px;
            border-radius: 12px;
            font-size: var(--font-body-sm);
            pointer-events: none;
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(27, 54, 93, 0.3);
            display: none;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 180px;
        }

        .chart-tooltip.visible {
            display: block;
            animation: scaleIn var(--transition-fast) ease;
        }

        .tooltip-title {
            font-weight: 700;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            font-size: var(--font-body);
        }

        .tooltip-row {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-top: 6px;
        }

        .tooltip-label {
            opacity: 0.7;
            font-size: var(--font-caption);
        }

        .tooltip-value {
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }

        @media (max-width: 1200px) {
            .exec-summary { grid-template-columns: repeat(2, 1fr); }
            .insights-grid { grid-template-columns: 1fr; }
            .trend-badges { grid-template-columns: repeat(4, 1fr); }
        }

        @media (max-width: 768px) {
            .header, .main, .nav-tabs { padding-left: 20px; padding-right: 20px; }
            .exec-summary { grid-template-columns: 1fr; }
            .trend-badges { grid-template-columns: repeat(3, 1fr); }
        }

        /* Mode Selection Styles */
        .mode-selector {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
        }

        .mode-card {
            flex: 1;
            background: var(--white);
            border: 2px solid var(--light-steel);
            border-radius: 12px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .mode-card:hover {
            border-color: var(--steel-blue);
            background: var(--light-bg);
        }

        .mode-card.selected {
            border-color: var(--navy);
            background: rgba(27, 54, 93, 0.05);
        }

        .mode-card-icon {
            font-size: var(--font-value-xl);
            margin-bottom: 12px;
        }

        .mode-card-title {
            font-size: var(--font-h3);
            font-weight: 700;
            color: var(--navy);
            margin-bottom: 4px;
        }

        .mode-card-desc {
            font-size: var(--font-body-sm);
            color: var(--text-muted);
        }

        /* Header Mode Switcher */
        .header-mode-switcher {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-right: 16px;
        }

        .mode-toggle {
            display: flex;
            background: var(--light-bg);
            border-radius: 8px;
            padding: 4px;
            border: 1px solid var(--light-steel);
        }

        .mode-toggle-btn {
            padding: 8px 16px;
            font-size: var(--font-body-sm);
            font-weight: 600;
            color: var(--text-muted);
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-toggle-btn.active {
            background: var(--navy);
            color: white;
        }

        .mode-toggle-btn:hover:not(.active) {
            background: var(--light-steel);
            color: var(--navy);
        }

        /* Cascade Filter Styles */
        .filter-cascade {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        /* Comparison Tables */
        .comparison-section {
            margin-bottom: 32px;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
        }

        @media (max-width: 1200px) {
            .comparison-grid {
                grid-template-columns: 1fr;
            }
        }

        .comparison-stack {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        /* Upload file type hint */
        .upload-hint {
            font-size: var(--font-caption);
            color: var(--text-muted);
            margin-top: 8px;
        }

        .upload-hint strong {
            color: var(--navy);
        }

        /* CSV Upload Grid */
        .csv-upload-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin: 20px 0;
        }

        .csv-upload-card {
            border: 1px solid var(--light-steel);
            border-radius: 8px;
            overflow: hidden;
        }

        .csv-upload-header {
            background: var(--light-bg);
            padding: 10px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid var(--light-steel);
        }

        .csv-upload-icon {
            font-size: var(--font-value-sm);
        }

        .csv-upload-title {
            font-weight: 600;
            color: var(--navy);
            font-size: var(--font-body-sm);
        }

        .csv-upload-zone {
            padding: 24px 16px;
            text-align: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .csv-upload-zone:hover {
            background: var(--light-bg);
        }

        .csv-upload-text {
            color: var(--text-muted);
            font-size: var(--font-body-sm);
            margin: 0;
        }

        .csv-file-selected {
            color: var(--positive);
            font-weight: 500;
            font-size: var(--font-body-sm);
        }

        .upload-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 16px;
        }

        .btn-secondary {
            background: var(--white);
            color: var(--navy);
            border: 1px solid var(--light-steel);
            padding: 10px 24px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background: var(--light-bg);
            border-color: var(--steel-blue);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .demo-btn-small {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--white);
            color: var(--text-muted);
            border: 1px solid var(--light-steel);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: var(--font-caption);
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-normal);
            box-shadow: var(--shadow-sm);
            z-index: 100;
        }

        .demo-btn-small:hover {
            background: var(--light-bg);
            border-color: var(--steel-blue);
            color: var(--navy);
            box-shadow: var(--shadow-md);
        }

        /* Segmentation Tab Styles */
        .segment-comparison-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .segment-card {
            background: var(--white);
            border: 1px solid var(--light-steel);
            border-radius: 12px;
            padding: 20px;
        }

        .segment-card.total { border-left: 4px solid var(--navy); }
        .segment-card.new { border-left: 4px solid var(--positive); }
        .segment-card.returning { border-left: 4px solid var(--steel-blue); }

        .segment-card-title {
            font-size: var(--font-body-sm);
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 12px;
        }

        .segment-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--light-bg);
        }

        .segment-metric:last-child { border-bottom: none; }

        .segment-metric-name {
            font-size: var(--font-body-sm);
            color: var(--text-secondary);
        }

        .segment-metric-value {
            font-size: var(--font-body);
            font-weight: 600;
            color: var(--navy);
        }

        .segment-metric-change {
            font-size: var(--font-label);
            margin-left: 8px;
        }

        .segment-change-label {
            color: var(--text-muted);
            font-weight: 400;
            margin-right: 2px;
        }

        .segment-metric-share {
            font-size: var(--font-label);
            color: var(--steel-blue);
            font-weight: 500;
            min-width: 32px;
            text-align: right;
        }

        /* Segment Table Styles */
        .segment-table-container {
            background: var(--white);
            border-radius: 12px;
            border: 1px solid var(--light-steel);
            overflow: hidden;
            margin-bottom: 24px;
        }

        .segment-table {
            width: 100%;
            border-collapse: collapse;
        }

        .segment-table th {
            background: var(--navy);
            color: white;
            padding: 14px 16px;
            text-align: center;
            font-size: var(--font-caption);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .segment-table th:first-child {
            text-align: left;
        }

        .segment-table th.new-col {
            background: var(--positive);
        }

        .segment-table th.returning-col {
            background: var(--steel-blue);
        }

        .segment-table td {
            padding: 12px 16px;
            font-size: var(--font-body-sm);
            border-bottom: 1px solid var(--light-steel);
            text-align: center;
        }

        .segment-table td:first-child {
            text-align: left;
            font-weight: 500;
            color: var(--navy);
        }

        .segment-table tr:last-child td {
            border-bottom: none;
        }

        .segment-table tr:hover td {
            background: rgba(143, 175, 212, 0.08);
        }

        .segment-cell-value {
            font-weight: 600;
            color: var(--navy);
        }

        .segment-cell-share {
            font-size: var(--font-label);
            color: var(--text-muted);
            margin-left: 4px;
        }

        .segment-cell-change {
            display: block;
            font-size: var(--font-label);
            margin-top: 2px;
            font-weight: 500;
        }

        .segment-cell-change.up { color: var(--positive); }
        .segment-cell-change.down { color: var(--negative); }
        .segment-cell-change.neutral { color: var(--neutral); }

        /* New Segment Visual Styles */
        .segment-visual-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        @media (max-width: 1200px) {
            .segment-visual-grid {
                grid-template-columns: 1fr;
            }
        }

        .segment-visual-card {
            background: var(--white);
            border-radius: 16px;
            border: 1px solid rgba(219, 234, 254, 0.8);
            border-top: 4px solid var(--navy);
            padding: 28px;
            box-shadow: var(--shadow-md);
            transition: all var(--transition-normal);
            position: relative;
        }

        .segment-visual-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        .segment-visual-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .segment-visual-title {
            font-size: var(--font-body);
            font-weight: 600;
            color: var(--navy);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .segment-visual-total {
            text-align: right;
        }

        .segment-visual-value {
            font-size: var(--font-value-lg);
            font-weight: 700;
            color: var(--navy);
        }

        .segment-visual-target {
            font-size: var(--font-caption);
            color: var(--text-muted);
            margin-top: 4px;
        }

        .segment-visual-target-badge {
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 4px;
            background: rgba(143, 175, 212, 0.2);
            color: var(--navy);
        }

        .segment-visual-target-badge.up {
            background: rgba(46, 125, 90, 0.15);
            color: var(--positive);
        }

        .segment-visual-target-badge.down {
            background: rgba(196, 49, 75, 0.15);
            color: var(--negative);
        }

        .segment-visual-target-badge.neutral {
            background: rgba(184, 134, 11, 0.15);
            color: var(--neutral);
        }

        .segment-visual-change {
            font-size: var(--font-caption);
            margin-top: 4px;
        }

        .segment-visual-change span:first-child {
            font-weight: 600;
        }

        /* Split Bar */
        .segment-split-bar {
            height: 24px;
            border-radius: 6px;
            overflow: hidden;
            display: flex;
            margin: 16px 0;
        }

        .segment-split-new {
            background: var(--positive);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: var(--font-label);
            font-weight: 600;
            min-width: 40px;
        }

        .segment-split-returning {
            background: var(--steel-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: var(--font-label);
            font-weight: 600;
            min-width: 40px;
        }

        /* Split Details */
        .segment-split-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .segment-split-section {
            padding: 12px;
            border-radius: 8px;
            background: var(--light-bg);
        }

        .segment-split-section.new {
            border-left: 3px solid var(--positive);
        }

        .segment-split-section.returning {
            border-left: 3px solid var(--steel-blue);
        }

        .segment-split-section-label {
            font-size: var(--font-label);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 4px;
        }

        .segment-split-section-value {
            font-size: var(--font-body);
            font-weight: 600;
            color: var(--navy);
        }

        .segment-split-section-share {
            font-size: var(--font-caption);
            color: var(--text-muted);
            margin-left: 4px;
        }

        .segment-split-section-change {
            font-size: var(--font-label);
            margin-top: 4px;
            font-weight: 500;
        }

        .segment-split-section-change.up { color: var(--positive); }
        .segment-split-section-change.down { color: var(--negative); }
        .segment-split-section-change.neutral { color: var(--neutral); }

        /* Target Scorecard Styles */
        .scorecard-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
        }

        .scorecard-item {
            background: var(--white);
            border: 1px solid var(--light-steel);
            border-radius: 8px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .scorecard-indicator {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-h3);
            flex-shrink: 0;
        }

        .scorecard-indicator.green { background: rgba(46, 125, 90, 0.15); }
        .scorecard-indicator.amber { background: rgba(184, 134, 11, 0.15); }
        .scorecard-indicator.red { background: rgba(196, 49, 75, 0.15); }
        .scorecard-indicator.neutral { background: var(--light-bg); color: var(--text-muted); }

        .scorecard-details {
            flex: 1;
            min-width: 0;
        }

        .scorecard-kpi {
            font-size: var(--font-caption);
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .scorecard-value {
            font-size: var(--font-body);
            font-weight: 600;
            color: var(--navy);
        }

        .scorecard-gap {
            font-size: var(--font-caption);
            font-weight: 500;
        }

        .scorecard-gap.up { color: var(--positive); }
        .scorecard-gap.down { color: var(--negative); }
        .scorecard-gap.neutral { color: var(--neutral); }

        /* Channel Mix Styles */
        .channel-mix-container {
            display: flex;
            gap: 24px;
            align-items: stretch;
        }

        .channel-mix-chart {
            flex: 1;
        }

        .channel-mix-legend {
            display: flex;
            flex-direction: column;
            gap: 12px;
            justify-content: center;
        }

        .channel-mix-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .channel-mix-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .channel-mix-dot.retail { background: var(--navy); }
        .channel-mix-dot.ecom { background: var(--steel-blue); }
        .channel-mix-dot.other { background: var(--light-steel); }

        @media (max-width: 1200px) {
            .segment-comparison-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Executive Summary Headline */
        .executive-headline {
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-dark) 100%);
            border-radius: 20px;
            padding: 28px 36px;
            margin-bottom: 32px;
            color: white;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-xl);
        }

        .executive-headline::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 300px;
            height: 100%;
            background: linear-gradient(90deg, transparent 0%, rgba(59, 130, 246, 0.2) 100%);
            pointer-events: none;
        }

        .executive-headline-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 1;
        }

        .executive-headline-main {
            flex: 1;
        }

        .executive-headline-title {
            font-size: var(--font-h2);
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .executive-headline-subtitle {
            font-size: var(--font-body);
            opacity: 0.85;
        }

        .executive-headline-kpis {
            display: flex;
            gap: 40px;
        }

        .headline-kpi {
            text-align: center;
        }

        .headline-kpi-value {
            font-size: var(--font-value-lg);
            font-weight: 800;
            margin-bottom: 4px;
        }

        .headline-kpi-label {
            font-size: var(--font-caption);
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .headline-kpi-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: var(--font-micro);
            font-weight: 600;
            margin-top: 6px;
        }

        .headline-kpi-badge.up {
            background: rgba(16, 185, 129, 0.3);
        }

        .headline-kpi-badge.down {
            background: rgba(239, 68, 68, 0.3);
        }

        /* Presentation Mode */
        .presentation-mode .header,
        .presentation-mode .nav-tabs,
        .presentation-mode .filter-row,
        .presentation-mode .filter-cascade {
            display: none !important;
        }

        .presentation-mode .main {
            padding-top: 40px;
        }

        .presentation-mode .metric-value,
        .presentation-mode .kpi-hero-value {
            font-size: calc(var(--font-display) * 1.3);
        }

        .presentation-mode .section-title {
            font-size: calc(var(--font-h2) * 1.2);
        }

        .presentation-mode .metric-card,
        .presentation-mode .share-tile,
        .presentation-mode .small-tile {
            transform: scale(1.02);
        }

        /* Presentation Toggle Button */
        .presentation-toggle {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-dark) 100%);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 50px;
            font-size: var(--font-body);
            font-weight: 600;
            cursor: pointer;
            box-shadow: var(--shadow-xl);
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all var(--transition-normal);
            z-index: 1000;
        }

        .presentation-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 40px rgba(27, 54, 93, 0.3);
        }

        .presentation-toggle svg {
            width: 20px;
            height: 20px;
        }

        /* Staggered Animation Classes */
        .stagger-1 { animation-delay: 50ms; }
        .stagger-2 { animation-delay: 100ms; }
        .stagger-3 { animation-delay: 150ms; }
        .stagger-4 { animation-delay: 200ms; }
        .stagger-5 { animation-delay: 250ms; }
        .stagger-6 { animation-delay: 300ms; }
        .stagger-7 { animation-delay: 350ms; }
        .stagger-8 { animation-delay: 400ms; }

        /* Chart Line Animation */
        .chart-line-animated {
            stroke-dasharray: 2000;
            stroke-dashoffset: 2000;
            animation: drawLine 1.5s ease forwards;
        }

        /* Progress Ring for Target Achievement */
        .progress-ring {
            transform: rotate(-90deg);
        }

        .progress-ring-circle {
            transition: stroke-dashoffset 0.8s ease;
        }

        /* Sparkline */
        .sparkline-container {
            margin-top: 12px;
            height: 30px;
            display: flex;
            align-items: flex-end;
            gap: 2px;
        }

        .sparkline-bar {
            flex: 1;
            background: linear-gradient(180deg, var(--steel-blue) 0%, var(--light-steel) 100%);
            border-radius: 2px 2px 0 0;
            min-height: 4px;
            transition: all var(--transition-fast);
        }

        .sparkline-bar:hover {
            background: var(--navy);
        }

        .sparkline-bar.negative {
            background: linear-gradient(180deg, var(--negative) 0%, var(--negative-light) 100%);
        }

        /* Data Timestamp */
        .data-timestamp {
            position: fixed;
            bottom: 24px;
            left: 24px;
            background: var(--white);
            padding: 10px 16px;
            border-radius: 20px;
            font-size: var(--font-caption);
            color: var(--text-muted);
            box-shadow: var(--shadow-md);
            z-index: 100;
        }

        .data-timestamp::before {
            content: 'ðŸ“Š';
            margin-right: 6px;
        }
    </style>
</head>
<body>
    <div id="app"></div>
    <div class="chart-tooltip" id="chartTooltip"></div>

    <script>
    (function() {
        const MONTHS = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
        // Support both "01 - Jan" and "01-Jan" formats, and also "Mon-YY" format
        const MONTH_MAP = {
            // Format: "01 - Jan"
            '01 - Jan':'JAN','02 - Feb':'FEB','03 - Mar':'MAR','04 - Apr':'APR','05 - May':'MAY','06 - Jun':'JUN',
            '07 - Jul':'JUL','08 - Aug':'AUG','09 - Sep':'SEP','10 - Oct':'OCT','11 - Nov':'NOV','12 - Dec':'DEC',
            // Format: "01-Jan"
            '01-Jan':'JAN','02-Feb':'FEB','03-Mar':'MAR','04-Apr':'APR','05-May':'MAY','06-Jun':'JUN',
            '07-Jul':'JUL','08-Aug':'AUG','09-Sep':'SEP','10-Oct':'OCT','11-Nov':'NOV','12-Dec':'DEC',
            // Format: "Mon-YY" (2024)
            'Jan-24':'JAN','Feb-24':'FEB','Mar-24':'MAR','Apr-24':'APR','May-24':'MAY','Jun-24':'JUN',
            'Jul-24':'JUL','Aug-24':'AUG','Sep-24':'SEP','Oct-24':'OCT','Nov-24':'NOV','Dec-24':'DEC',
            // Format: "Mon-YY" (2025)
            'Jan-25':'JAN','Feb-25':'FEB','Mar-25':'MAR','Apr-25':'APR','May-25':'MAY','Jun-25':'JUN',
            'Jul-25':'JUL','Aug-25':'AUG','Sep-25':'SEP','Oct-25':'OCT','Nov-25':'NOV','Dec-25':'DEC',
            // Short format: "Jan", "Feb", etc.
            'Jan':'JAN','Feb':'FEB','Mar':'MAR','Apr':'APR','May':'MAY','Jun':'JUN',
            'Jul':'JUL','Aug':'AUG','Sep':'SEP','Oct':'OCT','Nov':'NOV','Dec':'DEC',
            // Numeric format: "1", "2", etc.
            '1':'JAN','2':'FEB','3':'MAR','4':'APR','5':'MAY','6':'JUN',
            '7':'JUL','8':'AUG','9':'SEP','10':'OCT','11':'NOV','12':'DEC',
            // Standard abbreviation
            'JAN':'JAN','FEB':'FEB','MAR':'MAR','APR':'APR','MAY':'MAY','JUN':'JUN',
            'JUL':'JUL','AUG':'AUG','SEP':'SEP','OCT':'OCT','NOV':'NOV','DEC':'DEC'
        };

        // MUSE mode KPI configurations
        const MUSE_KPI_CONFIG = {
            'SLS_TTL': { name: 'Total Sales', format: 'currency', good: 'up', hasShare: true },
            'SLS_PEN': { name: 'Sales Penetration', format: 'percent', good: 'up', hasShare: false },
            'MBR_TTL': { name: 'Transacting Members', format: 'number', good: 'up', hasShare: true },
            'MBR_NEW': { name: 'New Members', format: 'number', good: 'up', hasShare: true },
            'MBR_RTN': { name: 'Returning Members', format: 'number', good: 'up', hasShare: true },
            'AVG_ATF': { name: 'Avg Frequency', format: 'decimal', good: 'up', hasShare: false },
            'AVG_AOV': { name: 'Avg Order Value', format: 'currency_small', good: 'up', hasShare: false },
            'PCT_RDM': { name: 'Redeeming Members %', format: 'percent', good: 'up', loyalty: true, hasShare: false },
            'PCT_XBP': { name: 'Cross Brand Plus %', format: 'percent', good: 'up', loyalty: true, hasShare: false },
            'PCT_NBA': { name: 'New Brand Adopters %', format: 'percent', good: 'up', loyalty: true, hasShare: false },
            'AVG_BRD': { name: 'Avg Brands Shopped', format: 'decimal', good: 'up', hasShare: false },
            'PTS_BRN': { name: 'Points Burned Value', format: 'currency', good: 'up', hasShare: true }
        };

        // MC mode KPI configurations
        const MC_KPI_CONFIG = {
            'TOTAL OWN BRAND SALES': { name: 'Total Own Brand Sales', format: 'currency', good: 'up', hasShare: true, hero: true },
            'KNOWN SALES': { name: 'Known Sales', format: 'currency', good: 'up', hasShare: true },
            'NEW CUSTOMERS KNOWN SALES': { name: 'New Customers Sales', format: 'currency', good: 'up', hasShare: true },
            'RETURNING CUSTOMERS KNOWN SALES': { name: 'Returning Customers Sales', format: 'currency', good: 'up', hasShare: true },
            'CUSTOMER COUNT': { name: 'Customer Count', format: 'number', good: 'up', hasShare: true, hero: true },
            'NEW CUSTOMER COUNT': { name: 'New Customers', format: 'number', good: 'up', hasShare: true, hero: true },
            'RETURNING CUSTOMER COUNT': { name: 'Returning Customers', format: 'number', good: 'up', hasShare: true },
            'TRANSACTION COUNT': { name: 'Transaction Count', format: 'number', good: 'up', hasShare: true },
            'NEW CUSTOMERS TRANSACTION COUNT': { name: 'New Customers Transactions', format: 'number', good: 'up', hasShare: true },
            'RETURNING CUSTOMERS TRANSACTION COUNT': { name: 'Returning Customers Transactions', format: 'number', good: 'up', hasShare: true },
            'AOV': { name: 'Avg Order Value', format: 'currency_small', good: 'up', hasShare: false, hero: true },
            'NEW CUSTOMERS AOV': { name: 'New Customers AOV', format: 'currency_small', good: 'up', hasShare: false },
            'RETURNING CUSTOMERS AOV': { name: 'Returning Customers AOV', format: 'currency_small', good: 'up', hasShare: false },
            'ACV': { name: 'Avg Customer Value', format: 'currency_small', good: 'up', hasShare: false },
            'NEW CUSTOMERS ACV': { name: 'New Customers ACV', format: 'currency_small', good: 'up', hasShare: false },
            'RETURNING CUSTOMERS ACV': { name: 'Returning Customers ACV', format: 'currency_small', good: 'up', hasShare: false },
            'AVERAGE FREQUENCY': { name: 'Avg Frequency', format: 'decimal', good: 'up', hasShare: false, hero: true },
            'NEW CUSTOMERS AVERAGE FREQUENCY': { name: 'New Customers Frequency', format: 'decimal', good: 'up', hasShare: false },
            'RETURNING CUSTOMERS AVERAGE FREQUENCY': { name: 'Returning Customers Frequency', format: 'decimal', good: 'up', hasShare: false },
            'UPT': { name: 'Units Per Transaction', format: 'decimal', good: 'up', hasShare: false },
            'NEW CUSTOMERS UPT': { name: 'New Customers UPT', format: 'decimal', good: 'up', hasShare: false },
            'RETURNING CUSTOMERS UPT': { name: 'Returning Customers UPT', format: 'decimal', good: 'up', hasShare: false },
            'SALES LINKAGE': { name: 'Sales Linkage', format: 'percent', good: 'up', hasShare: false, hero: true }
        };

        // KPI Groups for organized dropdown (MC mode)
        const MC_KPI_GROUPS = [
            { name: 'Sales', kpis: ['TOTAL OWN BRAND SALES', 'KNOWN SALES', 'NEW CUSTOMERS KNOWN SALES', 'RETURNING CUSTOMERS KNOWN SALES'] },
            { name: 'Customers', kpis: ['CUSTOMER COUNT', 'NEW CUSTOMER COUNT', 'RETURNING CUSTOMER COUNT'] },
            { name: 'Transactions', kpis: ['TRANSACTION COUNT', 'NEW CUSTOMERS TRANSACTION COUNT', 'RETURNING CUSTOMERS TRANSACTION COUNT'] },
            { name: 'Average Order Value', kpis: ['AOV', 'NEW CUSTOMERS AOV', 'RETURNING CUSTOMERS AOV'] },
            { name: 'Average Customer Value', kpis: ['ACV', 'NEW CUSTOMERS ACV', 'RETURNING CUSTOMERS ACV'] },
            { name: 'Frequency', kpis: ['AVERAGE FREQUENCY', 'NEW CUSTOMERS AVERAGE FREQUENCY', 'RETURNING CUSTOMERS AVERAGE FREQUENCY'] },
            { name: 'Units Per Transaction', kpis: ['UPT', 'NEW CUSTOMERS UPT', 'RETURNING CUSTOMERS UPT'] },
            { name: 'Other', kpis: ['SALES LINKAGE'] }
        ];

        // Helper to render KPI dropdown with optional grouping
        function renderKPIDropdown(kpis, selectedKPI, selectId = 'kpiSelect') {
            const kpiConfig = getKPIConfig();

            if (state.mode === 'MC') {
                // Grouped dropdown for MC mode
                return `<select class="filter-select" id="${selectId}">
                    ${MC_KPI_GROUPS.map(group => {
                        const groupKpis = group.kpis.filter(k => kpis.includes(k));
                        if (groupKpis.length === 0) return '';
                        return `<optgroup label="${group.name}">
                            ${groupKpis.map(k => `<option value="${k}" ${k === selectedKPI ? 'selected' : ''}>${kpiConfig[k]?.name || k}</option>`).join('')}
                        </optgroup>`;
                    }).join('')}
                </select>`;
            } else {
                // Flat dropdown for MUSE mode
                return `<select class="filter-select" id="${selectId}">
                    ${kpis.map(k => `<option value="${k}" ${k === selectedKPI ? 'selected' : ''}>${kpiConfig[k]?.name || k}</option>`).join('')}
                </select>`;
            }
        }

        // Get current KPI config based on mode
        function getKPIConfig() {
            return state.mode === 'MC' ? MC_KPI_CONFIG : MUSE_KPI_CONFIG;
        }

        // Map human-readable KPI names to internal keys (for MUSE mode CSV format)
        const MUSE_KPI_NAME_MAP = {
            'Total Sales': 'SLS_TTL',
            'Sales Penetration': 'SLS_PEN',
            'Transacting Members': 'MBR_TTL',
            'New Members': 'MBR_NEW',
            'Returning Members': 'MBR_RTN',
            'Avg Frequency': 'AVG_ATF',
            'Average Frequency': 'AVG_ATF',
            'Avg Order Value': 'AVG_AOV',
            'Average Order Value': 'AVG_AOV',
            'AOV': 'AVG_AOV',
            'Redeeming Members %': 'PCT_RDM',
            'Redeeming Members': 'PCT_RDM',
            'Cross Brand Plus %': 'PCT_XBP',
            'Cross Brand Plus': 'PCT_XBP',
            'New Brand Adopters %': 'PCT_NBA',
            'New Brand Adopters': 'PCT_NBA',
            'Avg Brands Shopped': 'AVG_BRD',
            'Average Brands Shopped': 'AVG_BRD',
            'Points Burned Value': 'PTS_BRN',
            'Points Burned': 'PTS_BRN'
        };

        // Preferred market order (for sorting), but list is dynamic
        const PREFERRED_MARKET_ORDER = ['All', 'All Markets', 'United Arab Emirates', 'Saudi Arabia', 'Kuwait', 'Bahrain', 'Qatar', 'Oman', 'Egypt', 'Jordan', 'Lebanon'];

        // Helper to check if a value is an aggregate/total
        function isAggregateValue(value, dimension) {
            // null means "use aggregate" in our state model
            if (value === null) return true;

            if (dimension === 'bu') {
                return value === 'MC' || value === 'All' || value === 'MUSE';
            }
            if (dimension === 'market') {
                return value === 'All' || value === 'All Markets';
            }
            if (dimension === 'channel') {
                return value === 'All' || value === 'All Channels';
            }
            return false;
        }

        // Get the aggregate/total value for a dimension from data
        function getAggregateValue(dimension) {
            const data = getData();
            if (!data) return 'All';

            if (dimension === 'bu') {
                const bus = [...new Set(data.map(d => d.BU))];
                // MC mode: "MC" is the total
                if (bus.includes('MC')) return 'MC';
                if (bus.includes('All')) return 'All';
                return bus[0];
            }
            if (dimension === 'market') {
                const markets = [...new Set(data.map(d => d.Market))];
                if (markets.includes('All')) return 'All';
                if (markets.includes('All Markets')) return 'All Markets';
                return markets[0];
            }
            if (dimension === 'channel') {
                const channels = [...new Set(data.map(d => d.Channel))];
                if (channels.includes('All')) return 'All';
                return channels[0] || 'All';
            }
            return 'All';
        }

        // Company Logo - Replace logo.png with your company logo
        const LOGO_SVG = `<img src="logo.png" alt="Company Logo" style="height: 60px; width: auto;" onerror="this.style.display='none'">`;

        // Year configuration - update these for different reporting periods
        const CURRENT_YEAR = 2025;
        const PREVIOUS_YEAR = 2024;

        let state = {
            mode: 'MUSE', // 'MUSE' or 'MC'
            museData: null,
            mcData: null,
            museFileName: null,
            mcFileName: null,
            selectedMarket: null,  // null = use aggregate
            selectedChannel: null, // null = use aggregate
            selectedKPI: null,
            activeTab: 'summary',
            dataLoaded: false
        };

        // Get current mode's data
        function getData() {
            return state.mode === 'MC' ? state.mcData : state.museData;
        }

        // Get available markets
        function getMarkets() {
            const data = getData();
            if (!data) return [];
            let filtered = data;
            // For MC mode, only consider rows with BU='MC' (the aggregate)
            if (state.mode === 'MC') {
                filtered = data.filter(d => d.BU === 'MC');
            }
            const markets = [...new Set(filtered.map(d => d.Market))].filter(m => m);

            // Sort: aggregates first, then by preferred order, then alphabetically
            return markets.sort((a, b) => {
                const aIsAgg = isAggregateValue(a, 'market');
                const bIsAgg = isAggregateValue(b, 'market');
                if (aIsAgg && !bIsAgg) return -1;
                if (!aIsAgg && bIsAgg) return 1;

                // Use preferred order if both are in it
                const aIdx = PREFERRED_MARKET_ORDER.indexOf(a);
                const bIdx = PREFERRED_MARKET_ORDER.indexOf(b);
                if (aIdx !== -1 && bIdx !== -1) return aIdx - bIdx;
                if (aIdx !== -1) return -1;
                if (bIdx !== -1) return 1;

                return a.localeCompare(b);
            });
        }

        // Get available channels for selected Market
        function getChannels() {
            const data = getData();
            if (!data) return [];
            let filtered = data;
            if (state.mode === 'MC') {
                // Always filter by BU='MC' (the aggregate)
                filtered = filtered.filter(d => d.BU === 'MC');
                // Only filter by market if a specific (non-aggregate) market is selected
                if (state.selectedMarket && !isAggregateValue(state.selectedMarket, 'market')) {
                    filtered = filtered.filter(d => d.Market === state.selectedMarket);
                }
            }
            const channels = [...new Set(filtered.map(d => d.Channel))].filter(c => c);
            // Sort with aggregate first, then alphabetically
            return channels.sort((a, b) => {
                const aIsAgg = isAggregateValue(a, 'channel');
                const bIsAgg = isAggregateValue(b, 'channel');
                if (aIsAgg && !bIsAgg) return -1;
                if (!aIsAgg && bIsAgg) return 1;
                return a.localeCompare(b);
            });
        }

        // Get KPIs available in current data
        function getKPIs() {
            const data = getData();
            const config = getKPIConfig();
            if (!data) return [];
            return [...new Set(data.map(d => d.Key))].filter(k => config[k]);
        }

        // Get data with current filters applied
        function getFilteredData() {
            const data = getData();
            if (!data) return [];
            let filtered = data;
            if (state.mode === 'MC') {
                // Always filter by BU='MC' (the aggregate)
                filtered = filtered.filter(d => d.BU === 'MC');
                // Filter by market if a specific market is selected (not null/aggregate)
                if (state.selectedMarket && !isAggregateValue(state.selectedMarket, 'market')) {
                    filtered = filtered.filter(d => d.Market === state.selectedMarket);
                }
                // Filter by channel if a specific channel is selected (not null/aggregate)
                if (state.selectedChannel && !isAggregateValue(state.selectedChannel, 'channel')) {
                    filtered = filtered.filter(d => d.Channel === state.selectedChannel);
                }
            }
            return filtered;
        }

        // Utility functions
        function formatValue(value, format) {
            if (value === null || value === undefined || isNaN(value)) return 'â€”';
            switch(format) {
                case 'currency':
                    if (value >= 1e9) return '$' + (value/1e9).toFixed(2) + 'B';
                    if (value >= 1e6) return '$' + (value/1e6).toFixed(1) + 'M';
                    if (value >= 1e3) return '$' + (value/1e3).toFixed(0) + 'K';
                    return '$' + value.toFixed(0);
                case 'currency_small':
                    return '$' + value.toFixed(0);
                case 'percent':
                    return (value * 100).toFixed(1) + '%';
                case 'number':
                    if (value >= 1e6) return (value/1e6).toFixed(2) + 'M';
                    if (value >= 1e3) return (value/1e3).toFixed(0) + 'K';
                    return value.toLocaleString();
                case 'decimal':
                    return value.toFixed(2);
                default:
                    return value.toString();
            }
        }

        function calcChange(current, previous, format) {
            if (!current || !previous || previous === 0) return null;
            if (format === 'percent') {
                const curr = parseFloat((current * 100).toFixed(1));
                const prev = parseFloat((previous * 100).toFixed(1));
                return curr - prev;
            }
            return ((current / previous) - 1) * 100;
        }

        function calcTargetGap(current, target, format) {
            if (!current || !target || target === 0) return null;
            if (format === 'percent') {
                const curr = parseFloat((current * 100).toFixed(1));
                const tgt = parseFloat((target * 100).toFixed(1));
                return curr - tgt;
            }
            return ((current / target) - 1) * 100;
        }

        function formatChange(change, format) {
            if (change === null) return 'â€”';
            const sign = change >= 0 ? '+' : '';
            if (format === 'percent') {
                return sign + change.toFixed(1) + ' PP';
            }
            return sign + change.toFixed(1) + '%';
        }

        // Get CSS class for change value
        // For percent format (PP): neutral if between -0.1 and +0.1 PP
        // For other formats (%): neutral if between -1% and +1%
        function getChangeClass(change, format) {
            if (change === null) return '';
            const threshold = format === 'percent' ? 0.1 : 1;
            if (Math.abs(change) < threshold) return 'neutral';
            return change >= 0 ? 'up' : 'down';
        }

        // Parse CSV text into data array
        function parseCSV(text, mode = 'MUSE') {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                if (values.length < 3) continue; // Skip empty lines
                const row = {};
                headers.forEach((h, idx) => {
                    let val = values[idx]?.trim();
                    if (['YTD', 'LYTD', 'R12M', 'LMR12M', 'Target'].includes(h)) {
                        row[h] = val === '' || val === undefined ? null : parseFloat(val);
                    } else if (h === 'KPI') {
                        // For MC mode, keep KPI name as-is; for MUSE, map to internal key
                        if (mode === 'MUSE') {
                            row['Key'] = MUSE_KPI_NAME_MAP[val] || val;
                        } else {
                            row['Key'] = val;
                        }
                    } else if (h === 'Key') {
                        row['Key'] = val;
                    } else if (h === 'Month') {
                        // Normalize month format
                        if (val && val.match(/^\d{2}-[A-Za-z]{3}$/)) {
                            val = val.replace('-', ' - ');
                        }
                        row[h] = val;
                    } else if (h === 'BU') {
                        row['BU'] = val || (mode === 'MUSE' ? 'MUSE' : 'All');
                    } else if (h === 'Channel') {
                        row['Channel'] = val || 'All';
                    } else {
                        row[h] = val;
                    }
                });

                // Ensure BU and Channel exist
                if (!row.BU) row.BU = mode === 'MUSE' ? 'MUSE' : 'All';
                if (!row.Channel) row.Channel = 'All';

                // Support both old format (Key) and new format (KPI mapped to Key)
                if (row.Market && row.Key) data.push(row);
            }
            return data;
        }

        // Parse Excel workbook with MUSE and MC sheets
        function parseExcel(workbook) {
            const result = { muse: null, mc: null };

            // Parse MUSE sheet
            if (workbook.SheetNames.includes('MUSE')) {
                const sheet = workbook.Sheets['MUSE'];
                const csv = XLSX.utils.sheet_to_csv(sheet);
                result.muse = parseCSV(csv, 'MUSE');
            }

            // Parse MC sheet
            if (workbook.SheetNames.includes('MC')) {
                const sheet = workbook.Sheets['MC'];
                const csv = XLSX.utils.sheet_to_csv(sheet);
                result.mc = parseCSV(csv, 'MC');
            }

            return result;
        }

        // Get latest data for a specific combination of filters
        // IMPORTANT: For MC mode, data is pre-aggregated. To get totals:
        // - Total overall: Market='All' AND Channel='All'
        // - Total for market: Market='UAE' AND Channel='All'
        // - Total for channel: Market='All' AND Channel='Retail'
        function getLatestData(market, kpiKey, channel = null) {
            const data = getData();
            if (!data) return null;

            let rows = data.filter(d => d.Market === market && d.Key === kpiKey);

            if (state.mode === 'MC') {
                // Always filter by BU='MC' (the aggregate)
                rows = rows.filter(d => d.BU === 'MC');

                // CRITICAL: Always explicitly filter by channel
                // If channel is specified, use it; otherwise use the aggregate channel
                const channelAgg = getAggregateValue('channel');
                const targetChannel = channel !== null ? channel : channelAgg;
                rows = rows.filter(d => d.Channel === targetChannel);
            }

            // Find December data or latest available
            const decRow = rows.find(d =>
                d.Month === '12 - Dec' ||
                d.Month === 'Dec-25' ||
                d.Month?.includes('Dec')
            );
            return decRow || rows[rows.length - 1];
        }

        // Get monthly data for charts
        function getMonthlyData(market, kpiKey, channel = null) {
            const data = getData();
            if (!data) return [];

            let rows = data.filter(d => d.Market === market && d.Key === kpiKey);

            if (state.mode === 'MC') {
                // Always filter by BU='MC' (the aggregate)
                rows = rows.filter(d => d.BU === 'MC');

                // CRITICAL: Always explicitly filter by channel
                const channelAgg = getAggregateValue('channel');
                const targetChannel = channel !== null ? channel : channelAgg;
                rows = rows.filter(d => d.Channel === targetChannel);
            }

            return rows.sort((a, b) => (a.Month || '').localeCompare(b.Month || ''));
        }

        // Get data for dimension analysis (Market, Channel)
        function getDimensionData(dimension, kpiKey) {
            const data = getData();
            const config = getKPIConfig();
            if (!data || !config[kpiKey]) return [];

            let items = [];

            if (dimension === 'market') {
                items = getMarkets();
            } else if (dimension === 'channel') {
                items = getChannels();
            }

            const marketAgg = getAggregateValue('market');
            const channelAgg = getAggregateValue('channel');

            return items.map(item => {
                const latest = getLatestData(
                    dimension === 'market' ? item : (isAggregateValue(state.selectedMarket, 'market') ? marketAgg : state.selectedMarket),
                    kpiKey,
                    dimension === 'channel' ? item : (isAggregateValue(state.selectedChannel, 'channel') ? channelAgg : state.selectedChannel)
                );
                return {
                    name: item,
                    data: latest,
                    isTotal: isAggregateValue(item, dimension)
                };
            }).filter(d => d.data);
        }

        // Generate insights without suggestions
        function generateInsights() {
            const insights = [];
            const market = getAggregateValue('market');

            const sales = getLatestData(market, 'SLS_TTL');
            if (sales) {
                const change = calcChange(sales.YTD, sales.LYTD, 'currency');
                if (change > 0) {
                    insights.push({
                        icon: 'ðŸ“ˆ', color: 'green',
                        text: `<strong>Revenue grew ${change.toFixed(1)}%</strong> YoY to ${formatValue(sales.YTD, 'currency')}, demonstrating strong commercial performance`
                    });
                }
            }

            const aov = getLatestData(market, 'AVG_AOV');
            if (aov) {
                const change = calcChange(aov.YTD, aov.LYTD, 'currency');
                if (change > 0) {
                    insights.push({
                        icon: 'ðŸ’°', color: 'green',
                        text: `<strong>Average basket size increased ${change.toFixed(1)}%</strong> to ${formatValue(aov.YTD, 'currency_small')}, indicating higher customer value per visit`
                    });
                }
            }

            const members = getLatestData(market, 'MBR_TTL');
            if (members) {
                const change = calcChange(members.YTD, members.LYTD, 'number');
                if (change > 0) {
                    insights.push({
                        icon: 'ðŸ‘¥', color: 'green',
                        text: `<strong>Member base expanded ${change.toFixed(1)}%</strong> to ${formatValue(members.YTD, 'number')}, showing continued program growth`
                    });
                }
            }

            const nba = getLatestData(market, 'PCT_NBA');
            if (nba) {
                const change = calcChange(nba.YTD, nba.LYTD, 'percent');
                if (change < 0) {
                    insights.push({
                        icon: 'ðŸŽ¯', color: 'amber',
                        text: `<strong>Brand discovery opportunity:</strong> New Brand Adopters at ${formatValue(nba.YTD, 'percent')} (${formatChange(change, 'percent')} vs LY)`
                    });
                }
            }

            const xbp = getLatestData(market, 'PCT_XBP');
            if (xbp) {
                const change = calcChange(xbp.YTD, xbp.LYTD, 'percent');
                if (change < 0) {
                    insights.push({
                        icon: 'ðŸ”„', color: 'amber',
                        text: `<strong>Cross-brand engagement:</strong> Multi-brand shoppers at ${formatValue(xbp.YTD, 'percent')} (${formatChange(change, 'percent')} vs LY)`
                    });
                }
            }

            const rdm = getLatestData(market, 'PCT_RDM');
            if (rdm) {
                const change = calcChange(rdm.YTD, rdm.LYTD, 'percent');
                if (change < 0) {
                    insights.push({
                        icon: 'ðŸŽ', color: 'amber',
                        text: `<strong>Redemption activation:</strong> Point usage at ${formatValue(rdm.YTD, 'percent')} (${formatChange(change, 'percent')} vs LY)`
                    });
                }
            }

            return insights.slice(0, 6);
        }

        function render() {
            const app = document.getElementById('app');
            if (!state.dataLoaded) {
                app.innerHTML = renderUpload();
            } else {
                app.innerHTML = renderDashboard();
            }
            attachEvents();
        }

        function renderUpload() {
            const museFileName = state.museFileName || '';
            const mcFileName = state.mcFileName || '';
            const hasAnyFile = museFileName || mcFileName;

            return `
                <div class="upload-overlay">
                    <div class="upload-box">
                        <div class="upload-logo">${LOGO_SVG}</div>
                        <h2>${CURRENT_YEAR} Performance Review</h2>
                        <p>Upload CSV files for each mode</p>

                        <div class="csv-upload-grid">
                            <div class="csv-upload-card">
                                <div class="csv-upload-header">
                                    <span class="csv-upload-icon">ðŸ’Ž</span>
                                    <span class="csv-upload-title">MUSE Data</span>
                                </div>
                                <div class="csv-upload-zone" id="museDropzone">
                                    <input type="file" id="museFileInput" accept=".csv" style="display:none">
                                    ${museFileName
                                        ? `<div class="csv-file-selected">âœ“ ${museFileName}</div>`
                                        : '<p class="csv-upload-text">Click or drop CSV</p>'}
                                </div>
                            </div>
                            <div class="csv-upload-card">
                                <div class="csv-upload-header">
                                    <span class="csv-upload-icon">ðŸ“Š</span>
                                    <span class="csv-upload-title">MC Data</span>
                                </div>
                                <div class="csv-upload-zone" id="mcDropzone">
                                    <input type="file" id="mcFileInput" accept=".csv" style="display:none">
                                    ${mcFileName
                                        ? `<div class="csv-file-selected">âœ“ ${mcFileName}</div>`
                                        : '<p class="csv-upload-text">Click or drop CSV</p>'}
                                </div>
                            </div>
                        </div>

                        <p class="upload-hint">Upload at least one CSV file to continue</p>

                        <div class="upload-actions">
                            <button class="btn-primary" id="startBtn" ${hasAnyFile ? '' : 'disabled'}>
                                Start Dashboard
                            </button>
                        </div>
                        <button class="demo-btn-small" id="demoBtn">Demo</button>
                    </div>
                </div>
            `;
        }

        function renderDashboard() {
            const hasBothModes = state.museData && state.mcData;
            const modeLabel = state.mode === 'MC' ? 'Managed Companies' : 'MUSE Loyalty';

            // Different tabs for MC mode
            const mcTabs = `
                <div class="nav-tab ${state.activeTab === 'summary' ? 'active' : ''}" data-tab="summary">Executive Summary</div>
                <div class="nav-tab ${state.activeTab === 'segmentation' ? 'active' : ''}" data-tab="segmentation">Customer Segments</div>
                <div class="nav-tab ${state.activeTab === 'markets' ? 'active' : ''}" data-tab="markets">Market Analysis</div>
                <div class="nav-tab ${state.activeTab === 'channel' ? 'active' : ''}" data-tab="channel">Channel Analysis</div>
                <div class="nav-tab ${state.activeTab === 'kpi' ? 'active' : ''}" data-tab="kpi">KPI Deep Dive</div>
            `;

            const museTabs = `
                <div class="nav-tab ${state.activeTab === 'summary' ? 'active' : ''}" data-tab="summary">Executive Summary</div>
                <div class="nav-tab ${state.activeTab === 'markets' ? 'active' : ''}" data-tab="markets">Market Analysis</div>
                <div class="nav-tab ${state.activeTab === 'kpi' ? 'active' : ''}" data-tab="kpi">KPI Deep Dive</div>
            `;

            return `
                <header class="header">
                    <div class="header-left">
                        <div class="logo-container">${LOGO_SVG}</div>
                        <div class="header-text">
                            <h1>${CURRENT_YEAR} Performance Review</h1>
                            <p>Year-over-Year Analysis | ${modeLabel} Dashboard</p>
                        </div>
                    </div>
                    ${hasBothModes ? `
                    <div class="header-mode-switcher">
                        <div class="mode-toggle">
                            <button class="mode-toggle-btn ${state.mode === 'MUSE' ? 'active' : ''}" data-mode="MUSE">MUSE</button>
                            <button class="mode-toggle-btn ${state.mode === 'MC' ? 'active' : ''}" data-mode="MC">MC</button>
                        </div>
                    </div>
                    ` : `<span class="header-badge">${state.mode} Mode</span>`}
                </header>
                <nav class="nav-tabs">
                    ${state.mode === 'MC' ? mcTabs : museTabs}
                </nav>
                <main class="main">
                    ${state.activeTab === 'summary' ? renderSummaryTab() : ''}
                    ${state.activeTab === 'segmentation' && state.mode === 'MC' ? renderSegmentationTab() : ''}
                    ${state.activeTab === 'markets' ? renderMarketsTab() : ''}
                    ${state.activeTab === 'channel' && state.mode === 'MC' ? renderChannelTab() : ''}
                    ${state.activeTab === 'kpi' ? renderKPITab() : ''}
                </main>
            `;
        }

        function renderSummaryTab() {
            if (state.mode === 'MC') {
                return renderMCSummaryTab();
            }
            return renderMUSESummaryTab();
        }

        // Executive Summary Headline - Shows key metrics at a glance
        function renderExecutiveHeadline(mode = 'MUSE') {
            const market = getAggregateValue('market');
            const config = getKPIConfig();

            let salesData, membersData, aovData;
            let salesKey, membersKey, aovKey;

            if (mode === 'MUSE') {
                salesKey = 'SLS_TTL';
                membersKey = 'MBR_TTL';
                aovKey = 'AVG_AOV';
            } else {
                salesKey = 'TOTAL OWN BRAND SALES';
                membersKey = 'CUSTOMER COUNT';
                aovKey = 'AOV';
            }

            salesData = getLatestData(market, salesKey, mode === 'MC' ? getAggregateValue('channel') : null);
            membersData = getLatestData(market, membersKey, mode === 'MC' ? getAggregateValue('channel') : null);
            aovData = getLatestData(market, aovKey, mode === 'MC' ? getAggregateValue('channel') : null);

            if (!salesData) return '';

            const salesChange = calcChange(salesData.YTD, salesData.LYTD, config[salesKey]?.format);
            const salesTargetGap = salesData.Target ? calcTargetGap(salesData.YTD, salesData.Target, config[salesKey]?.format) : null;
            const membersChange = membersData ? calcChange(membersData.YTD, membersData.LYTD, config[membersKey]?.format) : 0;
            const aovChange = aovData ? calcChange(aovData.YTD, aovData.LYTD, config[aovKey]?.format) : 0;

            const overallStatus = salesChange >= 0 && (salesTargetGap === null || salesTargetGap >= 0) ? 'positive' : 'attention';
            const statusIcon = overallStatus === 'positive' ? 'ðŸ“ˆ' : 'ðŸ“Š';
            const statusText = overallStatus === 'positive'
                ? `Strong performance with ${formatChange(salesChange, config[salesKey]?.format)} growth vs LY`
                : `Revenue ${salesChange >= 0 ? 'growing' : 'declining'} ${formatChange(Math.abs(salesChange), config[salesKey]?.format)} vs LY`;

            return `
                <div class="executive-headline animate-fade-in-up">
                    <div class="executive-headline-content">
                        <div class="executive-headline-main">
                            <div class="executive-headline-title">
                                ${statusIcon} ${CURRENT_YEAR} Performance Summary
                            </div>
                            <div class="executive-headline-subtitle">
                                ${statusText}${salesTargetGap !== null ? ` | Target: ${salesTargetGap >= 0 ? 'Exceeded' : 'Gap'} ${formatChange(salesTargetGap, config[salesKey]?.format)}` : ''}
                            </div>
                        </div>
                        <div class="executive-headline-kpis">
                            <div class="headline-kpi">
                                <div class="headline-kpi-value">${formatValue(salesData.YTD, config[salesKey]?.format)}</div>
                                <div class="headline-kpi-label">${mode === 'MUSE' ? 'Revenue' : 'Sales'}</div>
                                <div class="headline-kpi-badge ${salesChange >= 0 ? 'up' : 'down'}">${formatChange(salesChange, config[salesKey]?.format)} vs LY</div>
                            </div>
                            ${membersData ? `
                            <div class="headline-kpi">
                                <div class="headline-kpi-value">${formatValue(membersData.YTD, config[membersKey]?.format)}</div>
                                <div class="headline-kpi-label">${mode === 'MUSE' ? 'Members' : 'Customers'}</div>
                                <div class="headline-kpi-badge ${membersChange >= 0 ? 'up' : 'down'}">${formatChange(membersChange, config[membersKey]?.format)} vs LY</div>
                            </div>
                            ` : ''}
                            ${aovData ? `
                            <div class="headline-kpi">
                                <div class="headline-kpi-value">${formatValue(aovData.YTD, config[aovKey]?.format)}</div>
                                <div class="headline-kpi-label">AOV</div>
                                <div class="headline-kpi-badge ${aovChange >= 0 ? 'up' : 'down'}">${formatChange(aovChange, config[aovKey]?.format)} vs LY</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMUSESummaryTab() {
            const market = getAggregateValue('market');
            const allKPIs = ['SLS_TTL', 'MBR_TTL', 'AVG_AOV', 'AVG_ATF', 'SLS_PEN', 'PCT_NBA', 'PCT_XBP', 'PCT_RDM'];
            const insights = generateInsights();

            return `
                ${renderExecutiveHeadline('MUSE')}
                <div class="section-header">
                    <div>
                        <div class="section-title">Key Performance Indicators</div>
                        <div class="section-subtitle">Full Year ${CURRENT_YEAR} vs ${PREVIOUS_YEAR} | ${market}</div>
                    </div>
                </div>
                <div class="exec-summary">
                    ${allKPIs.map((key, i) => `<div class="animate-fade-in-up stagger-${i + 1}">${renderMetricCard(market, key)}</div>`).join('')}
                </div>

                <div class="insights-panel" id="insightsPanel">
                    <div class="insights-header" onclick="toggleInsightsPanel()">
                        <div class="insights-title">Key Insights</div>
                        <button class="insights-toggle" aria-label="Toggle insights">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="4 6 8 10 12 6"></polyline>
                            </svg>
                        </button>
                    </div>
                    <div class="insights-content">
                        <div class="insights-grid">
                            ${insights.map(i => `
                                <div class="insight-item">
                                    <div class="insight-icon ${i.color}">${i.icon}</div>
                                    <div class="insight-text">${i.text}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>

                ${renderMarketSummaryTable()}
            `;
        }

        function renderMCSummaryTab() {
            // 2+3+4 KPI layout:
            // Top row: 2 main KPIs (full width)
            const topRowKPIs = ['TOTAL OWN BRAND SALES', 'SALES LINKAGE'];
            // Middle row: 3 KPIs with new/returning share split
            const shareRowKPIs = [
                { base: 'CUSTOMER COUNT', new: 'NEW CUSTOMER COUNT', returning: 'RETURNING CUSTOMER COUNT' },
                { base: 'TRANSACTION COUNT', new: 'NEW CUSTOMERS TRANSACTION COUNT', returning: 'RETURNING CUSTOMERS TRANSACTION COUNT' },
                { base: 'KNOWN SALES', new: 'NEW CUSTOMERS KNOWN SALES', returning: 'RETURNING CUSTOMERS KNOWN SALES' }
            ];
            // Bottom row: 4 smaller metric tiles
            const bottomRowKPIs = ['AOV', 'AVERAGE FREQUENCY', 'ACV', 'UPT'];
            // Comparison tables - 4 KPIs
            const comparisonKPIs = ['TOTAL OWN BRAND SALES', 'CUSTOMER COUNT', 'AOV', 'SALES LINKAGE'];

            const marketAgg = getAggregateValue('market');
            const channelAgg = getAggregateValue('channel');

            // Use selected values for filtering, fallback to aggregate
            const selectedMarket = state.selectedMarket || marketAgg;
            const selectedChannel = state.selectedChannel || channelAgg;

            const marketLabel = isAggregateValue(selectedMarket, 'market') ? marketAgg : selectedMarket;
            const channelLabel = isAggregateValue(selectedChannel, 'channel') ? channelAgg : selectedChannel;

            return `
                ${renderExecutiveHeadline('MC')}
                <div class="section-header">
                    <div>
                        <div class="section-title">Key Performance Indicators</div>
                        <div class="section-subtitle">Full Year ${CURRENT_YEAR} vs ${PREVIOUS_YEAR} | ${marketLabel} | ${channelLabel}</div>
                    </div>
                </div>

                ${renderMCFilters()}

                <!-- Top Row: 2 Main KPIs (Full Width) -->
                <div class="kpi-row-2">
                    ${topRowKPIs.map((key, i) => `<div class="animate-fade-in-up stagger-${i + 1}">${renderMetricCard(selectedMarket, key, selectedChannel)}</div>`).join('')}
                </div>

                <!-- Middle Row: 3 KPIs with New/Returning Share Split -->
                <div class="kpi-row-3">
                    ${shareRowKPIs.map(kpi => renderShareTile(selectedMarket, kpi.base, kpi.new, kpi.returning, selectedChannel)).join('')}
                </div>

                <!-- Bottom Row: 4 Smaller Tiles -->
                <div class="kpi-row-4">
                    ${bottomRowKPIs.map(key => renderSmallTile(selectedMarket, key, selectedChannel)).join('')}
                </div>

                <!-- Market & Channel Comparison Tables (stacked) -->
                <div class="comparison-stack" style="margin-top: 32px;">
                    ${renderDimensionComparisonTable('market', 'Market Comparison', comparisonKPIs)}
                    ${renderDimensionComparisonTable('channel', 'Channel Comparison', comparisonKPIs)}
                </div>
            `;
        }

        // Render cascade filters for MC mode (Market -> Channel)
        function renderMCFilters() {
            const markets = getMarkets();
            const channels = getChannels();

            return `
                <div class="filter-row filter-cascade" style="margin-bottom: 24px;">
                    <div class="filter-group">
                        <label>Market</label>
                        <select class="filter-select" id="marketFilter">
                            ${markets.map(m => `<option value="${m}" ${(state.selectedMarket === null ? isAggregateValue(m, 'market') : m === state.selectedMarket) ? 'selected' : ''}>${m}</option>`).join('')}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Channel</label>
                        <select class="filter-select" id="channelFilter">
                            ${channels.map(c => `<option value="${c}" ${(state.selectedChannel === null ? isAggregateValue(c, 'channel') : c === state.selectedChannel) ? 'selected' : ''}>${c}</option>`).join('')}
                        </select>
                    </div>
                </div>
            `;
        }

        // Render comparison table for a dimension (market, channel)
        // For market comparison: Show each market with Channel='All' (market totals)
        // For channel comparison: Show each channel for the SELECTED market (or all markets if none selected)
        function renderDimensionComparisonTable(dimension, title, kpis) {
            const config = getKPIConfig();
            const items = dimension === 'market' ? getMarkets() : getChannels();

            // Filter to show only available KPIs
            const availableKPIs = kpis.filter(k => config[k]);
            if (availableKPIs.length === 0) return '';

            const marketAgg = getAggregateValue('market');
            const channelAgg = getAggregateValue('channel');

            // For channel comparison, use selected market (so user sees channel breakdown for their selected market)
            const selectedMarket = state.selectedMarket || marketAgg;

            // Get data for each item
            const itemsData = items.map(item => {
                const kpiData = {};
                availableKPIs.forEach(kpi => {
                    kpiData[kpi] = getLatestData(
                        // Market comparison: use each market with Channel='All'
                        // Channel comparison: use selected market (or all) with each channel
                        dimension === 'market' ? item : selectedMarket,
                        kpi,
                        dimension === 'channel' ? item : channelAgg
                    );
                });
                return { name: item, kpiData, isTotal: isAggregateValue(item, dimension) };
            }).filter(d => Object.values(d.kpiData).some(v => v));

            // Separate total row
            const totalItem = itemsData.find(d => d.isTotal);
            const otherItems = itemsData.filter(d => !d.isTotal)
                .sort((a, b) => {
                    const aVal = a.kpiData[availableKPIs[0]]?.YTD || 0;
                    const bVal = b.kpiData[availableKPIs[0]]?.YTD || 0;
                    return bVal - aVal;
                });

            function renderRow(item, isTotal = false) {
                return `
                    <tr class="${isTotal ? 'total-row' : ''}">
                        <td class="market-cell">${item.name}</td>
                        ${availableKPIs.map(kpi => {
                            const kpiConfig = config[kpi];
                            const data = item.kpiData[kpi];
                            if (!data) return '<td class="compare-cell">â€”</td>';

                            const change = calcChange(data.YTD, data.LYTD, kpiConfig.format);
                            const changeClass = getChangeClass(change, kpiConfig.format);

                            let targetPart = '';
                            if (data.Target) {
                                const tGap = calcTargetGap(data.YTD, data.Target, kpiConfig.format);
                                const tGapClass = getChangeClass(tGap, kpiConfig.format);
                                targetPart = `<span class="cell-divider">|</span><span class="cell-compare-label">TGT:</span> <span class="cell-compare-value ${tGapClass}">${formatChange(tGap, kpiConfig.format)}</span>`;
                            }

                            return `
                                <td class="compare-cell">
                                    <div class="value-cell">${formatValue(data.YTD, kpiConfig.format)}</div>
                                    <div class="cell-compare-inline">
                                        <span class="cell-compare-label">LY:</span> <span class="cell-compare-value ${changeClass}">${formatChange(change, kpiConfig.format)}</span>
                                        ${targetPart}
                                    </div>
                                </td>
                            `;
                        }).join('')}
                    </tr>
                `;
            }

            return `
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">${title}</div>
                    </div>
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>${dimension === 'market' ? 'Market' : 'Channel'}</th>
                                ${availableKPIs.map(k => `<th class="center">${config[k]?.name || k}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${otherItems.map(item => renderRow(item, false)).join('')}
                            ${totalItem ? renderRow(totalItem, true) : ''}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Channel Analysis Tab
        function renderChannelTab() {
            const kpis = getKPIs();
            const markets = getMarkets();
            const channels = getChannels();
            const defaultKPI = kpis.includes('TOTAL OWN BRAND SALES') ? 'TOTAL OWN BRAND SALES' : kpis[0];

            return `
                <div class="section-header">
                    <div>
                        <div class="section-title">Channel Analysis</div>
                        <div class="section-subtitle">Performance breakdown by sales channel</div>
                    </div>
                </div>

                <div class="filter-row" style="margin-bottom: 24px;">
                    <div class="filter-group">
                        <label>Market</label>
                        <select class="filter-select" id="marketFilter">
                            ${markets.map(m => `<option value="${m}" ${(state.selectedMarket === null ? isAggregateValue(m, 'market') : m === state.selectedMarket) ? 'selected' : ''}>${m}</option>`).join('')}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Channel</label>
                        <select class="filter-select" id="channelFilter">
                            ${channels.map(c => `<option value="${c}" ${(state.selectedChannel === null ? isAggregateValue(c, 'channel') : c === state.selectedChannel) ? 'selected' : ''}>${c}</option>`).join('')}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>KPI Metric</label>
                        ${renderKPIDropdown(kpis, defaultKPI, 'channelKpiSelect')}
                    </div>
                </div>
                <div id="channelAnalysisContent">
                    ${renderDimensionAnalysis('channel', defaultKPI)}
                </div>
            `;
        }

        // Customer Segmentation Tab - New vs Returning analysis (table format)
        function renderSegmentationTab() {
            // Top 3 KPI groups with visual split bars (additive KPIs)
            const primaryKPIs = [
                { base: 'CUSTOMER COUNT', new: 'NEW CUSTOMER COUNT', returning: 'RETURNING CUSTOMER COUNT', label: 'Customers' },
                { base: 'TRANSACTION COUNT', new: 'NEW CUSTOMERS TRANSACTION COUNT', returning: 'RETURNING CUSTOMERS TRANSACTION COUNT', label: 'Transactions' },
                { base: 'KNOWN SALES', new: 'NEW CUSTOMERS KNOWN SALES', returning: 'RETURNING CUSTOMERS KNOWN SALES', label: 'Known Sales' }
            ];

            // Secondary KPIs (non-additive, show comparison only)
            const secondaryKPIs = [
                { base: 'AOV', new: 'NEW CUSTOMERS AOV', returning: 'RETURNING CUSTOMERS AOV', label: 'Avg Order Value' },
                { base: 'ACV', new: 'NEW CUSTOMERS ACV', returning: 'RETURNING CUSTOMERS ACV', label: 'Avg Customer Value' },
                { base: 'AVERAGE FREQUENCY', new: 'NEW CUSTOMERS AVERAGE FREQUENCY', returning: 'RETURNING CUSTOMERS AVERAGE FREQUENCY', label: 'Frequency' }
            ];

            const marketAgg = getAggregateValue('market');
            const channelAgg = getAggregateValue('channel');
            const config = getKPIConfig();

            // Use selected values for filtering
            const selectedMarket = state.selectedMarket || marketAgg;
            const selectedChannel = state.selectedChannel || channelAgg;

            // Get data for a KPI
            function getSegmentData(kpiKey) {
                const kpiConfig = config[kpiKey];
                if (!kpiConfig) return null;
                const data = getLatestData(selectedMarket, kpiKey, selectedChannel);
                if (!data) return null;
                const change = calcChange(data.YTD, data.LYTD, kpiConfig.format);
                const targetGap = data.Target ? calcTargetGap(data.YTD, data.Target, kpiConfig.format) : null;
                return { data, change, targetGap, format: kpiConfig.format, config: kpiConfig };
            }

            // Render a visual card for primary KPIs with split bar
            function renderVisualCard(g) {
                const totalData = getSegmentData(g.base);
                const newData = getSegmentData(g.new);
                const returningData = getSegmentData(g.returning);

                if (!totalData) return '';

                const totalValue = totalData.data.YTD || 1;
                const newShare = newData ? (newData.data.YTD / totalValue) * 100 : 0;
                const returnShare = returningData ? (returningData.data.YTD / totalValue) * 100 : 0;

                const totalChangeClass = getChangeClass(totalData.change, totalData.format);
                const newChangeClass = newData ? getChangeClass(newData.change, newData.format) : '';
                const returnChangeClass = returningData ? getChangeClass(returningData.change, returningData.format) : '';
                const targetGapClass = totalData.targetGap !== null ? getChangeClass(totalData.targetGap, totalData.format) : '';

                return `
                    <div class="segment-visual-card">
                        <div class="segment-visual-header">
                            <div class="segment-visual-title">${g.label}</div>
                            <div class="segment-visual-total">
                                <div class="segment-visual-value">${formatValue(totalData.data.YTD, totalData.format)}</div>
                                ${totalData.data.Target ? `
                                    <div class="segment-visual-target">
                                        Target: ${formatValue(totalData.data.Target, totalData.format)}
                                        <span class="segment-visual-target-badge ${targetGapClass}">${formatChange(totalData.targetGap, totalData.format)}</span>
                                    </div>
                                ` : ''}
                                <div class="segment-visual-change">
                                    <span class="${totalChangeClass}">${formatChange(totalData.change, totalData.format)}</span>
                                    <span style="color: var(--text-muted);">vs LY</span>
                                </div>
                            </div>
                        </div>

                        <div class="segment-split-bar">
                            <div class="segment-split-new" style="width: ${newShare}%;">
                                ${newShare >= 15 ? newShare.toFixed(0) + '%' : ''}
                            </div>
                            <div class="segment-split-returning" style="width: ${returnShare}%;">
                                ${returnShare >= 15 ? returnShare.toFixed(0) + '%' : ''}
                            </div>
                        </div>

                        <div class="segment-split-details">
                            <div class="segment-split-section new">
                                <div class="segment-split-section-label">New Customers</div>
                                <div>
                                    <span class="segment-split-section-value">${newData ? formatValue(newData.data.YTD, newData.format) : 'â€”'}</span>
                                    <span class="segment-split-section-share">(${newShare.toFixed(0)}%)</span>
                                </div>
                                ${newData ? `<div class="segment-split-section-change ${newChangeClass}">${formatChange(newData.change, newData.format)} vs LY</div>` : ''}
                            </div>
                            <div class="segment-split-section returning">
                                <div class="segment-split-section-label">Returning</div>
                                <div>
                                    <span class="segment-split-section-value">${returningData ? formatValue(returningData.data.YTD, returningData.format) : 'â€”'}</span>
                                    <span class="segment-split-section-share">(${returnShare.toFixed(0)}%)</span>
                                </div>
                                ${returningData ? `<div class="segment-split-section-change ${returnChangeClass}">${formatChange(returningData.change, returningData.format)} vs LY</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }

            // Render secondary comparison table
            function renderSecondaryTable() {
                const rows = secondaryKPIs.map(g => {
                    const totalData = getSegmentData(g.base);
                    const newData = getSegmentData(g.new);
                    const returningData = getSegmentData(g.returning);

                    if (!totalData) return '';

                    return `
                        <tr>
                            <td class="market-cell">${g.label}</td>
                            <td class="compare-cell">
                                <div class="value-cell">${formatValue(totalData.data.YTD, totalData.format)}</div>
                                <div class="cell-compare-inline">
                                    <span class="cell-compare-label">LY:</span>
                                    <span class="cell-compare-value ${getChangeClass(totalData.change, totalData.format)}">${formatChange(totalData.change, totalData.format)}</span>
                                </div>
                            </td>
                            <td class="compare-cell">
                                ${newData ? `
                                    <div class="value-cell">${formatValue(newData.data.YTD, newData.format)}</div>
                                    <div class="cell-compare-inline">
                                        <span class="cell-compare-label">LY:</span>
                                        <span class="cell-compare-value ${getChangeClass(newData.change, newData.format)}">${formatChange(newData.change, newData.format)}</span>
                                    </div>
                                ` : 'â€”'}
                            </td>
                            <td class="compare-cell">
                                ${returningData ? `
                                    <div class="value-cell">${formatValue(returningData.data.YTD, returningData.format)}</div>
                                    <div class="cell-compare-inline">
                                        <span class="cell-compare-label">LY:</span>
                                        <span class="cell-compare-value ${getChangeClass(returningData.change, returningData.format)}">${formatChange(returningData.change, returningData.format)}</span>
                                    </div>
                                ` : 'â€”'}
                            </td>
                        </tr>
                    `;
                }).join('');

                return `
                    <div class="chart-container" style="margin-top: 24px;">
                        <table class="modern-table">
                            <thead>
                                <tr>
                                    <th class="left">Metric</th>
                                    <th class="center">Total</th>
                                    <th class="center" style="background: var(--positive);">New</th>
                                    <th class="center" style="background: var(--steel-blue);">Returning</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rows}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            return `
                <div class="section-header">
                    <div>
                        <div class="section-title">Customer Segment Analysis</div>
                        <div class="section-subtitle">New vs Returning Customer Performance Breakdown</div>
                    </div>
                </div>

                ${renderMCFilters()}

                <div class="segment-visual-grid">
                    ${primaryKPIs.map(g => renderVisualCard(g)).join('')}
                </div>

                ${renderSecondaryTable()}
            `;
        }

        // Target Scorecard with traffic lights - shows all KPIs with NA for missing targets
        function renderTargetScorecard() {
            const marketAgg = getAggregateValue('market');
            const channelAgg = getAggregateValue('channel');
            const config = getKPIConfig();

            // Use selected values for filtering
            const selectedMarket = state.selectedMarket || marketAgg;
            const selectedChannel = state.selectedChannel || channelAgg;

            // Use hero KPIs for scorecard (10 items = 5x2 grid)
            const scorecardKPIs = ['TOTAL OWN BRAND SALES', 'CUSTOMER COUNT', 'AOV', 'AVERAGE FREQUENCY', 'SALES LINKAGE',
                                   'NEW CUSTOMER COUNT', 'RETURNING CUSTOMER COUNT', 'TRANSACTION COUNT', 'UPT', 'ACV'];

            function getIndicator(gap, format, hasTarget) {
                if (!hasTarget) return { class: 'neutral', icon: 'â€”' };
                const threshold = format === 'percent' ? 0.5 : 2;
                if (gap >= 0) return { class: 'green', icon: 'âœ“' };
                if (gap >= -threshold) return { class: 'amber', icon: '~' };
                return { class: 'red', icon: 'âœ—' };
            }

            const items = scorecardKPIs.map(k => {
                const kpiConfig = config[k];
                if (!kpiConfig) return null;
                const data = getLatestData(selectedMarket, k, selectedChannel);
                if (!data) return null;

                const hasTarget = data.Target != null;
                const gap = hasTarget ? calcTargetGap(data.YTD, data.Target, kpiConfig.format) : null;
                const indicator = getIndicator(gap, kpiConfig.format, hasTarget);

                return {
                    name: kpiConfig.name,
                    value: formatValue(data.YTD, kpiConfig.format),
                    target: hasTarget ? formatValue(data.Target, kpiConfig.format) : 'NA',
                    gap,
                    gapFormatted: hasTarget ? formatChange(gap, kpiConfig.format) : 'NA',
                    gapClass: hasTarget ? getChangeClass(gap, kpiConfig.format) : '',
                    indicator,
                    hasTarget
                };
            }).filter(Boolean);

            if (items.length === 0) return '';

            return `
                <div class="chart-container" style="margin-top: 24px;">
                    <div class="chart-header">
                        <div class="chart-title">Target Achievement Scorecard</div>
                    </div>
                    <div class="scorecard-grid">
                        ${items.map(item => `
                            <div class="scorecard-item">
                                <div class="scorecard-indicator ${item.indicator.class}">${item.indicator.icon}</div>
                                <div class="scorecard-details">
                                    <div class="scorecard-kpi">${item.name}</div>
                                    <div class="scorecard-value">${item.value}</div>
                                    <div class="scorecard-gap ${item.gapClass}">vs Target: ${item.gapFormatted}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Channel Mix Analysis - shows channel breakdown for selected market
        function renderChannelMix() {
            const channels = getChannels();
            const channelAgg = getAggregateValue('channel');
            const nonAggChannels = channels.filter(c => !isAggregateValue(c, 'channel'));

            if (nonAggChannels.length === 0) return '';

            const config = getKPIConfig();
            const kpiKey = 'TOTAL OWN BRAND SALES';
            const kpiConfig = config[kpiKey];
            if (!kpiConfig) return '';

            const marketAgg = getAggregateValue('market');
            // Use selected market - show channel mix FOR that market
            const selectedMarket = state.selectedMarket || marketAgg;

            // Get total for the selected market (with Channel='All')
            const totalData = getLatestData(selectedMarket, kpiKey, channelAgg);
            const totalYTD = totalData?.YTD || 1;
            const totalLYTD = totalData?.LYTD || 1;

            // Get each channel's data for the selected market
            const channelData = nonAggChannels.map(ch => {
                const data = getLatestData(selectedMarket, kpiKey, ch);
                if (!data) return null;
                const shareYTD = (data.YTD / totalYTD) * 100;
                const shareLYTD = data.LYTD ? (data.LYTD / totalLYTD) * 100 : 0;
                const shift = shareYTD - shareLYTD;
                return { channel: ch, value: data.YTD, shareYTD, shareLYTD, shift };
            }).filter(Boolean).sort((a, b) => b.shareYTD - a.shareYTD);

            if (channelData.length === 0) return '';

            return `
                <div class="chart-container" style="margin-top: 24px;">
                    <div class="chart-header">
                        <div class="chart-title">Channel Mix Analysis</div>
                    </div>
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>Channel</th>
                                <th class="center">${CURRENT_YEAR} Share</th>
                                <th class="center">${PREVIOUS_YEAR} Share</th>
                                <th class="center">Shift</th>
                                <th class="center">Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${channelData.map(item => `
                                <tr>
                                    <td class="market-cell">${item.channel}</td>
                                    <td class="value-cell">${item.shareYTD.toFixed(1)}%</td>
                                    <td class="compare-cell">${item.shareLYTD.toFixed(1)}%</td>
                                    <td class="compare-cell">
                                        <span class="${item.shift >= 0 ? 'up' : 'down'}">${item.shift >= 0 ? '+' : ''}${item.shift.toFixed(1)} PP</span>
                                    </td>
                                    <td class="value-cell">${formatValue(item.value, kpiConfig.format)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Render dimension analysis (similar to market analysis)
        // For market analysis: Show each market, respecting selected channel filter
        // For channel analysis: Show each channel for the SELECTED market
        function renderDimensionAnalysis(dimension, kpiKey) {
            const config = getKPIConfig();
            const kpiConfig = config[kpiKey];
            if (!kpiConfig) return '<p>No data available</p>';

            const items = dimension === 'market' ? getMarkets() : getChannels();

            const hasShare = kpiConfig.hasShare === true;
            const marketAgg = getAggregateValue('market');
            const channelAgg = getAggregateValue('channel');

            // Respect user's filter selections
            const selectedMarket = state.selectedMarket || marketAgg;
            const selectedChannel = state.selectedChannel || channelAgg;

            // Get data for all items
            const allData = items.map(item => {
                const data = getLatestData(
                    // Market analysis: use each market with selected channel
                    // Channel analysis: use selected market with each channel
                    dimension === 'market' ? item : selectedMarket,
                    kpiKey,
                    dimension === 'channel' ? item : selectedChannel
                );
                return { name: item, data, isTotal: isAggregateValue(item, dimension) };
            }).filter(d => d.data);

            const totalData = allData.find(d => d.isTotal);
            const totalValue = totalData?.data?.YTD || 0;

            const itemData = allData.filter(d => !d.isTotal)
                .sort((a, b) => (b.data?.YTD || 0) - (a.data?.YTD || 0));

            const maxShare = Math.max(...itemData.map(d => totalValue > 0 ? (d.data.YTD / totalValue) * 100 : 0));

            function renderShareCell(value, isTotal = false) {
                if (!hasShare) {
                    return '<td class="compare-cell"><span class="cell-na">NA</span></td>';
                }
                if (isTotal) {
                    return '<td class="compare-cell"><span style="font-weight:600;color:var(--navy)">100%</span></td>';
                }
                const share = totalValue > 0 ? (value / totalValue) * 100 : 0;
                const barWidth = maxShare > 0 ? (share / maxShare) * 100 : 0;
                return `
                    <td class="compare-cell">
                        <div class="share-cell">
                            <span class="share-value">${share.toFixed(0)}%</span>
                            <div class="share-bar-bg">
                                <div class="share-bar" style="width: ${barWidth}%"></div>
                            </div>
                        </div>
                    </td>
                `;
            }

            // Helper to render target cell (always show column, NA if no target)
            function renderTargetCell(data) {
                if (data.Target) {
                    const tGap = calcTargetGap(data.YTD, data.Target, kpiConfig.format);
                    const tGapClass = getChangeClass(tGap, kpiConfig.format);
                    return `
                        <td class="compare-cell">
                            <div class="compare-group">
                                <span class="compare-value">${formatValue(data.Target, kpiConfig.format)}</span>
                                <span class="compare-badge ${tGapClass}">${formatChange(tGap, kpiConfig.format)}</span>
                            </div>
                        </td>
                    `;
                }
                return '<td class="compare-cell"><span class="cell-na">NA</span></td>';
            }

            const dimensionLabel = dimension === 'market' ? 'Market' : 'Channel';

            return `
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">${kpiConfig?.name || kpiKey} by ${dimensionLabel}</div>
                    </div>
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>${dimensionLabel}</th>
                                <th class="center">${CURRENT_YEAR}</th>
                                <th class="center">${PREVIOUS_YEAR}</th>
                                <th class="center">Target</th>
                                <th class="center">Share</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemData.map(({name, data}) => {
                                const change = calcChange(data.YTD, data.LYTD, kpiConfig.format);
                                const changeClass = getChangeClass(change, kpiConfig.format);

                                return `
                                    <tr>
                                        <td class="market-cell">${name}</td>
                                        <td class="value-cell">${formatValue(data.YTD, kpiConfig.format)}</td>
                                        <td class="compare-cell">
                                            <div class="compare-group">
                                                <span class="compare-value">${formatValue(data.LYTD, kpiConfig.format)}</span>
                                                <span class="compare-badge ${changeClass}">${formatChange(change, kpiConfig.format)}</span>
                                            </div>
                                        </td>
                                        ${renderTargetCell(data)}
                                        ${renderShareCell(data.YTD)}
                                    </tr>
                                `;
                            }).join('')}
                            ${totalData ? `
                                <tr class="total-row">
                                    <td class="market-cell">${totalData.name}</td>
                                    <td class="value-cell">${formatValue(totalData.data.YTD, kpiConfig.format)}</td>
                                    <td class="compare-cell">
                                        <div class="compare-group">
                                            <span class="compare-value">${formatValue(totalData.data.LYTD, kpiConfig.format)}</span>
                                            <span class="compare-badge ${getChangeClass(calcChange(totalData.data.YTD, totalData.data.LYTD, kpiConfig.format), kpiConfig.format)}">${formatChange(calcChange(totalData.data.YTD, totalData.data.LYTD, kpiConfig.format), kpiConfig.format)}</span>
                                        </div>
                                    </td>
                                    ${renderTargetCell(totalData.data)}
                                    ${renderShareCell(totalData.data.YTD, true)}
                                </tr>
                            ` : ''}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Icons for metrics (both MUSE and MC modes)
        const METRIC_ICONS = {
            // MUSE mode icons
            'SLS_TTL': '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>',
            'MBR_TTL': '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
            'AVG_AOV': '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>',
            'AVG_ATF': '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
            'SLS_PEN': '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>',
            'PCT_NBA': '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>',
            'PCT_XBP': '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>',
            'PCT_RDM': '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 12v10H4V12"/><path d="M2 7h20v5H2z"/><path d="M12 22V7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/></svg>',
            // MC mode icons
            'TOTAL OWN BRAND SALES': '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>',
            'KNOWN SALES': '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>',
            'CUSTOMER COUNT': '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
            'NEW CUSTOMER COUNT': '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>',
            'RETURNING CUSTOMER COUNT': '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><polyline points="23 6 23 1 18 1"/><path d="M16 8l7-7"/></svg>',
            'AOV': '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>',
            'ACV': '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>',
            'AVERAGE FREQUENCY': '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
            'SALES LINKAGE': '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>',
            'UPT': '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>',
            'TRANSACTION COUNT': '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>'
        };

        // Share Tile - shows total with new/returning split below
        function renderShareTile(market, baseKpi, newKpi, returningKpi, channel = null) {
            const config = getKPIConfig();
            const baseConfig = config[baseKpi];
            if (!baseConfig) return '';

            const baseData = getLatestData(market, baseKpi, channel);
            const newData = getLatestData(market, newKpi, channel);
            const returningData = getLatestData(market, returningKpi, channel);

            if (!baseData) return '';

            const baseChange = calcChange(baseData.YTD, baseData.LYTD, baseConfig.format);
            const baseChangeClass = getChangeClass(baseChange, baseConfig.format);
            const targetGap = baseData.Target ? calcTargetGap(baseData.YTD, baseData.Target, baseConfig.format) : null;
            const targetGapClass = targetGap !== null ? getChangeClass(targetGap, baseConfig.format) : '';

            // Calculate shares
            const totalValue = baseData.YTD || 1;
            const newShare = newData ? (newData.YTD / totalValue) * 100 : 0;
            const returningShare = returningData ? (returningData.YTD / totalValue) * 100 : 0;

            // New customer change
            const newConfig = config[newKpi];
            const newChange = newData && newConfig ? calcChange(newData.YTD, newData.LYTD, newConfig.format) : null;
            const newChangeClass = newChange !== null ? getChangeClass(newChange, newConfig?.format) : '';

            // Returning customer change
            const retConfig = config[returningKpi];
            const retChange = returningData && retConfig ? calcChange(returningData.YTD, returningData.LYTD, retConfig.format) : null;
            const retChangeClass = retChange !== null ? getChangeClass(retChange, retConfig?.format) : '';

            // Arrow SVGs
            const arrowUp = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 15l-6-6-6 6"/></svg>';
            const arrowDown = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M6 9l6 6 6-6"/></svg>';
            const arrowNeutral = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14"/></svg>';
            const vsArrow = baseChangeClass === 'up' ? arrowUp : (baseChangeClass === 'down' ? arrowDown : arrowNeutral);

            // Target row
            let targetRow = '';
            if (baseData.Target) {
                targetRow = `
                    <div class="metric-target-row">
                        <div class="metric-target-left">
                            <span>Target:</span>
                            <span class="metric-target-val">${formatValue(baseData.Target, baseConfig.format)}</span>
                        </div>
                        <span class="metric-target-badge ${targetGapClass}">${formatChange(targetGap, baseConfig.format)}</span>
                    </div>
                `;
            }

            // Arrows for new/returning
            const newArrow = newChangeClass === 'up' ? arrowUp : (newChangeClass === 'down' ? arrowDown : arrowNeutral);
            const retArrow = retChangeClass === 'up' ? arrowUp : (retChangeClass === 'down' ? arrowDown : arrowNeutral);

            return `
                <div class="share-tile">
                    <div class="share-tile-header">
                        <div class="share-tile-icon">${METRIC_ICONS[baseKpi] || ''}</div>
                        <div class="share-tile-label">${baseConfig.name}</div>
                    </div>
                    <div class="metric-value">${formatValue(baseData.YTD, baseConfig.format)}</div>
                    ${targetRow}
                    <div class="metric-vs-row">
                        <span class="metric-vs-arrow ${baseChangeClass}">
                            ${vsArrow}
                            ${formatChange(baseChange, baseConfig.format)}
                        </span>
                        <span>vs LY</span>
                    </div>
                    <div class="share-tile-split" style="margin-top: 16px;">
                        <div class="share-split-item">
                            <span class="share-split-label">New Customers</span>
                            <div class="share-split-row">
                                <span class="share-split-value">${newData ? formatValue(newData.YTD, newConfig?.format || 'number') : 'â€”'}</span>
                                <span class="share-split-pct" title="Share">(${newShare.toFixed(0)}%)</span>
                            </div>
                            ${newChange !== null ? `
                                <div class="share-split-vs">
                                    <span class="share-split-arrow ${newChangeClass}">${newArrow}</span>
                                    <span class="share-split-change ${newChangeClass}">${formatChange(newChange, newConfig?.format)}</span>
                                    <span class="share-split-vs-label">vs LY</span>
                                </div>
                            ` : ''}
                        </div>
                        <div class="share-split-item">
                            <span class="share-split-label">Returning</span>
                            <div class="share-split-row">
                                <span class="share-split-value">${returningData ? formatValue(returningData.YTD, retConfig?.format || 'number') : 'â€”'}</span>
                                <span class="share-split-pct" title="Share">(${returningShare.toFixed(0)}%)</span>
                            </div>
                            ${retChange !== null ? `
                                <div class="share-split-vs">
                                    <span class="share-split-arrow ${retChangeClass}">${retArrow}</span>
                                    <span class="share-split-change ${retChangeClass}">${formatChange(retChange, retConfig?.format)}</span>
                                    <span class="share-split-vs-label">vs LY</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // Small Tile - compact version for bottom row with target support
        function renderSmallTile(market, kpiKey, channel = null) {
            const config = getKPIConfig()[kpiKey];
            const data = getLatestData(market, kpiKey, channel);
            if (!data || !config) return '';

            const changeVsLY = calcChange(data.YTD, data.LYTD, config.format);
            const changeClass = getChangeClass(changeVsLY, config.format);
            const targetGap = data.Target ? calcTargetGap(data.YTD, data.Target, config.format) : null;
            const targetGapClass = targetGap !== null ? getChangeClass(targetGap, config.format) : '';

            // Arrow SVGs
            const arrowUp = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 15l-6-6-6 6"/></svg>';
            const arrowDown = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M6 9l6 6 6-6"/></svg>';
            const arrowNeutral = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14"/></svg>';
            const vsArrow = changeClass === 'up' ? arrowUp : (changeClass === 'down' ? arrowDown : arrowNeutral);

            // Target row for small tiles
            let targetRow = '';
            if (data.Target) {
                targetRow = `
                    <div class="small-tile-target">
                        <span>Target: ${formatValue(data.Target, config.format)}</span>
                        <span class="small-tile-target-badge ${targetGapClass}">${formatChange(targetGap, config.format)}</span>
                    </div>
                `;
            }

            return `
                <div class="small-tile">
                    <div class="small-tile-header">
                        <div class="small-tile-icon">${METRIC_ICONS[kpiKey] || ''}</div>
                        <div class="small-tile-label">${config.name}</div>
                    </div>
                    <div class="small-tile-value">${formatValue(data.YTD, config.format)}</div>
                    ${targetRow}
                    <div class="small-tile-footer">
                        <span class="small-tile-arrow ${changeClass}">${vsArrow}</span>
                        <span class="small-tile-change ${changeClass}">${formatChange(changeVsLY, config.format)}</span>
                        <span class="small-tile-label-vs">vs LY</span>
                    </div>
                </div>
            `;
        }

        function renderMetricCard(market, kpiKey, channel = null) {
            const config = getKPIConfig()[kpiKey];
            const data = getLatestData(market, kpiKey, channel);
            if (!data || !config) return '';

            const changeVsLY = calcChange(data.YTD, data.LYTD, config.format);
            const targetGap = data.Target ? calcTargetGap(data.YTD, data.Target, config.format) : null;

            // Arrow SVGs
            const arrowUp = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 15l-6-6-6 6"/></svg>';
            const arrowDown = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M6 9l6 6 6-6"/></svg>';
            const arrowNeutral = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14"/></svg>';

            // Target row - primary comparison (highlighted)
            let targetRow = '';
            if (data.Target) {
                const gapClass = getChangeClass(targetGap, config.format);
                targetRow = `
                    <div class="metric-target-row">
                        <div class="metric-target-left">
                            <span>Target:</span>
                            <span class="metric-target-val">${formatValue(data.Target, config.format)}</span>
                        </div>
                        <span class="metric-target-badge ${gapClass}">${formatChange(targetGap, config.format)}</span>
                    </div>
                `;
            }

            // vs LY - subtle with arrow
            const vsLYClass = getChangeClass(changeVsLY, config.format);
            const vsArrow = vsLYClass === 'up' ? arrowUp : (vsLYClass === 'down' ? arrowDown : arrowNeutral);
            const vsRow = `
                <div class="metric-vs-row">
                    <span class="metric-vs-arrow ${vsLYClass}">
                        ${vsArrow}
                        ${formatChange(changeVsLY, config.format)}
                    </span>
                    <span>vs LY</span>
                </div>
            `;

            return `
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-icon">${METRIC_ICONS[kpiKey] || ''}</div>
                        <div class="metric-label">${config.name}</div>
                    </div>
                    <div class="metric-value">${formatValue(data.YTD, config.format)}</div>
                    ${targetRow}
                    ${vsRow}
                </div>
            `;
        }

        function renderLoyaltyCard(market, kpiKey) {
            // Use same design as metric cards
            return renderMetricCard(market, kpiKey);
        }

        function renderMarketSummaryTable() {
            const markets = getMarkets();
            const kpiConfig = getKPIConfig();
            const kpis = ['SLS_TTL', 'PCT_NBA', 'PCT_XBP', 'PCT_RDM'];

            // Separate individual markets from aggregate, sort by Total Sales value
            const individualMarkets = markets.filter(m => !isAggregateValue(m, 'market'))
                .map(m => ({ market: m, data: getLatestData(m, 'SLS_TTL') }))
                .sort((a, b) => (b.data?.YTD || 0) - (a.data?.YTD || 0))
                .map(d => d.market);
            const totalMarket = markets.find(m => isAggregateValue(m, 'market'));

            // Helper to render a market row
            function renderMarketRow(m, isTotal = false) {
                return `
                    <tr class="${isTotal ? 'total-row' : ''}">
                        <td class="market-cell">${m}</td>
                        ${kpis.map(k => {
                            const config = kpiConfig[k];
                            const data = getLatestData(m, k);
                            if (!data) return '<td class="compare-cell">â€”</td>';
                            const change = calcChange(data.YTD, data.LYTD, config.format);
                            const changeClass = getChangeClass(change, config.format);

                            let targetPart = '';
                            if (data.Target) {
                                const tGap = calcTargetGap(data.YTD, data.Target, config.format);
                                const tGapClass = getChangeClass(tGap, config.format);
                                targetPart = `<span class="cell-divider">|</span><span class="cell-compare-label">TGT:</span> <span class="cell-compare-value ${tGapClass}">${formatChange(tGap, config.format)}</span>`;
                            }

                            return `
                                <td class="compare-cell">
                                    <div class="value-cell">${formatValue(data.YTD, config.format)}</div>
                                    <div class="cell-compare-inline">
                                        <span class="cell-compare-label">LY:</span> <span class="cell-compare-value ${changeClass}">${formatChange(change, config.format)}</span>
                                        ${targetPart}
                                    </div>
                                </td>
                            `;
                        }).join('')}
                    </tr>
                `;
            }

            return `
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">Market Comparison</div>
                    </div>
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>Market</th>
                                ${kpis.map(k => `<th class="center">${kpiConfig[k]?.name || k}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${individualMarkets.map(m => renderMarketRow(m, false)).join('')}
                            ${totalMarket ? renderMarketRow(totalMarket, true) : ''}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderMarketsTab() {
            const kpis = getKPIs();
            const config = getKPIConfig();
            const markets = getMarkets();
            const channels = getChannels();
            const defaultKPI = state.mode === 'MC'
                ? (kpis.includes('TOTAL OWN BRAND SALES') ? 'TOTAL OWN BRAND SALES' : kpis[0])
                : (kpis.includes('SLS_TTL') ? 'SLS_TTL' : kpis[0]);

            const mcFilters = state.mode === 'MC' ? `
                <div class="filter-group">
                    <label>Market</label>
                    <select class="filter-select" id="marketFilter">
                        ${markets.map(m => `<option value="${m}" ${(state.selectedMarket === null ? isAggregateValue(m, 'market') : m === state.selectedMarket) ? 'selected' : ''}>${m}</option>`).join('')}
                    </select>
                </div>
                <div class="filter-group">
                    <label>Channel</label>
                    <select class="filter-select" id="channelFilter">
                        ${channels.map(c => `<option value="${c}" ${(state.selectedChannel === null ? isAggregateValue(c, 'channel') : c === state.selectedChannel) ? 'selected' : ''}>${c}</option>`).join('')}
                    </select>
                </div>
            ` : '';

            return `
                <div class="section-header">
                    <div>
                        <div class="section-title">Market Analysis</div>
                        <div class="section-subtitle">Performance breakdown by market region</div>
                    </div>
                </div>

                <div class="filter-row" style="margin-bottom: 24px;">
                    ${mcFilters}
                    <div class="filter-group">
                        <label>KPI Metric</label>
                        ${renderKPIDropdown(kpis, defaultKPI, 'marketKpiSelect')}
                    </div>
                </div>
                <div id="marketComparisonContent">
                    ${renderMarketAnalysis(defaultKPI)}
                </div>
            `;
        }

        function renderMarketAnalysis(kpiKey) {
            const config = getKPIConfig()[kpiKey];
            if (!config) return '<p>No data available</p>';

            const markets = getMarkets();
            const hasShare = config.hasShare === true;

            // For MC mode, respect channel selection
            const channelAgg = getAggregateValue('channel');
            const selectedChannel = state.selectedChannel || channelAgg;

            // Use helper to get market aggregate
            const totalMarketName = getAggregateValue('market');
            const totalData = getLatestData(totalMarketName, kpiKey, selectedChannel);
            const totalValue = totalData?.YTD || 0;

            const allMarketData = markets.map(m => {
                const data = getLatestData(m, kpiKey, selectedChannel);
                return { market: m, data, isTotal: isAggregateValue(m, 'market') };
            }).filter(d => d.data);

            // Non-total markets sorted by value
            const marketData = allMarketData.filter(d => !d.isTotal).sort((a, b) => (b.data?.YTD || 0) - (a.data?.YTD || 0));
            const totalRow = allMarketData.find(d => d.isTotal);

            // Calculate share percentages
            const maxShare = Math.max(...marketData.map(d => totalValue > 0 ? (d.data.YTD / totalValue) * 100 : 0));

            // Helper to render share cell with bar
            function renderShareCell(value, isTotal = false) {
                if (!hasShare) {
                    return '<td class="compare-cell"><span class="cell-na">NA</span></td>';
                }
                if (isTotal) {
                    return '<td class="compare-cell"><span style="font-weight:600;color:var(--navy)">100%</span></td>';
                }
                const share = totalValue > 0 ? (value / totalValue) * 100 : 0;
                const barWidth = maxShare > 0 ? (share / maxShare) * 100 : 0;
                return `
                    <td class="compare-cell">
                        <div class="share-cell">
                            <span class="share-value">${share.toFixed(0)}%</span>
                            <div class="share-bar-bg">
                                <div class="share-bar" style="width: ${barWidth}%"></div>
                            </div>
                        </div>
                    </td>
                `;
            }

            // Helper to render target cell (always show column, NA if no target)
            function renderTargetCell(data) {
                if (data.Target) {
                    const tGap = calcTargetGap(data.YTD, data.Target, config.format);
                    const tGapClass = getChangeClass(tGap, config.format);
                    return `
                        <td class="compare-cell">
                            <div class="compare-group">
                                <span class="compare-value">${formatValue(data.Target, config.format)}</span>
                                <span class="compare-badge ${tGapClass}">${formatChange(tGap, config.format)}</span>
                            </div>
                        </td>
                    `;
                }
                return '<td class="compare-cell"><span class="cell-na">NA</span></td>';
            }

            return `
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">${config?.name || kpiKey} by Market</div>
                    </div>
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>Market</th>
                                <th class="center">${CURRENT_YEAR}</th>
                                <th class="center">${PREVIOUS_YEAR}</th>
                                <th class="center">Target</th>
                                <th class="center">Share</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${marketData.map(({market, data}) => {
                                const change = calcChange(data.YTD, data.LYTD, config.format);
                                const changeClass = getChangeClass(change, config.format);

                                return `
                                    <tr>
                                        <td class="market-cell">${market}</td>
                                        <td class="value-cell">${formatValue(data.YTD, config.format)}</td>
                                        <td class="compare-cell">
                                            <div class="compare-group">
                                                <span class="compare-value">${formatValue(data.LYTD, config.format)}</span>
                                                <span class="compare-badge ${changeClass}">${formatChange(change, config.format)}</span>
                                            </div>
                                        </td>
                                        ${renderTargetCell(data)}
                                        ${renderShareCell(data.YTD)}
                                    </tr>
                                `;
                            }).join('')}
                            ${totalRow ? `
                                <tr class="total-row">
                                    <td class="market-cell">${totalRow.market}</td>
                                    <td class="value-cell">${formatValue(totalRow.data.YTD, config.format)}</td>
                                    <td class="compare-cell">
                                        <div class="compare-group">
                                            <span class="compare-value">${formatValue(totalRow.data.LYTD, config.format)}</span>
                                            <span class="compare-badge ${getChangeClass(calcChange(totalRow.data.YTD, totalRow.data.LYTD, config.format), config.format)}">${formatChange(calcChange(totalRow.data.YTD, totalRow.data.LYTD, config.format), config.format)}</span>
                                        </div>
                                    </td>
                                    ${renderTargetCell(totalRow.data)}
                                    ${renderShareCell(totalRow.data.YTD, true)}
                                    </tr>
                                ` : ''}
                            </tbody>
                        </table>
                </div>
            `;
        }

        function renderKPITab() {
            const kpis = getKPIs();
            const kpiConfig = getKPIConfig();
            const markets = getMarkets();
            const channels = getChannels();

            const defaultKPI = state.mode === 'MC'
                ? (kpis.includes('TOTAL OWN BRAND SALES') ? 'TOTAL OWN BRAND SALES' : kpis[0])
                : (kpis.includes('SLS_TTL') ? 'SLS_TTL' : kpis[0]);
            const defaultMarket = getAggregateValue('market');

            const selectedKPI = state.selectedKPI || defaultKPI;
            const selectedMarket = state.selectedMarket || defaultMarket;

            const channelFilter = state.mode === 'MC' ? `
                <div class="filter-group">
                    <label>Channel</label>
                    <select class="filter-select" id="kpiChannelSelect">
                        ${channels.map(c => `<option value="${c}" ${(state.selectedChannel === null ? isAggregateValue(c, 'channel') : c === state.selectedChannel) ? 'selected' : ''}>${c}</option>`).join('')}
                    </select>
                </div>
            ` : '';

            return `
                <div class="section-header">
                    <div>
                        <div class="section-title">KPI Deep Dive</div>
                        <div class="section-subtitle">Detailed monthly trend analysis and performance tracking</div>
                    </div>
                </div>
                <div class="filter-row">
                    <div class="filter-group">
                        <label>Market</label>
                        <select class="filter-select" id="kpiMarketSelect">
                            ${markets.map(m => `<option value="${m}" ${m === selectedMarket ? 'selected' : ''}>${m}</option>`).join('')}
                        </select>
                    </div>
                    ${channelFilter}
                    <div class="filter-group">
                        <label>KPI Metric</label>
                        ${renderKPIDropdown(kpis, selectedKPI, 'kpiSelect')}
                    </div>
                </div>
                <div id="kpiDetailContent">
                    ${renderKPIDetail(selectedMarket, selectedKPI, state.selectedChannel)}
                </div>
            `;
        }

        // Render breakdown card for market or channel
        function renderBreakdownCard(dimension, selectedValue, kpiKey, config, otherDimValue, totalValue) {
            const isAggregate = isAggregateValue(selectedValue, dimension);
            const items = dimension === 'market' ? getMarkets() : getChannels();
            const channelAgg = getAggregateValue('channel');
            const marketAgg = getAggregateValue('market');

            if (isAggregate) {
                // Show breakdown by dimension
                const breakdown = items
                    .filter(item => !isAggregateValue(item, dimension))
                    .map(item => {
                        const data = dimension === 'market'
                            ? getLatestData(item, kpiKey, otherDimValue || channelAgg)
                            : getLatestData(otherDimValue || marketAgg, kpiKey, item);
                        return { name: item, value: data?.YTD || 0 };
                    })
                    .sort((a, b) => b.value - a.value);

                const maxValue = breakdown[0]?.value || 1;
                const title = dimension === 'market' ? 'By Market' : 'By Channel';

                return `
                    <div class="market-breakdown-card">
                        <div class="market-breakdown-title">${title}</div>
                        <div class="market-breakdown-list">
                            ${breakdown.map((item, i) => {
                                const share = totalValue > 0 ? ((item.value / totalValue) * 100).toFixed(0) : 0;
                                const barWidth = (item.value / maxValue) * 100;
                                return `
                                    <div class="market-breakdown-item">
                                        <div class="market-breakdown-header">
                                            <span class="market-breakdown-name">${item.name}</span>
                                            <span class="market-breakdown-value">${formatValue(item.value, config.format)} (${share}%)</span>
                                        </div>
                                        <div class="market-breakdown-bar-bg">
                                            <div class="market-breakdown-bar bar-${i + 1}" style="width: ${barWidth}%"></div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            } else {
                // Single selection - just show the name as a simple card
                const label = dimension === 'market' ? 'Market' : 'Channel';
                return `
                    <div class="market-breakdown-card">
                        <div class="market-breakdown-title">${label}</div>
                        <div class="breakdown-single-value">${selectedValue}</div>
                    </div>
                `;
            }
        }

        function renderKPIDetail(market, kpiKey, channel = null) {
            const config = getKPIConfig()[kpiKey];
            const monthlyData = getMonthlyData(market, kpiKey, channel);
            const latestData = getLatestData(market, kpiKey, channel);

            if (!config || monthlyData.length === 0) {
                return '<p>No data available for selection</p>';
            }

            // Calculate changes
            const ytdVsLytd = calcChange(latestData?.YTD, latestData?.LYTD, config.format);
            const r12mVsLr12m = calcChange(latestData?.R12M, latestData?.LMR12M, config.format);
            const ytdVsTarget = latestData?.Target ? calcTargetGap(latestData.YTD, latestData.Target, config.format) : null;

            // Prepare chart data
            const chartData = MONTHS.map(month => {
                const row = monthlyData.find(d => MONTH_MAP[d.Month] === month);
                return {
                    month,
                    ytd: row?.YTD ?? null,
                    lytd: row?.LYTD ?? null,
                    target: row?.Target ?? null
                };
            });

            // SVG Chart
            const width = 900, height = 390;
            const marginLeft = 70, marginRight = 30, marginTop = 20, marginBottom = 40;
            const chartWidth = width - marginLeft - marginRight;
            const chartHeight = height - marginTop - marginBottom;

            const allVals = chartData.flatMap(d => [d.ytd, d.lytd, d.target]).filter(v => v !== null && !isNaN(v));

            // Handle empty data gracefully
            if (allVals.length === 0) {
                return '<div class="chart-container"><p style="text-align:center; padding:40px; color:var(--text-muted);">No chart data available for this selection</p></div>';
            }

            const minVal = Math.min(...allVals) * 0.9;
            const maxVal = Math.max(...allVals) * 1.1;

            // Prevent division by zero if all values are the same
            const valueRange = maxVal - minVal || 1;

            const xScale = i => marginLeft + (i * chartWidth / 11);
            const yScale = v => marginTop + chartHeight - ((v - minVal) / valueRange) * chartHeight;

            let pathYTD = '', pathLYTD = '', pathTarget = '';
            let dotsYTD = '', dotsLYTD = '';
            let fillAreas = '';

            // Build fill areas between current and previous year lines
            for (let i = 0; i < chartData.length - 1; i++) {
                const d1 = chartData[i];
                const d2 = chartData[i + 1];
                if (d1.ytd !== null && d1.lytd !== null && d2.ytd !== null && d2.lytd !== null) {
                    const x1 = xScale(i);
                    const x2 = xScale(i + 1);
                    const y1_ytd = yScale(d1.ytd);
                    const y1_lytd = yScale(d1.lytd);
                    const y2_ytd = yScale(d2.ytd);
                    const y2_lytd = yScale(d2.lytd);

                    // Determine color based on average performance in segment
                    const avgYtd = (d1.ytd + d2.ytd) / 2;
                    const avgLytd = (d1.lytd + d2.lytd) / 2;
                    const fillColor = avgYtd >= avgLytd ? 'rgba(46, 125, 90, 0.15)' : 'rgba(196, 49, 75, 0.15)';

                    fillAreas += `<path d="M${x1},${y1_ytd} L${x2},${y2_ytd} L${x2},${y2_lytd} L${x1},${y1_lytd} Z" fill="${fillColor}"/>`;
                }
            }

            chartData.forEach((d, i) => {
                const x = xScale(i);
                if (d.ytd !== null) {
                    const y = yScale(d.ytd);
                    pathYTD += (pathYTD ? ' L' : 'M') + `${x},${y}`;
                    const tooltipData = JSON.stringify({month: d.month, ytd: d.ytd, lytd: d.lytd, target: d.target, format: config.format}).replace(/"/g, '&quot;');
                    dotsYTD += `<circle cx="${x}" cy="${y}" r="5" fill="var(--navy)" class="chart-dot" data-info="${tooltipData}" style="cursor:pointer"/>`;
                }
                if (d.lytd !== null) {
                    const y = yScale(d.lytd);
                    pathLYTD += (pathLYTD ? ' L' : 'M') + `${x},${y}`;
                    const tooltipData = JSON.stringify({month: d.month, ytd: d.ytd, lytd: d.lytd, target: d.target, format: config.format}).replace(/"/g, '&quot;');
                    dotsLYTD += `<circle cx="${x}" cy="${y}" r="5" fill="var(--steel-blue)" class="chart-dot" data-info="${tooltipData}" style="cursor:pointer"/>`;
                }
                if (d.target !== null) {
                    const y = yScale(d.target);
                    pathTarget += (pathTarget ? ' L' : 'M') + `${x},${y}`;
                }
            });

            // Y-axis
            let yAxisHTML = '';
            for (let i = 0; i <= 5; i++) {
                const v = minVal + (maxVal - minVal) * (i / 5);
                const y = yScale(v);
                yAxisHTML += `<text x="${marginLeft-10}" y="${y+4}" text-anchor="end" fill="var(--text-muted)" font-size="11">${formatValue(v, config.format)}</text>`;
                yAxisHTML += `<line x1="${marginLeft}" y1="${y}" x2="${width-marginRight}" y2="${y}" stroke="var(--light-steel)" stroke-dasharray="3,3"/>`;
            }

            // X-axis
            let xAxisHTML = MONTHS.map((m, i) => `<text x="${xScale(i)}" y="${height-12}" text-anchor="middle" fill="var(--text-muted)" font-size="11">${m}</text>`).join('');

            // Monthly change badges
            const badgesHTML = chartData.map(d => {
                const change = calcChange(d.ytd, d.lytd, config.format);
                const changeClass = getChangeClass(change, config.format);
                return `
                    <div class="trend-badge">
                        <div class="trend-badge-month">${d.month}</div>
                        <div class="trend-badge-actual">${formatValue(d.ytd, config.format)}</div>
                        <div class="trend-badge-value ${changeClass}">${formatChange(change, config.format)} <span class="trend-badge-label">vs LY</span></div>
                    </div>
                `;
            }).join('');

            // Get market breakdown data (only show for aggregate market)
            const isAllMarkets = isAggregateValue(market, 'market');
            const marketBreakdown = isAllMarkets ? getMarkets()
                .filter(m => !isAggregateValue(m, 'market'))
                .map(m => {
                    const data = getLatestData(m, kpiKey);
                    return { market: m, value: data?.YTD || 0 };
                })
                .sort((a, b) => b.value - a.value) : [];

            const totalValue = latestData?.YTD || 1;
            const maxMarketValue = marketBreakdown[0]?.value || 1;

            return `
                <div class="kpi-hero-row">
                    <div class="kpi-hero-card">
                        <div class="kpi-hero-label">${config.name} â€” 2025${!isAllMarkets ? ` (${market})` : ''}</div>
                        <div class="kpi-hero-content">
                            <div class="kpi-hero-main">
                                <div class="kpi-hero-value">${formatValue(latestData?.YTD, config.format)}</div>
                                ${ytdVsTarget !== null ? `
                                <div class="kpi-hero-target">
                                    <div class="kpi-hero-target-info">
                                        <span class="kpi-hero-target-label">vs Target</span>
                                        <span class="kpi-hero-target-detail">Target: ${formatValue(latestData?.Target, config.format)}</span>
                                    </div>
                                    <span class="kpi-hero-target-badge ${getChangeClass(ytdVsTarget, config.format)}">${formatChange(ytdVsTarget, config.format)}</span>
                                </div>
                                ` : ''}
                            </div>
                            <div class="kpi-hero-secondary">
                                <div class="kpi-secondary-item">
                                    <div class="kpi-secondary-info">
                                        <span class="kpi-secondary-label">vs LY</span>
                                        <span class="kpi-secondary-detail">${PREVIOUS_YEAR}: ${formatValue(latestData?.LYTD, config.format)}</span>
                                    </div>
                                    <span class="kpi-secondary-value ${getChangeClass(ytdVsLytd, config.format)}">${formatChange(ytdVsLytd, config.format)}</span>
                                </div>
                                ${r12mVsLr12m !== null ? `
                                <div class="kpi-secondary-item">
                                    <div class="kpi-secondary-info">
                                        <span class="kpi-secondary-label">R12M Momentum</span>
                                        <span class="kpi-secondary-detail">R12M: ${formatValue(latestData?.R12M, config.format)} vs LMR12M: ${formatValue(latestData?.LMR12M, config.format)}</span>
                                    </div>
                                    <span class="kpi-secondary-value ${getChangeClass(r12mVsLr12m, config.format)}">${formatChange(r12mVsLr12m, config.format)}</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    ${renderBreakdownCard('market', market, kpiKey, config, channel, totalValue)}
                    ${state.mode === 'MC' ? renderBreakdownCard('channel', channel, kpiKey, config, market, totalValue) : ''}
                </div>

                <div class="chart-with-badges">
                    <div class="chart-container chart-left">
                        <div class="chart-header">
                            <div class="chart-title">Monthly Trend â€” ${config.name}</div>
                            <div class="chart-legend">
                                <div class="legend-item"><div class="legend-dot solid"></div> ${CURRENT_YEAR}</div>
                                <div class="legend-item"><div class="legend-dot dashed"></div> ${PREVIOUS_YEAR}</div>
                                ${pathTarget ? '<div class="legend-item"><div class="legend-dot target"></div> Target</div>' : ''}
                            </div>
                        </div>
                        <svg class="chart-svg" viewBox="0 0 ${width} ${height}">
                            ${yAxisHTML}
                            ${xAxisHTML}
                            ${fillAreas}
                            ${pathTarget ? `<path d="${pathTarget}" fill="none" stroke="var(--positive)" stroke-width="2" stroke-dasharray="4,4"/>` : ''}
                            <path d="${pathLYTD}" fill="none" stroke="var(--steel-blue)" stroke-width="2" stroke-dasharray="5,5"/>
                            <path d="${pathYTD}" fill="none" stroke="var(--navy)" stroke-width="3"/>
                            ${dotsLYTD}
                            ${dotsYTD}
                        </svg>
                    </div>
                    <div class="trend-badges-right">${badgesHTML}</div>
                </div>
            `;
        }

        function attachEvents() {
            const museDropzone = document.getElementById('museDropzone');
            const mcDropzone = document.getElementById('mcDropzone');
            const museFileInput = document.getElementById('museFileInput');
            const mcFileInput = document.getElementById('mcFileInput');
            const startBtn = document.getElementById('startBtn');
            const demoBtn = document.getElementById('demoBtn');

            // Mode toggle in header
            document.querySelectorAll('.mode-toggle-btn').forEach(btn => {
                btn.onclick = () => {
                    state.mode = btn.dataset.mode;
                    state.activeTab = 'summary'; // Reset to summary when switching modes
                    state.selectedMarket = null;
                    state.selectedChannel = null;
                    state.selectedKPI = null;
                    render();
                };
            });

            // MUSE file upload
            if (museDropzone) {
                museDropzone.onclick = () => museFileInput.click();
                museDropzone.ondragover = e => { e.preventDefault(); museDropzone.style.background = 'var(--light-bg)'; };
                museDropzone.ondragleave = () => { museDropzone.style.background = ''; };
                museDropzone.ondrop = e => {
                    e.preventDefault();
                    museDropzone.style.background = '';
                    const file = e.dataTransfer.files[0];
                    if (file && file.name.endsWith('.csv')) loadCSVFile(file, 'MUSE');
                };
            }

            if (museFileInput) {
                museFileInput.onchange = e => { if (e.target.files[0]) loadCSVFile(e.target.files[0], 'MUSE'); };
            }

            // MC file upload
            if (mcDropzone) {
                mcDropzone.onclick = () => mcFileInput.click();
                mcDropzone.ondragover = e => { e.preventDefault(); mcDropzone.style.background = 'var(--light-bg)'; };
                mcDropzone.ondragleave = () => { mcDropzone.style.background = ''; };
                mcDropzone.ondrop = e => {
                    e.preventDefault();
                    mcDropzone.style.background = '';
                    const file = e.dataTransfer.files[0];
                    if (file && file.name.endsWith('.csv')) loadCSVFile(file, 'MC');
                };
            }

            if (mcFileInput) {
                mcFileInput.onchange = e => { if (e.target.files[0]) loadCSVFile(e.target.files[0], 'MC'); };
            }

            // Start button
            if (startBtn) {
                startBtn.onclick = () => {
                    // Set mode based on which data is available (prefer MC if both)
                    if (state.mcData) {
                        state.mode = 'MC';
                    } else if (state.museData) {
                        state.mode = 'MUSE';
                    }
                    state.dataLoaded = true;
                    state.activeTab = 'summary';
                    render();
                };
            }

            if (demoBtn) {
                demoBtn.onclick = loadDemoData;
            }

            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.onclick = () => {
                    state.activeTab = tab.dataset.tab;
                    render();
                };
            });

            // Cascade filter handlers for MC mode
            const marketFilter = document.getElementById('marketFilter');
            const channelFilter = document.getElementById('channelFilter');

            if (marketFilter) {
                marketFilter.onchange = () => {
                    state.selectedMarket = marketFilter.value;
                    // Reset dependent filter
                    state.selectedChannel = null;
                    render();
                };
            }

            if (channelFilter) {
                channelFilter.onchange = () => {
                    state.selectedChannel = channelFilter.value;
                    render();
                };
            }

            // Channel Analysis tab KPI select
            const channelKpiSelect = document.getElementById('channelKpiSelect');
            if (channelKpiSelect) {
                channelKpiSelect.onchange = () => {
                    document.getElementById('channelAnalysisContent').innerHTML = renderDimensionAnalysis('channel', channelKpiSelect.value);
                };
            }

            // Market Analysis tab KPI select
            const marketKpiSelect = document.getElementById('marketKpiSelect');
            if (marketKpiSelect) {
                marketKpiSelect.onchange = () => {
                    document.getElementById('marketComparisonContent').innerHTML = renderMarketAnalysis(marketKpiSelect.value);
                };
            }

            // KPI Deep Dive selectors
            const kpiMarketSelect = document.getElementById('kpiMarketSelect');
            const kpiChannelSelect = document.getElementById('kpiChannelSelect');
            const kpiSelect = document.getElementById('kpiSelect');

            const defaultKPI = state.mode === 'MC' ? 'TOTAL OWN BRAND SALES' : 'SLS_TTL';
            const defaultMarket = getAggregateValue('market');

            if (kpiMarketSelect) {
                kpiMarketSelect.onchange = () => {
                    state.selectedMarket = kpiMarketSelect.value;
                    const content = document.getElementById('kpiDetailContent');
                    if (content) {
                        content.innerHTML = renderKPIDetail(state.selectedMarket, state.selectedKPI || defaultKPI, state.selectedChannel);
                        attachChartTooltips();
                    }
                };
            }

            if (kpiChannelSelect) {
                kpiChannelSelect.onchange = () => {
                    state.selectedChannel = kpiChannelSelect.value;
                    const content = document.getElementById('kpiDetailContent');
                    if (content) {
                        content.innerHTML = renderKPIDetail(state.selectedMarket || defaultMarket, state.selectedKPI || defaultKPI, state.selectedChannel);
                        attachChartTooltips();
                    }
                };
            }

            if (kpiSelect) {
                kpiSelect.onchange = () => {
                    state.selectedKPI = kpiSelect.value;
                    const content = document.getElementById('kpiDetailContent');
                    if (content) {
                        content.innerHTML = renderKPIDetail(state.selectedMarket || defaultMarket, state.selectedKPI, state.selectedChannel);
                        attachChartTooltips();
                    }
                };
            }

            attachChartTooltips();
        }

        function attachChartTooltips() {
            const tooltip = document.getElementById('chartTooltip');
            const dots = document.querySelectorAll('.chart-dot');

            dots.forEach(dot => {
                dot.addEventListener('mouseenter', (e) => {
                    const info = JSON.parse(e.target.dataset.info);
                    const changeVsLY = calcChange(info.ytd, info.lytd, info.format);
                    const changeVsTarget = info.target ? calcTargetGap(info.ytd, info.target, info.format) : null;
                    tooltip.innerHTML = `
                        <div class="tooltip-title">${info.month}</div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">${CURRENT_YEAR}:</span>
                            <span class="tooltip-value">${formatValue(info.ytd, info.format)}</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">vs LY:</span>
                            <span class="tooltip-value">${formatValue(info.lytd, info.format)} <span style="color:${changeVsLY >= 0 ? '#10B981' : '#EF4444'}">(${formatChange(changeVsLY, info.format)})</span></span>
                        </div>
                        ${info.target ? `
                        <div class="tooltip-row">
                            <span class="tooltip-label">vs Target:</span>
                            <span class="tooltip-value">${formatValue(info.target, info.format)} <span style="color:${changeVsTarget >= 0 ? '#10B981' : '#EF4444'}">(${formatChange(changeVsTarget, info.format)})</span></span>
                        </div>
                        ` : ''}
                    `;
                    tooltip.classList.add('visible');
                });

                dot.addEventListener('mousemove', (e) => {
                    tooltip.style.left = (e.clientX + 15) + 'px';
                    tooltip.style.top = (e.clientY - 10) + 'px';
                });

                dot.addEventListener('mouseleave', () => {
                    tooltip.classList.remove('visible');
                });
            });
        }

        function loadFile(file) {
            const isExcel = file.name.endsWith('.xlsx') || file.name.endsWith('.xls');

            if (isExcel) {
                // Load Excel file with SheetJS
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const result = parseExcel(workbook);

                        if (result.muse && result.muse.length > 0) {
                            state.museData = result.muse;
                        }
                        if (result.mc && result.mc.length > 0) {
                            state.mcData = result.mc;
                        }

                        // Auto-select mode based on available data
                        if (state.mcData && !state.museData) {
                            state.mode = 'MC';
                        } else if (state.museData && !state.mcData) {
                            state.mode = 'MUSE';
                        }
                        // If both available, keep user's selection

                        if (state.museData || state.mcData) {
                            state.dataLoaded = true;
                            state.selectedMarket = null;
                            state.selectedChannel = null;
                            render();
                        } else {
                            alert('Could not find MUSE or MC sheets in the workbook.');
                        }
                    } catch (err) {
                        alert('Could not parse Excel file. Please check the format.');
                    }
                };
                reader.readAsArrayBuffer(file);
            } else {
                // Load CSV file
                const reader = new FileReader();
                reader.onload = e => {
                    const data = parseCSV(e.target.result, state.mode);
                    if (data.length > 0) {
                        if (state.mode === 'MC') {
                            state.mcData = data;
                        } else {
                            state.museData = data;
                        }
                        state.dataLoaded = true;
                        state.selectedMarket = null;
                        state.selectedChannel = null;
                        render();
                    } else {
                        alert('Could not parse CSV. Please check the format.');
                    }
                };
                reader.readAsText(file);
            }
        }

        // Load CSV file for specific mode
        function loadCSVFile(file, mode) {
            const reader = new FileReader();
            reader.onload = e => {
                const data = parseCSV(e.target.result, mode);
                if (data.length > 0) {
                    if (mode === 'MC') {
                        state.mcData = data;
                        state.mcFileName = file.name;
                    } else {
                        state.museData = data;
                        state.museFileName = file.name;
                    }
                    // Re-render upload screen to show selected file
                    render();
                } else {
                    alert('Could not parse CSV. Please check the format.');
                }
            };
            reader.readAsText(file);
        }

        function loadDemoData() {
            // Load demo CSV data for MUSE mode
            fetch('data.csv')
                .then(r => r.text())
                .then(text => {
                    const data = parseCSV(text, 'MUSE');
                    if (data.length > 0) {
                        state.museData = data;
                        state.mode = 'MUSE';
                        state.dataLoaded = true;
                        render();
                    }
                })
                .catch(() => {
                    alert('Could not load demo data. Please upload a file.');
                });
        }

        render();
    })();

    // Global function for collapsible insights panel
    function toggleInsightsPanel() {
        const panel = document.getElementById('insightsPanel');
        if (panel) {
            panel.classList.toggle('collapsed');
        }
    }
    </script>
</body>
</html>
