<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025 Performance Review | KPI Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --navy: #1B365D;
            --steel-blue: #8FAFD4;
            --light-steel: #B8D4E8;
            --positive: #2E7D5A;
            --negative: #C4314B;
            --white: #FFFFFF;
            --light-bg: #F8FAFC;
            --text-dark: #1B365D;
            --text-muted: #64748B;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--light-bg);
            color: var(--text-dark);
            line-height: 1.5;
        }

        .header {
            background: var(--white);
            padding: 20px 48px;
            border-bottom: 3px solid var(--navy);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 32px;
        }

        .logo-container {
            background: var(--white);
            padding: 8px;
            border-radius: 8px;
        }

        .logo-container svg {
            height: 60px;
            width: auto;
        }

        .header-text h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--navy);
        }

        .header-text p {
            color: var(--text-muted);
            font-size: 14px;
        }

        .header-badge {
            background: var(--navy);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .nav-tabs {
            display: flex;
            gap: 4px;
            padding: 0 48px;
            background: var(--white);
            border-bottom: 1px solid var(--light-steel);
        }

        .nav-tab {
            padding: 16px 28px;
            color: var(--text-muted);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .nav-tab:hover { color: var(--navy); }
        .nav-tab.active {
            color: var(--navy);
            border-bottom-color: var(--navy);
            font-weight: 600;
        }

        .main { padding: 32px 48px; }

        /* Executive Summary Cards */
        .exec-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 32px;
        }

        .metric-card {
            background: var(--white);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--light-steel);
            border-left: 4px solid var(--navy);
            position: relative;
        }

        .metric-card.positive { border-left-color: var(--positive); }
        .metric-card.negative { border-left-color: var(--negative); }

        .metric-label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--navy);
            margin-bottom: 4px;
        }

        .metric-comparison {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            flex-wrap: wrap;
        }

        .metric-change {
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 13px;
        }

        .metric-change.up { background: rgba(46, 125, 90, 0.15); color: var(--positive); }
        .metric-change.down { background: rgba(196, 49, 75, 0.15); color: var(--negative); }

        .metric-vs { color: var(--text-muted); }

        .metric-target {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--light-steel);
            font-size: 13px;
        }

        .target-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .target-label { color: var(--text-muted); }
        .target-value { font-weight: 600; color: var(--navy); }
        .target-gap { font-weight: 600; }
        .target-gap.up { color: var(--positive); }
        .target-gap.down { color: var(--negative); }

        /* Section Headers */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--navy);
        }

        .section-subtitle {
            color: var(--text-muted);
            font-size: 14px;
        }

        /* Loyalty KPIs (formerly Focus Areas) */
        .loyalty-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }

        .loyalty-card {
            background: var(--white);
            border-radius: 12px;
            padding: 28px;
            border: 1px solid var(--light-steel);
            text-align: center;
        }

        .loyalty-card.declining { border-top: 4px solid var(--negative); }
        .loyalty-card.improving { border-top: 4px solid var(--positive); }

        .loyalty-icon {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            font-size: 24px;
        }

        .loyalty-icon.red { background: rgba(196, 49, 75, 0.12); }
        .loyalty-icon.green { background: rgba(46, 125, 90, 0.12); }

        .loyalty-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--navy);
            margin-bottom: 8px;
        }

        .loyalty-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .loyalty-value.red { color: var(--negative); }
        .loyalty-value.green { color: var(--positive); }

        .loyalty-detail {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .loyalty-target {
            font-size: 12px;
            color: var(--steel-blue);
            font-weight: 500;
        }

        /* Market Comparison Table */
        .market-table {
            width: 100%;
            background: var(--white);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--light-steel);
            margin-bottom: 40px;
            border-collapse: collapse;
        }

        .market-table th {
            background: var(--navy);
            padding: 14px 16px;
            text-align: center;
            font-size: 12px;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .market-table th.left { text-align: left; }

        .market-table td {
            padding: 14px 16px;
            border-top: 1px solid var(--light-steel);
            font-size: 14px;
            text-align: center;
        }

        .market-table tr:hover td {
            background: var(--light-bg);
        }

        .market-table tr.total-row td {
            background: rgba(27, 54, 93, 0.05);
            font-weight: 600;
        }

        .market-name {
            font-weight: 600;
            color: var(--navy);
            text-align: left !important;
        }

        .market-name.total {
            color: var(--navy);
        }

        .cell-value {
            font-weight: 600;
            color: var(--navy);
        }

        .cell-sub {
            display: block;
            font-size: 11px;
            font-weight: 500;
            margin-top: 2px;
        }

        .cell-sub.up { color: var(--positive); }
        .cell-sub.down { color: var(--negative); }

        /* Insights Panel */
        .insights-panel {
            background: var(--white);
            border-radius: 12px;
            padding: 28px;
            border: 1px solid var(--light-steel);
            border-left: 4px solid var(--steel-blue);
            margin-bottom: 40px;
        }

        .insights-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--navy);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .insight-item {
            display: flex;
            gap: 12px;
            padding: 16px;
            background: var(--light-bg);
            border-radius: 8px;
        }

        .insight-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .insight-icon.green { background: rgba(46, 125, 90, 0.15); }
        .insight-icon.amber { background: rgba(245, 158, 11, 0.15); }
        .insight-icon.blue { background: rgba(143, 175, 212, 0.3); }

        .insight-text {
            font-size: 14px;
            color: var(--text-dark);
            line-height: 1.5;
        }

        .insight-text strong {
            color: var(--navy);
        }

        /* Filters */
        .filter-row {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .filter-group label {
            display: block;
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .filter-select {
            background: var(--white);
            border: 1px solid var(--light-steel);
            color: var(--navy);
            padding: 10px 36px 10px 14px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%231B365D' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            min-width: 200px;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--navy);
        }

        /* Upload Overlay */
        .upload-overlay {
            position: fixed;
            inset: 0;
            background: rgba(27, 54, 93, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .upload-box {
            background: var(--white);
            border-radius: 16px;
            padding: 48px 64px;
            text-align: center;
            max-width: 480px;
        }

        .upload-logo { margin-bottom: 24px; }
        .upload-logo svg { height: 80px; }

        .upload-box h2 { font-size: 24px; color: var(--navy); margin-bottom: 8px; }
        .upload-box p { color: var(--text-muted); margin-bottom: 24px; }

        .dropzone {
            border: 2px dashed var(--light-steel);
            border-radius: 12px;
            padding: 32px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 16px;
        }

        .dropzone:hover { border-color: var(--navy); background: var(--light-bg); }
        .dropzone-text { color: var(--text-muted); }
        .dropzone-text span { color: var(--navy); font-weight: 600; }

        .btn-primary {
            background: var(--navy);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-primary:hover { background: #152a4a; }

        /* Chart Container */
        .chart-container {
            background: var(--white);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--light-steel);
            margin-bottom: 24px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--navy);
        }

        .chart-legend {
            display: flex;
            gap: 20px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-muted);
        }

        .legend-dot {
            width: 16px;
            height: 3px;
            border-radius: 2px;
        }

        .legend-dot.solid { background: var(--navy); }
        .legend-dot.dashed { background: repeating-linear-gradient(90deg, var(--steel-blue) 0, var(--steel-blue) 4px, transparent 4px, transparent 8px); }
        .legend-dot.target { background: var(--positive); }

        .chart-svg {
            width: 100%;
            height: 280px;
        }

        /* Momentum Cards */
        .momentum-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .momentum-card {
            background: var(--light-bg);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .momentum-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .momentum-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--navy);
        }

        .momentum-change {
            font-size: 13px;
            font-weight: 600;
            margin-top: 4px;
        }

        .momentum-change.up { color: var(--positive); }
        .momentum-change.down { color: var(--negative); }

        .trend-badges {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 8px;
            margin-top: 20px;
        }

        .trend-badge {
            background: var(--light-bg);
            padding: 10px 4px;
            border-radius: 6px;
            text-align: center;
        }

        .trend-badge-month {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .trend-badge-value {
            font-size: 12px;
            font-weight: 600;
        }

        .trend-badge-value.up { color: var(--positive); }
        .trend-badge-value.down { color: var(--negative); }

        /* Analysis Table */
        .analysis-table {
            width: 100%;
            background: var(--white);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--light-steel);
            border-collapse: collapse;
        }

        .analysis-table th {
            background: var(--navy);
            padding: 14px 16px;
            text-align: center;
            font-size: 12px;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .analysis-table th.left { text-align: left; }

        .analysis-table td {
            padding: 14px 16px;
            border-top: 1px solid var(--light-steel);
            font-size: 14px;
            text-align: center;
        }

        .analysis-table tr:hover td { background: var(--light-bg); }

        .analysis-table tr.total-row td {
            background: rgba(27, 54, 93, 0.08);
            font-weight: 600;
            border-top: 2px solid var(--navy);
        }

        @media (max-width: 1200px) {
            .exec-summary { grid-template-columns: repeat(2, 1fr); }
            .loyalty-grid { grid-template-columns: 1fr; }
            .insights-grid { grid-template-columns: 1fr; }
            .momentum-grid { grid-template-columns: 1fr; }
        }

        @media (max-width: 768px) {
            .header, .main, .nav-tabs { padding-left: 20px; padding-right: 20px; }
            .exec-summary { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
    (function() {
        const MONTHS = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
        const MONTH_MAP = {'01 - Jan':'JAN','02 - Feb':'FEB','03 - Mar':'MAR','04 - Apr':'APR','05 - May':'MAY','06 - Jun':'JUN','07 - Jul':'JUL','08 - Aug':'AUG','09 - Sep':'SEP','10 - Oct':'OCT','11 - Nov':'NOV','12 - Dec':'DEC'};

        const KPI_CONFIG = {
            'SLS_TTL': { name: 'Total Sales', format: 'currency', good: 'up' },
            'SLS_PEN': { name: 'Sales Penetration', format: 'percent', good: 'up' },
            'MBR_TTL': { name: 'Transacting Members', format: 'number', good: 'up' },
            'MBR_NEW': { name: 'New Members', format: 'number', good: 'up' },
            'MBR_RTN': { name: 'Returning Members', format: 'number', good: 'up' },
            'AVG_ATF': { name: 'Avg Frequency', format: 'decimal', good: 'up' },
            'AVG_AOV': { name: 'Avg Order Value', format: 'currency_small', good: 'up' },
            'PCT_RDM': { name: 'Redeeming Members %', format: 'percent', good: 'up', loyalty: true },
            'PCT_XBP': { name: 'Cross Brand Plus %', format: 'percent', good: 'up', loyalty: true },
            'PCT_NBA': { name: 'New Brand Adopters %', format: 'percent', good: 'up', loyalty: true },
            'AVG_BRD': { name: 'Avg Brands Shopped', format: 'decimal', good: 'up' },
            'PTS_BRN': { name: 'Points Burned Value', format: 'currency', good: 'up' }
        };

        const MARKET_ORDER = ['All Markets', 'United Arab Emirates', 'Saudi Arabia', 'Kuwait', 'Bahrain'];

        // Company Logo SVG
        const LOGO_SVG = `<svg viewBox="0 0 120 160" xmlns="http://www.w3.org/2000/svg">
            <!-- Vertical lines -->
            <rect x="20" y="0" width="8" height="95" fill="#8FAFD4"/>
            <rect x="35" y="0" width="8" height="105" fill="#8FAFD4"/>
            <rect x="50" y="0" width="8" height="115" fill="#8FAFD4"/>
            <rect x="65" y="0" width="8" height="125" fill="#1B365D"/>
            <!-- Curved elements -->
            <path d="M20 95 Q20 130 45 150 Q55 158 55 145 Q55 130 35 115 Q20 105 20 95" fill="#1B365D"/>
            <path d="M35 105 Q35 135 55 152 Q65 160 65 147 Q65 135 50 122 Q35 112 35 105" fill="#1B365D"/>
            <path d="M50 115 Q50 140 68 155 Q78 162 78 150 Q78 140 65 128 Q50 120 50 115" fill="#1B365D"/>
            <path d="M65 125 Q65 145 80 157 Q90 163 90 152 Q90 143 78 133 Q65 128 65 125" fill="#1B365D"/>
            <!-- Diamond accents -->
            <rect x="95" y="25" width="10" height="10" transform="rotate(45 100 30)" fill="#1B365D"/>
            <rect x="105" y="35" width="8" height="8" transform="rotate(45 109 39)" fill="#8FAFD4"/>
            <rect x="95" y="45" width="8" height="8" transform="rotate(45 99 49)" fill="#8FAFD4"/>
        </svg>`;

        let state = {
            data: null,
            selectedMarket: 'All Markets',
            selectedKPI: null,
            activeTab: 'summary',
            showUpload: true
        };

        // Utility functions
        function formatValue(value, format) {
            if (value === null || value === undefined || isNaN(value)) return 'â€”';
            switch(format) {
                case 'currency':
                    if (value >= 1e9) return '$' + (value/1e9).toFixed(2) + 'B';
                    if (value >= 1e6) return '$' + (value/1e6).toFixed(1) + 'M';
                    if (value >= 1e3) return '$' + (value/1e3).toFixed(0) + 'K';
                    return '$' + value.toFixed(0);
                case 'currency_small':
                    return '$' + value.toFixed(0);
                case 'percent':
                    return (value * 100).toFixed(1) + '%';
                case 'number':
                    if (value >= 1e6) return (value/1e6).toFixed(2) + 'M';
                    if (value >= 1e3) return (value/1e3).toFixed(0) + 'K';
                    return value.toLocaleString();
                case 'decimal':
                    return value.toFixed(2);
                default:
                    return value.toString();
            }
        }

        function calcChange(current, previous, format) {
            if (!current || !previous || previous === 0) return null;
            if (format === 'percent') {
                const curr = parseFloat((current * 100).toFixed(1));
                const prev = parseFloat((previous * 100).toFixed(1));
                return curr - prev;
            }
            return ((current / previous) - 1) * 100;
        }

        function calcTargetGap(current, target, format) {
            if (!current || !target || target === 0) return null;
            if (format === 'percent') {
                const curr = parseFloat((current * 100).toFixed(1));
                const tgt = parseFloat((target * 100).toFixed(1));
                return curr - tgt;
            }
            return ((current / target) - 1) * 100;
        }

        function formatChange(change, format) {
            if (change === null) return 'â€”';
            const sign = change >= 0 ? '+' : '';
            if (format === 'percent') {
                return sign + change.toFixed(1) + ' PP';
            }
            return sign + change.toFixed(1) + '%';
        }

        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                const row = {};
                headers.forEach((h, idx) => {
                    let val = values[idx]?.trim();
                    if (['YTD', 'LYTD', 'R12M', 'LMR12M', 'Target'].includes(h)) {
                        row[h] = val === '' ? null : parseFloat(val);
                    } else {
                        row[h] = val;
                    }
                });
                if (row.Market && row.Key) data.push(row);
            }
            return data;
        }

        function getLatestData(market, kpiKey) {
            if (!state.data) return null;
            const rows = state.data.filter(d => d.Market === market && d.Key === kpiKey);
            return rows.find(d => d.Month === '12 - Dec') || rows[rows.length - 1];
        }

        function getMonthlyData(market, kpiKey) {
            if (!state.data) return [];
            return state.data.filter(d => d.Market === market && d.Key === kpiKey)
                .sort((a, b) => a.Month.localeCompare(b.Month));
        }

        function getMarkets() {
            if (!state.data) return [];
            const markets = [...new Set(state.data.map(d => d.Market))];
            return MARKET_ORDER.filter(m => markets.includes(m));
        }

        function getKPIs() {
            if (!state.data) return [];
            return [...new Set(state.data.map(d => d.Key))].filter(k => KPI_CONFIG[k]);
        }

        // Generate balanced insights
        function generateInsights() {
            const insights = [];
            const market = 'All Markets';

            // POSITIVE: Sales growth
            const sales = getLatestData(market, 'SLS_TTL');
            if (sales) {
                const change = calcChange(sales.YTD, sales.LYTD, 'currency');
                if (change > 0) {
                    insights.push({
                        icon: 'ðŸ“ˆ', color: 'green',
                        text: `<strong>Revenue grew ${change.toFixed(1)}%</strong> YoY to ${formatValue(sales.YTD, 'currency')}, demonstrating strong commercial performance`
                    });
                }
            }

            // POSITIVE: AOV growth
            const aov = getLatestData(market, 'AVG_AOV');
            if (aov) {
                const change = calcChange(aov.YTD, aov.LYTD, 'currency');
                if (change > 0) {
                    insights.push({
                        icon: 'ðŸ’°', color: 'green',
                        text: `<strong>Average basket size increased ${change.toFixed(1)}%</strong> to ${formatValue(aov.YTD, 'currency_small')}, indicating higher customer value per visit`
                    });
                }
            }

            // POSITIVE: Member growth
            const members = getLatestData(market, 'MBR_TTL');
            if (members) {
                const change = calcChange(members.YTD, members.LYTD, 'number');
                if (change > 0) {
                    insights.push({
                        icon: 'ðŸ‘¥', color: 'green',
                        text: `<strong>Member base expanded ${change.toFixed(1)}%</strong> to ${formatValue(members.YTD, 'number')}, showing continued program growth`
                    });
                }
            }

            // CONSTRUCTIVE: NBA opportunity
            const nba = getLatestData(market, 'PCT_NBA');
            if (nba) {
                const change = calcChange(nba.YTD, nba.LYTD, 'percent');
                if (change < 0) {
                    insights.push({
                        icon: 'ðŸŽ¯', color: 'amber',
                        text: `<strong>Brand discovery opportunity:</strong> New Brand Adopters at ${formatValue(nba.YTD, 'percent')} (${formatChange(change, 'percent')}) â€” cross-promotion campaigns could unlock growth`
                    });
                }
            }

            // CONSTRUCTIVE: XBP opportunity
            const xbp = getLatestData(market, 'PCT_XBP');
            if (xbp) {
                const change = calcChange(xbp.YTD, xbp.LYTD, 'percent');
                if (change < 0) {
                    insights.push({
                        icon: 'ðŸ”„', color: 'amber',
                        text: `<strong>Cross-brand engagement:</strong> Multi-brand shoppers at ${formatValue(xbp.YTD, 'percent')} (${formatChange(change, 'percent')}) â€” bundled offers may help diversify baskets`
                    });
                }
            }

            // CONSTRUCTIVE: Redemption opportunity
            const rdm = getLatestData(market, 'PCT_RDM');
            if (rdm) {
                const change = calcChange(rdm.YTD, rdm.LYTD, 'percent');
                if (change < 0) {
                    insights.push({
                        icon: 'ðŸŽ', color: 'amber',
                        text: `<strong>Redemption activation:</strong> Point usage at ${formatValue(rdm.YTD, 'percent')} (${formatChange(change, 'percent')}) â€” targeted reminders could re-engage dormant points`
                    });
                }
            }

            return insights.slice(0, 6);
        }

        // Render functions
        function render() {
            const app = document.getElementById('app');
            if (state.showUpload) {
                app.innerHTML = renderUpload();
            } else {
                app.innerHTML = renderDashboard();
            }
            attachEvents();
        }

        function renderUpload() {
            return `
                <div class="upload-overlay">
                    <div class="upload-box">
                        <div class="upload-logo">${LOGO_SVG}</div>
                        <h2>2025 Performance Review</h2>
                        <p>Upload your KPI data to generate the presentation dashboard</p>
                        <div class="dropzone" id="dropzone">
                            <p class="dropzone-text"><span>Click to upload</span> or drag & drop CSV</p>
                            <input type="file" id="fileInput" accept=".csv" style="display:none">
                        </div>
                        <button class="btn-primary" id="demoBtn">Load Demo Data</button>
                    </div>
                </div>
            `;
        }

        function renderDashboard() {
            return `
                <header class="header">
                    <div class="header-left">
                        <div class="logo-container">${LOGO_SVG}</div>
                        <div class="header-text">
                            <h1>2025 Performance Review</h1>
                            <p>Year-over-Year Analysis | Strategic KPI Dashboard</p>
                        </div>
                    </div>
                    <span class="header-badge">Full Year Results</span>
                </header>
                <nav class="nav-tabs">
                    <div class="nav-tab ${state.activeTab === 'summary' ? 'active' : ''}" data-tab="summary">Executive Summary</div>
                    <div class="nav-tab ${state.activeTab === 'markets' ? 'active' : ''}" data-tab="markets">Market Analysis</div>
                    <div class="nav-tab ${state.activeTab === 'kpi' ? 'active' : ''}" data-tab="kpi">KPI Deep Dive</div>
                </nav>
                <main class="main">
                    ${state.activeTab === 'summary' ? renderSummaryTab() : ''}
                    ${state.activeTab === 'markets' ? renderMarketsTab() : ''}
                    ${state.activeTab === 'kpi' ? renderKPITab() : ''}
                </main>
            `;
        }

        function renderSummaryTab() {
            const market = 'All Markets';
            const keyKPIs = ['SLS_TTL', 'MBR_TTL', 'AVG_AOV', 'AVG_ATF'];
            const loyaltyKPIs = ['PCT_NBA', 'PCT_XBP', 'PCT_RDM'];
            const insights = generateInsights();

            return `
                <div class="section-header">
                    <div>
                        <div class="section-title">Key Performance Indicators</div>
                        <div class="section-subtitle">Full Year 2025 vs 2024 | All Markets</div>
                    </div>
                </div>
                <div class="exec-summary">
                    ${keyKPIs.map(key => renderMetricCard(market, key)).join('')}
                </div>

                <div class="section-header">
                    <div>
                        <div class="section-title">Loyalty KPIs</div>
                        <div class="section-subtitle">Member engagement metrics</div>
                    </div>
                </div>
                <div class="loyalty-grid">
                    ${loyaltyKPIs.map(key => renderLoyaltyCard(market, key)).join('')}
                </div>

                <div class="insights-panel">
                    <div class="insights-title">Key Insights</div>
                    <div class="insights-grid">
                        ${insights.map(i => `
                            <div class="insight-item">
                                <div class="insight-icon ${i.color}">${i.icon}</div>
                                <div class="insight-text">${i.text}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                ${renderMarketSummaryTable()}
            `;
        }

        function renderMetricCard(market, kpiKey) {
            const config = KPI_CONFIG[kpiKey];
            const data = getLatestData(market, kpiKey);
            if (!data || !config) return '';

            const change = calcChange(data.YTD, data.LYTD, config.format);
            const isPositive = change !== null && change >= 0;
            const isGood = config.good === 'up' ? isPositive : !isPositive;

            let targetHTML = '';
            if (data.Target) {
                const gap = calcTargetGap(data.YTD, data.Target, config.format);
                const gapClass = gap >= 0 ? 'up' : 'down';
                targetHTML = `
                    <div class="metric-target">
                        <div class="target-row">
                            <span class="target-label">Target: ${formatValue(data.Target, config.format)}</span>
                            <span class="target-gap ${gapClass}">${formatChange(gap, config.format)}</span>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="metric-card ${isGood ? 'positive' : 'negative'}">
                    <div class="metric-label">${config.name}</div>
                    <div class="metric-value">${formatValue(data.YTD, config.format)}</div>
                    <div class="metric-comparison">
                        <span class="metric-change ${isPositive ? 'up' : 'down'}">${formatChange(change, config.format)} vs 2024</span>
                    </div>
                    ${targetHTML}
                </div>
            `;
        }

        function renderLoyaltyCard(market, kpiKey) {
            const config = KPI_CONFIG[kpiKey];
            const data = getLatestData(market, kpiKey);
            if (!data || !config) return '';

            const change = calcChange(data.YTD, data.LYTD, config.format);
            const isNegative = change !== null && change < 0;

            const iconMap = {
                'PCT_NBA': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/></svg>',
                'PCT_XBP': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 3h5v5M4 20L21 3M21 16v5h-5M15 15l6 6M4 4l5 5"/></svg>',
                'PCT_RDM': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="8" width="18" height="13" rx="2"/><path d="M12 8V21M3 12h18M7.5 8V6.5a4.5 4.5 0 019 0V8"/></svg>'
            };

            let targetText = '';
            if (data.Target) {
                const gap = calcTargetGap(data.YTD, data.Target, config.format);
                targetText = `Target: ${formatValue(data.Target, config.format)} (${formatChange(gap, config.format)})`;
            }

            return `
                <div class="loyalty-card ${isNegative ? 'declining' : 'improving'}">
                    <div class="loyalty-icon ${isNegative ? 'red' : 'green'}" style="color: ${isNegative ? 'var(--negative)' : 'var(--positive)'}">${iconMap[kpiKey] || ''}</div>
                    <div class="loyalty-title">${config.name}</div>
                    <div class="loyalty-value ${isNegative ? 'red' : 'green'}">${formatChange(change, config.format)}</div>
                    <div class="loyalty-detail">
                        2025: ${formatValue(data.YTD, config.format)} vs 2024: ${formatValue(data.LYTD, config.format)}
                    </div>
                    ${targetText ? `<div class="loyalty-target">${targetText}</div>` : ''}
                </div>
            `;
        }

        function renderMarketSummaryTable() {
            const markets = getMarkets();
            const kpis = ['SLS_TTL', 'PCT_NBA', 'PCT_XBP', 'PCT_RDM'];

            return `
                <div class="section-header">
                    <div class="section-title">Market Comparison</div>
                </div>
                <table class="market-table">
                    <thead>
                        <tr>
                            <th class="left">Market</th>
                            ${kpis.map(k => {
                                const hasTarget = markets.some(m => {
                                    const d = getLatestData(m, k);
                                    return d && d.Target;
                                });
                                return `<th>${KPI_CONFIG[k]?.name || k}<br><small style="font-weight:400;opacity:0.8">vs 2024${hasTarget ? ' | vs Target' : ''}</small></th>`;
                            }).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${markets.map((m, idx) => {
                            const isTotal = m === 'All Markets';
                            return `
                                <tr class="${isTotal ? 'total-row' : ''}">
                                    <td class="market-name ${isTotal ? 'total' : ''}">${m}</td>
                                    ${kpis.map(k => {
                                        const config = KPI_CONFIG[k];
                                        const data = getLatestData(m, k);
                                        if (!data) return '<td>â€”</td>';
                                        const change = calcChange(data.YTD, data.LYTD, config.format);
                                        const isUp = change >= 0;

                                        let targetGapHTML = '';
                                        if (data.Target) {
                                            const tGap = calcTargetGap(data.YTD, data.Target, config.format);
                                            const tIsUp = tGap >= 0;
                                            targetGapHTML = ` | <span class="cell-sub ${tIsUp ? 'up' : 'down'}">${formatChange(tGap, config.format)}</span>`;
                                        }

                                        return `
                                            <td>
                                                <span class="cell-value">${formatValue(data.YTD, config.format)}</span>
                                                <span class="cell-sub ${isUp ? 'up' : 'down'}">${formatChange(change, config.format)}</span>${targetGapHTML}
                                            </td>
                                        `;
                                    }).join('')}
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderMarketsTab() {
            const kpis = getKPIs();

            return `
                <div class="filter-row">
                    <div class="filter-group">
                        <label>Select KPI</label>
                        <select class="filter-select" id="marketKpiSelect">
                            ${kpis.map(k => `<option value="${k}" ${k === 'SLS_TTL' ? 'selected' : ''}>${KPI_CONFIG[k]?.name || k}</option>`).join('')}
                        </select>
                    </div>
                </div>
                <div id="marketComparisonContent">
                    ${renderMarketAnalysis('SLS_TTL')}
                </div>
            `;
        }

        function renderMarketAnalysis(kpiKey) {
            const config = KPI_CONFIG[kpiKey];
            const markets = getMarkets();

            // Get total for calculating share
            const totalData = getLatestData('All Markets', kpiKey);
            const totalValue = totalData?.YTD || 0;

            // Prepare market data (excluding All Markets for the rows, but showing it)
            const allMarketData = markets.map(m => {
                const data = getLatestData(m, kpiKey);
                return { market: m, data, isTotal: m === 'All Markets' };
            }).filter(d => d.data);

            return `
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">${config?.name || kpiKey} by Market</div>
                    </div>
                    <table class="analysis-table">
                        <thead>
                            <tr>
                                <th class="left" style="width:180px">Market</th>
                                <th>2025 YTD</th>
                                <th>% of Total</th>
                                <th>vs 2024</th>
                                <th>vs Target</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${allMarketData.map(({market, data, isTotal}) => {
                                const change = calcChange(data.YTD, data.LYTD, config.format);
                                const isUp = change >= 0;

                                // Calculate share of total
                                let shareText = 'â€”';
                                if (!isTotal && totalValue > 0) {
                                    const share = (data.YTD / totalValue) * 100;
                                    shareText = share.toFixed(1) + '%';
                                } else if (isTotal) {
                                    shareText = '100%';
                                }

                                // Target gap
                                let targetGapText = 'â€”';
                                let targetGapClass = '';
                                if (data.Target) {
                                    const tGap = calcTargetGap(data.YTD, data.Target, config.format);
                                    targetGapClass = tGap >= 0 ? 'up' : 'down';
                                    targetGapText = formatChange(tGap, config.format);
                                }

                                return `
                                    <tr class="${isTotal ? 'total-row' : ''}">
                                        <td class="market-name">${market}</td>
                                        <td class="cell-value">${formatValue(data.YTD, config.format)}</td>
                                        <td>${shareText}</td>
                                        <td>
                                            <span class="cell-sub ${isUp ? 'up' : 'down'}" style="font-size:14px">${formatChange(change, config.format)}</span>
                                        </td>
                                        <td>
                                            <span class="cell-sub ${targetGapClass}" style="font-size:14px">${targetGapText}</span>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderKPITab() {
            const kpis = getKPIs();
            const markets = getMarkets();
            const selectedKPI = state.selectedKPI || 'SLS_TTL';
            const selectedMarket = state.selectedMarket || 'All Markets';

            return `
                <div class="filter-row">
                    <div class="filter-group">
                        <label>Market</label>
                        <select class="filter-select" id="kpiMarketSelect">
                            ${markets.map(m => `<option value="${m}" ${m === selectedMarket ? 'selected' : ''}>${m}</option>`).join('')}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>KPI Metric</label>
                        <select class="filter-select" id="kpiSelect">
                            ${kpis.map(k => `<option value="${k}" ${k === selectedKPI ? 'selected' : ''}>${KPI_CONFIG[k]?.name || k}</option>`).join('')}
                        </select>
                    </div>
                </div>
                <div id="kpiDetailContent">
                    ${renderKPIDetail(selectedMarket, selectedKPI)}
                </div>
            `;
        }

        function renderKPIDetail(market, kpiKey) {
            const config = KPI_CONFIG[kpiKey];
            const monthlyData = getMonthlyData(market, kpiKey);
            const latestData = getLatestData(market, kpiKey);

            if (!config || monthlyData.length === 0) {
                return '<p>No data available for selection</p>';
            }

            // Calculate R12M momentum (R12M vs LMR12M)
            let r12mMomentum = null;
            if (latestData?.R12M && latestData?.LMR12M) {
                r12mMomentum = calcChange(latestData.R12M, latestData.LMR12M, config.format);
            }

            // Prepare chart data
            const chartData = MONTHS.map(month => {
                const row = monthlyData.find(d => MONTH_MAP[d.Month] === month);
                return {
                    month,
                    ytd: row?.YTD ?? null,
                    lytd: row?.LYTD ?? null,
                    target: row?.Target ?? null
                };
            });

            // SVG Chart
            const width = 900, height = 260;
            const marginLeft = 70, marginRight = 30, marginTop = 20, marginBottom = 40;
            const chartWidth = width - marginLeft - marginRight;
            const chartHeight = height - marginTop - marginBottom;

            const allVals = chartData.flatMap(d => [d.ytd, d.lytd, d.target]).filter(v => v !== null);
            const minVal = Math.min(...allVals) * 0.9;
            const maxVal = Math.max(...allVals) * 1.1;

            const xScale = i => marginLeft + (i * chartWidth / 11);
            const yScale = v => marginTop + chartHeight - ((v - minVal) / (maxVal - minVal)) * chartHeight;

            let pathYTD = '', pathLYTD = '', pathTarget = '';
            let dotsYTD = '', dotsLYTD = '';

            chartData.forEach((d, i) => {
                const x = xScale(i);
                if (d.ytd !== null) {
                    const y = yScale(d.ytd);
                    pathYTD += (pathYTD ? ' L' : 'M') + `${x},${y}`;
                    dotsYTD += `<circle cx="${x}" cy="${y}" r="4" fill="var(--navy)"/>`;
                }
                if (d.lytd !== null) {
                    const y = yScale(d.lytd);
                    pathLYTD += (pathLYTD ? ' L' : 'M') + `${x},${y}`;
                    dotsLYTD += `<circle cx="${x}" cy="${y}" r="4" fill="var(--steel-blue)"/>`;
                }
                if (d.target !== null) {
                    const y = yScale(d.target);
                    pathTarget += (pathTarget ? ' L' : 'M') + `${x},${y}`;
                }
            });

            // Y-axis
            let yAxisHTML = '';
            for (let i = 0; i <= 5; i++) {
                const v = minVal + (maxVal - minVal) * (i / 5);
                const y = yScale(v);
                yAxisHTML += `<text x="${marginLeft-10}" y="${y+4}" text-anchor="end" fill="var(--text-muted)" font-size="11">${formatValue(v, config.format)}</text>`;
                yAxisHTML += `<line x1="${marginLeft}" y1="${y}" x2="${width-marginRight}" y2="${y}" stroke="var(--light-steel)" stroke-dasharray="3,3"/>`;
            }

            // X-axis
            let xAxisHTML = MONTHS.map((m, i) => `<text x="${xScale(i)}" y="${height-12}" text-anchor="middle" fill="var(--text-muted)" font-size="11">${m}</text>`).join('');

            // Monthly change badges
            const badgesHTML = chartData.map(d => {
                const change = calcChange(d.ytd, d.lytd, config.format);
                const isUp = change >= 0;
                return `
                    <div class="trend-badge">
                        <div class="trend-badge-month">${d.month}</div>
                        <div class="trend-badge-value ${isUp ? 'up' : 'down'}">${formatChange(change, config.format)}</div>
                    </div>
                `;
            }).join('');

            // Target gap for card
            let targetGapText = '';
            if (latestData?.Target) {
                const gap = calcTargetGap(latestData.YTD, latestData.Target, config.format);
                const gapClass = gap >= 0 ? 'up' : 'down';
                targetGapText = `<span class="cell-sub ${gapClass}" style="font-size:14px">${formatChange(gap, config.format)} from target</span>`;
            }

            return `
                <div class="momentum-grid">
                    <div class="momentum-card">
                        <div class="momentum-label">2025 YTD</div>
                        <div class="momentum-value">${formatValue(latestData?.YTD, config.format)}</div>
                        ${targetGapText ? `<div>${targetGapText}</div>` : ''}
                    </div>
                    <div class="momentum-card">
                        <div class="momentum-label">Rolling 12M</div>
                        <div class="momentum-value">${formatValue(latestData?.R12M, config.format)}</div>
                        ${r12mMomentum !== null ? `<div class="momentum-change ${r12mMomentum >= 0 ? 'up' : 'down'}">${formatChange(r12mMomentum, config.format)} momentum</div>` : ''}
                    </div>
                    <div class="momentum-card">
                        <div class="momentum-label">Target</div>
                        <div class="momentum-value">${latestData?.Target ? formatValue(latestData.Target, config.format) : 'â€”'}</div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">Monthly Trend â€” ${config.name}</div>
                        <div class="chart-legend">
                            <div class="legend-item"><div class="legend-dot solid"></div> 2025</div>
                            <div class="legend-item"><div class="legend-dot dashed"></div> 2024</div>
                            ${pathTarget ? '<div class="legend-item"><div class="legend-dot target"></div> Target</div>' : ''}
                        </div>
                    </div>
                    <svg class="chart-svg" viewBox="0 0 ${width} ${height}">
                        ${yAxisHTML}
                        ${xAxisHTML}
                        ${pathTarget ? `<path d="${pathTarget}" fill="none" stroke="var(--positive)" stroke-width="2" stroke-dasharray="4,4"/>` : ''}
                        <path d="${pathLYTD}" fill="none" stroke="var(--steel-blue)" stroke-width="2" stroke-dasharray="5,5"/>
                        <path d="${pathYTD}" fill="none" stroke="var(--navy)" stroke-width="3"/>
                        ${dotsLYTD}
                        ${dotsYTD}
                    </svg>
                    <div class="trend-badges">${badgesHTML}</div>
                </div>
            `;
        }

        function attachEvents() {
            // Upload
            const dropzone = document.getElementById('dropzone');
            const fileInput = document.getElementById('fileInput');
            const demoBtn = document.getElementById('demoBtn');

            if (dropzone) {
                dropzone.onclick = () => fileInput.click();
                dropzone.ondragover = e => { e.preventDefault(); dropzone.style.borderColor = 'var(--navy)'; };
                dropzone.ondragleave = () => { dropzone.style.borderColor = 'var(--light-steel)'; };
                dropzone.ondrop = e => {
                    e.preventDefault();
                    const file = e.dataTransfer.files[0];
                    if (file) loadFile(file);
                };
            }

            if (fileInput) {
                fileInput.onchange = e => { if (e.target.files[0]) loadFile(e.target.files[0]); };
            }

            if (demoBtn) {
                demoBtn.onclick = loadDemoData;
            }

            // Tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.onclick = () => {
                    state.activeTab = tab.dataset.tab;
                    render();
                };
            });

            // Market KPI select
            const marketKpiSelect = document.getElementById('marketKpiSelect');
            if (marketKpiSelect) {
                marketKpiSelect.onchange = () => {
                    document.getElementById('marketComparisonContent').innerHTML = renderMarketAnalysis(marketKpiSelect.value);
                };
            }

            // KPI detail selects
            const kpiMarketSelect = document.getElementById('kpiMarketSelect');
            const kpiSelect = document.getElementById('kpiSelect');

            if (kpiMarketSelect) {
                kpiMarketSelect.onchange = () => {
                    state.selectedMarket = kpiMarketSelect.value;
                    document.getElementById('kpiDetailContent').innerHTML = renderKPIDetail(state.selectedMarket, state.selectedKPI || 'SLS_TTL');
                };
            }

            if (kpiSelect) {
                kpiSelect.onchange = () => {
                    state.selectedKPI = kpiSelect.value;
                    document.getElementById('kpiDetailContent').innerHTML = renderKPIDetail(state.selectedMarket || 'All Markets', state.selectedKPI);
                };
            }
        }

        function loadFile(file) {
            const reader = new FileReader();
            reader.onload = e => {
                const data = parseCSV(e.target.result);
                if (data.length > 0) {
                    state.data = data;
                    state.showUpload = false;
                    render();
                } else {
                    alert('Could not parse CSV. Please check the format.');
                }
            };
            reader.readAsText(file);
        }

        function loadDemoData() {
            fetch('data.csv')
                .then(r => r.text())
                .then(text => {
                    const data = parseCSV(text);
                    if (data.length > 0) {
                        state.data = data;
                        state.showUpload = false;
                        render();
                    }
                })
                .catch(() => {
                    alert('Could not load demo data. Please upload a CSV file.');
                });
        }

        // Initialize
        render();
    })();
    </script>
</body>
</html>
