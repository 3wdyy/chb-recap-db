<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MUSE Performance Review | KPI Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            /* Colors */
            --navy: #1B365D;
            --steel-blue: #8FAFD4;
            --light-steel: #B8D4E8;
            --positive: #2E7D5A;
            --negative: #C4314B;
            --neutral: #B8860B;
            --positive-soft: #3d9970;
            --negative-soft: #d35d6e;
            --neutral-soft: #D4A017;
            --white: #FFFFFF;
            --light-bg: #F8FAFC;
            --text-dark: #1B365D;
            --text-muted: #64748B;

            /* Typography Scale */
            --font-display: 48px;
            --font-h1: 26px;
            --font-h2: 20px;
            --font-h3: 18px;
            --font-value-xl: 32px;
            --font-value-lg: 26px;
            --font-value-md: 20px;
            --font-value-sm: 16px;
            --font-body-lg: 15px;
            --font-body: 14px;
            --font-body-sm: 13px;
            --font-caption: 12px;
            --font-label: 11px;
            --font-micro: 10px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--light-bg);
            color: var(--text-dark);
            line-height: 1.5;
        }

        .header {
            background: var(--white);
            padding: 20px 48px;
            border-bottom: 3px solid var(--navy);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 32px;
        }

        .logo-container {
            background: var(--white);
            padding: 8px;
        }

        .logo-container svg,
        .logo-container img {
            height: 70px;
            width: auto;
            max-width: 200px;
            object-fit: contain;
        }

        .header-text h1 {
            font-size: var(--font-h1);
            font-weight: 700;
            color: var(--navy);
        }

        .header-text p {
            color: var(--text-muted);
            font-size: var(--font-body);
        }

        .header-badge {
            background: var(--navy);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: var(--font-body-sm);
            font-weight: 600;
        }

        .nav-tabs {
            display: flex;
            gap: 4px;
            padding: 0 48px;
            background: var(--white);
            border-bottom: 1px solid var(--light-steel);
        }

        .nav-tab {
            padding: 16px 28px;
            color: var(--text-muted);
            font-size: var(--font-body);
            font-weight: 500;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .nav-tab:hover { color: var(--navy); }
        .nav-tab.active {
            color: var(--navy);
            border-bottom-color: var(--navy);
            font-weight: 600;
        }

        .main { padding: 32px 48px; }

        /* Executive Summary Cards */
        .exec-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 32px;
        }

        .metric-card {
            background: var(--white);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--light-steel);
            border-left: 4px solid var(--navy);
            box-shadow: 0 2px 8px rgba(27, 54, 93, 0.08);
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(27, 54, 93, 0.15);
        }

        .metric-card.positive { border-left-color: var(--positive); }
        .metric-card.negative { border-left-color: var(--negative); }
        .metric-card.neutral { border-left-color: var(--neutral); }

        .metric-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .metric-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--light-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--navy);
        }

        .metric-label {
            font-size: var(--font-label);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-value {
            font-size: var(--font-value-xl);
            font-weight: 700;
            color: var(--navy);
            margin-bottom: 18px;
            letter-spacing: -0.5px;
        }

        .metric-target-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 14px;
            background: var(--light-bg);
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .metric-target-left {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: var(--font-body-sm);
            color: var(--text-muted);
        }

        .metric-target-val {
            font-weight: 700;
            color: var(--navy);
            font-size: var(--font-body-sm);
        }

        .metric-target-badge {
            padding: 5px 12px;
            border-radius: 14px;
            font-weight: 700;
            font-size: var(--font-body-sm);
        }

        .metric-target-badge.up {
            background: rgba(46, 125, 90, 0.15);
            color: var(--positive);
        }

        .metric-target-badge.down {
            background: rgba(196, 49, 75, 0.15);
            color: var(--negative);
        }

        .metric-target-badge.neutral {
            background: rgba(184, 134, 11, 0.15);
            color: var(--neutral);
        }

        .metric-vs-row {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: var(--font-caption);
            color: var(--text-muted);
        }

        .metric-vs-arrow {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            font-weight: 600;
        }

        .metric-vs-arrow.up { color: var(--positive); }
        .metric-vs-arrow.down { color: var(--negative); }
        .metric-vs-arrow.neutral { color: var(--neutral); }

        .metric-vs-arrow svg {
            width: 14px;
            height: 14px;
        }

        /* Section Headers */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .section-title {
            font-size: var(--font-h2);
            font-weight: 700;
            color: var(--navy);
            letter-spacing: -0.3px;
        }

        .section-subtitle {
            color: var(--text-muted);
            font-size: var(--font-body);
        }

        /* Market Table */
        .market-table {
            width: 100%;
            background: var(--white);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--light-steel);
            margin-bottom: 40px;
            border-collapse: collapse;
        }

        .market-table th {
            background: var(--navy);
            padding: 16px 18px;
            text-align: center;
            font-size: var(--font-caption);
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 700;
        }

        .market-table th.left { text-align: left; }

        .market-table td {
            padding: 16px 18px;
            border-top: 1px solid var(--light-steel);
            font-size: var(--font-body);
            text-align: center;
        }

        .market-table tr:hover td {
            background: var(--light-bg);
        }

        .market-table tr.total-row td {
            background: rgba(27, 54, 93, 0.05);
            font-weight: 600;
        }

        .market-name {
            font-weight: 600;
            color: var(--navy);
            text-align: left !important;
            white-space: nowrap;
        }

        .cell-value {
            font-weight: 700;
            font-size: var(--font-value-sm);
            color: var(--navy);
        }

        .cell-compare-inline {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            margin-top: 4px;
            font-size: var(--font-caption);
            flex-wrap: wrap;
        }

        .cell-compare-label {
            color: var(--text-muted);
            font-weight: 500;
        }

        .cell-compare-value {
            font-weight: 600;
        }

        .cell-compare-value.up { color: var(--positive); }
        .cell-compare-value.down { color: var(--negative); }
        .cell-compare-value.neutral { color: var(--neutral); }

        .cell-divider {
            color: var(--light-steel);
            margin: 0 4px;
        }

        /* Filters */
        .filter-row {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .filter-group label {
            display: block;
            font-size: var(--font-label);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .filter-select {
            background: var(--white);
            border: 2px solid var(--navy);
            color: var(--navy);
            padding: 14px 48px 14px 18px;
            border-radius: 8px;
            font-size: var(--font-body-lg);
            font-weight: 600;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%231B365D' viewBox='0 0 16 16'%3E%3Cpath d='M8 12L2 6h12l-6 6z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            min-width: 200px;
        }

        .filter-select:hover {
            border-color: var(--steel-blue);
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--navy);
            box-shadow: 0 0 0 3px rgba(27, 54, 93, 0.1);
        }

        /* Upload Overlay */
        .upload-overlay {
            position: fixed;
            inset: 0;
            background: rgba(27, 54, 93, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .upload-box {
            background: var(--white);
            border-radius: 16px;
            padding: 48px 64px;
            text-align: center;
            max-width: 480px;
        }

        .upload-logo { margin-bottom: 24px; }
        .upload-logo svg { height: 100px; }

        .upload-box h2 { font-size: var(--font-h1); color: var(--navy); margin-bottom: 8px; }
        .upload-box p { color: var(--text-muted); margin-bottom: 24px; }

        .dropzone {
            border: 2px dashed var(--light-steel);
            border-radius: 12px;
            padding: 32px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 16px;
        }

        .dropzone:hover { border-color: var(--navy); background: var(--light-bg); }
        .dropzone-text { color: var(--text-muted); }
        .dropzone-text span { color: var(--navy); font-weight: 600; }

        .btn-primary {
            background: var(--navy);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            font-size: var(--font-body);
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-primary:hover { background: #152a4a; }

        /* Loading State */
        .loading-state {
            text-align: center;
            padding: 60px;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--light-steel);
            border-top-color: var(--navy);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .loading-text {
            color: var(--text-muted);
            font-size: var(--font-body);
        }

        .main {
            animation: fadeIn 0.4s ease-out;
        }

        .exec-summary .metric-card {
            animation: fadeInUp 0.5s ease-out backwards;
        }

        .exec-summary .metric-card:nth-child(1) { animation-delay: 0.05s; }
        .exec-summary .metric-card:nth-child(2) { animation-delay: 0.1s; }
        .exec-summary .metric-card:nth-child(3) { animation-delay: 0.15s; }
        .exec-summary .metric-card:nth-child(4) { animation-delay: 0.2s; }
        .exec-summary .metric-card:nth-child(5) { animation-delay: 0.25s; }
        .exec-summary .metric-card:nth-child(6) { animation-delay: 0.3s; }
        .exec-summary .metric-card:nth-child(7) { animation-delay: 0.35s; }
        .exec-summary .metric-card:nth-child(8) { animation-delay: 0.4s; }

        /* Chart Container */
        .chart-container {
            background: var(--white);
            border-radius: 12px;
            padding: 28px;
            border: 1px solid var(--light-steel);
            margin-bottom: 24px;
            box-shadow: 0 2px 12px rgba(27, 54, 93, 0.06);
            transition: box-shadow 0.3s ease;
        }

        .chart-container:hover {
            box-shadow: 0 4px 20px rgba(27, 54, 93, 0.12);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--light-steel);
        }

        .chart-title {
            font-size: var(--font-h3);
            font-weight: 700;
            color: var(--navy);
            letter-spacing: -0.3px;
        }

        .chart-legend {
            display: flex;
            gap: 20px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: var(--font-body-sm);
            color: var(--text-muted);
        }

        .legend-dot {
            width: 16px;
            height: 3px;
            border-radius: 2px;
        }

        .legend-dot.solid { background: var(--navy); }
        .legend-dot.dashed { background: repeating-linear-gradient(90deg, var(--steel-blue) 0, var(--steel-blue) 4px, transparent 4px, transparent 8px); }
        .legend-dot.target { background: var(--positive); }

        .chart-svg {
            width: 100%;
            height: 420px;
        }

        /* KPI Hero Card */
        .kpi-hero-card {
            background: var(--white);
            border-radius: 12px;
            padding: 32px;
            border: 1px solid var(--light-steel);
            border-left: 5px solid var(--navy);
            margin-bottom: 24px;
            box-shadow: 0 4px 16px rgba(27, 54, 93, 0.1);
            transition: all 0.3s ease;
        }

        .kpi-hero-card:hover {
            box-shadow: 0 8px 32px rgba(27, 54, 93, 0.15);
        }

        .kpi-hero-card.up { border-left-color: var(--positive); }
        .kpi-hero-card.down { border-left-color: var(--negative); }
        .kpi-hero-card.neutral { border-left-color: var(--neutral); }

        .kpi-hero-label {
            font-size: var(--font-body-sm);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .kpi-hero-content {
            display: flex;
            align-items: stretch;
            gap: 40px;
        }

        .kpi-hero-main {
            flex: 1;
        }

        .kpi-hero-value {
            font-size: var(--font-display);
            font-weight: 700;
            color: var(--navy);
            margin-bottom: 20px;
        }

        .kpi-hero-target {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            background: var(--light-bg);
            border-radius: 12px;
        }

        .kpi-hero-target-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .kpi-hero-target-label {
            font-size: var(--font-caption);
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .kpi-hero-target-detail {
            font-size: var(--font-body);
            color: var(--navy);
            font-weight: 600;
        }

        .kpi-hero-target-badge {
            font-size: var(--font-value-lg);
            font-weight: 700;
            padding: 8px 20px;
            border-radius: 10px;
        }

        .kpi-hero-target-badge.up {
            background: rgba(46, 125, 90, 0.12);
            color: var(--positive);
        }

        .kpi-hero-target-badge.down {
            background: rgba(196, 49, 75, 0.12);
            color: var(--negative);
        }

        .kpi-hero-target-badge.neutral {
            background: rgba(184, 134, 11, 0.12);
            color: var(--neutral);
        }

        .kpi-hero-secondary {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding-left: 40px;
            border-left: 1px solid var(--light-steel);
            justify-content: center;
            min-width: 280px;
        }

        .kpi-hero-row {
            display: flex;
            gap: 24px;
            margin-bottom: 24px;
        }

        .kpi-hero-row .kpi-hero-card {
            flex: 2;
            margin-bottom: 0;
        }

        .market-breakdown-card {
            flex: 1;
            background: var(--white);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--light-steel);
            box-shadow: 0 2px 12px rgba(27, 54, 93, 0.06);
            transition: all 0.3s ease;
        }

        .market-breakdown-card:hover {
            box-shadow: 0 6px 20px rgba(27, 54, 93, 0.12);
        }

        .market-breakdown-title {
            font-size: var(--font-body-sm);
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 20px;
        }

        .breakdown-single-value {
            font-size: var(--font-value-md);
            font-weight: 600;
            color: var(--navy);
            text-align: center;
            padding: 30px 0;
        }

        .market-breakdown-list {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .market-breakdown-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .market-breakdown-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .market-breakdown-name {
            font-size: var(--font-body-sm);
            font-weight: 600;
            color: var(--navy);
        }

        .market-breakdown-value {
            font-size: var(--font-body-sm);
            font-weight: 700;
            color: var(--navy);
        }

        .market-breakdown-bar-bg {
            height: 8px;
            background: var(--light-bg);
            border-radius: 4px;
            overflow: hidden;
        }

        .market-breakdown-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .market-breakdown-bar.bar-1 { background: var(--navy); }
        .market-breakdown-bar.bar-2 { background: var(--steel-blue); }
        .market-breakdown-bar.bar-3 { background: var(--light-steel); }
        .market-breakdown-bar.bar-4 { background: #A8C5DA; }

        .kpi-secondary-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            padding: 16px 20px;
            background: var(--light-bg);
            border-radius: 10px;
        }

        .kpi-secondary-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .kpi-secondary-label {
            font-size: var(--font-body);
            font-weight: 700;
            color: var(--navy);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .kpi-secondary-detail {
            font-size: var(--font-body);
            color: var(--text-muted);
        }

        .kpi-secondary-value {
            font-size: var(--font-value-md);
            font-weight: 700;
        }

        .kpi-secondary-value.up { color: var(--positive); }
        .kpi-secondary-value.down { color: var(--negative); }
        .kpi-secondary-value.neutral { color: var(--neutral); }

        /* Trend Badges */
        .chart-with-badges {
            display: flex;
            gap: 24px;
            align-items: stretch;
        }

        .chart-with-badges .chart-container {
            flex: 3;
            margin-bottom: 0;
        }

        .trend-badges-right {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(6, 1fr);
            gap: 10px;
            background: var(--white);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--light-steel);
        }

        .trend-badge {
            background: var(--light-bg);
            padding: 8px 6px;
            border-radius: 8px;
            text-align: center;
            border: none;
            transition: all 0.2s ease;
        }

        .trend-badge:hover {
            background: var(--white);
            box-shadow: 0 2px 8px rgba(27, 54, 93, 0.12);
            transform: scale(1.02);
        }

        .trend-badge-month {
            font-size: var(--font-label);
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .trend-badge-actual {
            font-size: var(--font-body);
            font-weight: 700;
            color: var(--navy);
            margin-bottom: 4px;
        }

        .trend-badge-value {
            font-size: var(--font-caption);
            font-weight: 600;
        }

        .trend-badge-value.up { color: var(--positive); }
        .trend-badge-value.down { color: var(--negative); }
        .trend-badge-value.neutral { color: var(--neutral); }

        .trend-badge-label {
            font-weight: 400;
            color: var(--text-muted);
            font-size: var(--font-micro);
        }

        /* Modern Table */
        .modern-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .modern-table th {
            padding: 16px 18px;
            text-align: center;
            font-size: var(--font-caption);
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 700;
            background: var(--navy);
        }

        .modern-table th:first-child {
            text-align: left;
            border-radius: 8px 0 0 0;
        }
        .modern-table th:last-child {
            border-radius: 0 8px 0 0;
        }

        .modern-table td {
            padding: 16px;
            font-size: var(--font-body);
            border-bottom: 1px solid rgba(184, 212, 232, 0.4);
            vertical-align: middle;
        }

        .modern-table tr:last-child td {
            border-bottom: none;
        }

        .modern-table tbody tr {
            transition: background 0.2s ease;
        }

        .modern-table tbody tr:hover td {
            background: rgba(143, 175, 212, 0.08);
        }

        .modern-table .market-cell {
            font-weight: 600;
            color: var(--navy);
            white-space: nowrap;
            font-size: var(--font-body);
        }

        .modern-table .value-cell {
            text-align: center;
            font-weight: 700;
            color: var(--navy);
            font-variant-numeric: tabular-nums;
            font-size: var(--font-value-sm);
        }

        .modern-table .compare-cell {
            text-align: center;
        }

        .modern-table .compare-group {
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .modern-table .compare-value {
            color: var(--text-muted);
            font-size: var(--font-body);
            font-variant-numeric: tabular-nums;
        }

        .modern-table .compare-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: var(--font-caption);
            font-weight: 600;
            min-width: 52px;
            text-align: center;
        }

        .modern-table .compare-badge.up {
            background: rgba(46, 125, 90, 0.12);
            color: var(--positive);
        }

        .modern-table .compare-badge.down {
            background: rgba(196, 49, 75, 0.12);
            color: var(--negative);
        }

        .modern-table .compare-badge.neutral {
            background: rgba(184, 134, 11, 0.12);
            color: var(--neutral);
        }

        .modern-table .total-row {
            background: linear-gradient(90deg, rgba(27, 54, 93, 0.05) 0%, transparent 100%);
        }

        .modern-table .total-row td {
            border-top: 2px solid var(--navy);
            border-bottom: none;
            padding-top: 16px;
            padding-bottom: 16px;
        }

        /* Share Bar */
        .share-cell {
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
        }

        .share-value {
            font-weight: 600;
            color: var(--navy);
            min-width: 36px;
            text-align: right;
        }

        .share-bar-bg {
            width: 80px;
            height: 8px;
            background: rgba(184, 212, 232, 0.3);
            border-radius: 4px;
            overflow: hidden;
        }

        .share-bar {
            height: 100%;
            background: var(--navy);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .cell-na {
            color: var(--text-muted);
            font-style: italic;
        }

        /* Tooltip */
        .chart-tooltip {
            position: fixed;
            background: var(--navy);
            color: white;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: var(--font-body-sm);
            pointer-events: none;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
        }

        .chart-tooltip.visible { display: block; }

        .tooltip-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .tooltip-row {
            display: flex;
            justify-content: space-between;
            gap: 16px;
        }

        .tooltip-label { opacity: 0.8; }
        .tooltip-value { font-weight: 600; }

        @media (max-width: 1200px) {
            .exec-summary { grid-template-columns: repeat(2, 1fr); }
            .insights-grid { grid-template-columns: 1fr; }
        }

        @media (max-width: 768px) {
            .header, .main, .nav-tabs { padding-left: 20px; padding-right: 20px; }
            .exec-summary { grid-template-columns: 1fr; }
        }

        /* ============================================
           ENHANCED SCORECARD TABLE STYLES
           ============================================ */

        /* Main Container */
        .scorecard-container {
            background: var(--white);
            border-radius: 16px;
            padding: 32px;
            border: 1px solid var(--light-steel);
            box-shadow: 0 4px 20px rgba(27, 54, 93, 0.08);
        }

        .scorecard-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 28px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--light-steel);
        }

        .scorecard-header-left {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .scorecard-title {
            font-size: var(--font-h2);
            font-weight: 700;
            color: var(--navy);
            letter-spacing: -0.3px;
        }

        .scorecard-subtitle {
            font-size: var(--font-body);
            color: var(--text-muted);
        }

        .scorecard-header-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        .scorecard-legend {
            display: flex;
            gap: 20px;
            align-items: center;
            font-size: var(--font-caption);
            color: var(--text-muted);
        }

        .scorecard-legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .scorecard-legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .scorecard-legend-dot.positive { background: rgba(46, 125, 90, 0.2); border: 2px solid var(--positive); }
        .scorecard-legend-dot.negative { background: rgba(196, 49, 75, 0.2); border: 2px solid var(--negative); }
        .scorecard-legend-dot.neutral { background: rgba(184, 134, 11, 0.2); border: 2px solid var(--neutral); }

        .scorecard-tolerance {
            font-size: var(--font-micro);
            color: var(--text-muted);
            font-style: italic;
            text-align: right;
        }

        /* Table Base */
        .scorecard-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: var(--white);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(27, 54, 93, 0.06);
            border: 1px solid var(--light-steel);
        }

        /* Two-Tier Header Structure */
        .scorecard-table thead tr.header-group th {
            background: var(--navy);
            color: white;
            padding: 12px 16px;
            font-size: var(--font-caption);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            text-align: center;
            border-bottom: 2px solid rgba(255,255,255,0.2);
        }

        .scorecard-table thead tr.header-group th.group-ytd {
            background: var(--navy);
            border-right: 2px solid rgba(255,255,255,0.3);
        }

        .scorecard-table thead tr.header-group th.group-r12m {
            background: #2a4a7a;
        }

        .scorecard-table thead tr.header-group th.kpi-header {
            background: var(--navy);
            border-right: 2px solid rgba(255,255,255,0.3);
        }

        .scorecard-table thead tr.header-columns th {
            background: #f1f5f9;
            color: var(--navy);
            padding: 10px 12px;
            font-size: var(--font-label);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: center;
            border-bottom: 2px solid var(--light-steel);
            position: relative;
            cursor: pointer;
            transition: background 0.2s ease;
            user-select: none;
        }

        .scorecard-table thead tr.header-columns th:hover {
            background: #e2e8f0;
        }

        .scorecard-table thead tr.header-columns th.kpi-col {
            text-align: left;
            padding-left: 20px;
            cursor: default;
            border-right: 2px solid var(--light-steel);
        }

        .scorecard-table thead tr.header-columns th.kpi-col:hover {
            background: #f1f5f9;
        }

        .scorecard-table thead tr.header-columns th.ytd-section {
            border-right: none;
        }

        .scorecard-table thead tr.header-columns th.ytd-section-last {
            border-right: 2px solid var(--light-steel);
        }

        .scorecard-table thead tr.header-columns th.r12m-section {
            background: #f8fafc;
        }

        .scorecard-table thead tr.header-columns th.r12m-section:hover {
            background: #eef2f6;
        }

        /* Sort Indicators */
        .sort-indicator {
            display: inline-block;
            margin-left: 4px;
            opacity: 0.4;
            font-size: 10px;
        }

        .scorecard-table thead th.sorted .sort-indicator {
            opacity: 1;
        }

        .scorecard-table thead th.sorted-asc .sort-indicator::after { content: '▲'; }
        .scorecard-table thead th.sorted-desc .sort-indicator::after { content: '▼'; }
        .scorecard-table thead th:not(.sorted) .sort-indicator::after { content: '⇅'; }

        /* Table Body Rows */
        .scorecard-table tbody tr {
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .scorecard-table tbody tr:hover {
            background: rgba(143, 175, 212, 0.08);
        }

        .scorecard-table tbody tr:hover td.kpi-name-cell {
            color: var(--steel-blue);
        }

        /* Table Cells Base */
        .scorecard-table tbody td {
            padding: 16px 12px;
            border-bottom: 1px solid rgba(184, 212, 232, 0.5);
            font-size: var(--font-body);
            text-align: center;
            vertical-align: middle;
            transition: background 0.2s ease;
        }

        .scorecard-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Order Cell with Status Indicator */
        .scorecard-table tbody td.order-cell {
            position: relative;
            width: 50px;
            min-width: 50px;
            text-align: center;
            font-weight: 600;
            color: var(--text-muted);
            font-size: var(--font-body-sm);
            background: rgba(248, 250, 252, 0.5);
            border-right: 1px solid rgba(184, 212, 232, 0.5);
        }

        .scorecard-table tbody td.order-cell::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--light-steel);
            transition: background 0.2s ease;
        }

        .scorecard-table tbody tr.status-positive td.order-cell::before {
            background: var(--positive);
        }

        .scorecard-table tbody tr.status-warning td.order-cell::before {
            background: var(--neutral);
        }

        .scorecard-table tbody tr.status-negative td.order-cell::before {
            background: var(--negative);
        }

        /* KPI Name Cell */
        .scorecard-table tbody td.kpi-name-cell {
            text-align: left;
            padding-left: 24px;
            font-weight: 600;
            color: var(--navy);
            white-space: nowrap;
            border-right: 2px solid rgba(184, 212, 232, 0.5);
            background: rgba(248, 250, 252, 0.5);
        }

        /* Value Cells */
        .scorecard-table tbody td.value-cell {
            font-weight: 700;
            color: var(--navy);
            font-variant-numeric: tabular-nums;
            font-size: var(--font-value-sm);
        }

        .scorecard-table tbody td.value-cell .value-main {
            display: block;
        }

        /* Section Divider */
        .scorecard-table tbody td.section-divider {
            border-right: 2px solid rgba(184, 212, 232, 0.5);
        }

        /* R12M Section Cells */
        .scorecard-table tbody td.r12m-section {
            background: rgba(248, 250, 252, 0.3);
        }

        /* ============================================
           VARIANCE CELLS WITH BACKGROUND TINTING
           ============================================ */
        .scorecard-table tbody td.variance-cell {
            font-weight: 600;
            font-variant-numeric: tabular-nums;
            position: relative;
            padding: 12px 10px;
        }

        .variance-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .variance-main {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: var(--font-body);
            font-weight: 600;
        }

        .variance-arrow {
            font-size: 12px;
            line-height: 1;
        }

        .variance-arrow.arrow-up {
            color: var(--positive);
        }

        .variance-arrow.arrow-down {
            color: var(--negative);
        }

        .variance-arrow.arrow-neutral {
            color: var(--neutral);
        }

        /* Order/Rank Column */
        .scorecard-table thead th.order-header {
            width: 50px;
            min-width: 50px;
            text-align: center;
            border-right: 2px solid rgba(255,255,255,0.3);
        }

        .variance-context {
            font-size: var(--font-micro);
            color: var(--text-muted);
            font-weight: 500;
        }

        /* Positive Variance Styling */
        .variance-cell.positive {
            background: rgba(46, 125, 90, 0.08);
        }

        .variance-cell.positive .variance-main {
            color: var(--positive);
        }

        .variance-cell.positive-strong {
            background: rgba(46, 125, 90, 0.15);
        }

        .variance-cell.positive-strong .variance-main {
            color: #1d5c3e;
        }

        /* Negative Variance Styling */
        .variance-cell.negative {
            background: rgba(196, 49, 75, 0.08);
        }

        .variance-cell.negative .variance-main {
            color: var(--negative);
        }

        .variance-cell.negative-strong {
            background: rgba(196, 49, 75, 0.15);
        }

        .variance-cell.negative-strong .variance-main {
            color: #9c2a3e;
        }

        /* Neutral Variance Styling */
        .variance-cell.neutral {
            background: rgba(184, 134, 11, 0.05);
        }

        .variance-cell.neutral .variance-main {
            color: var(--neutral);
        }

        /* ============================================
           VS TARGET PROGRESS BAR
           ============================================ */
        .target-cell {
            padding: 10px 12px;
        }

        .target-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .target-variance {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: var(--font-body);
            font-weight: 600;
        }

        .target-bar-container {
            width: 100%;
            max-width: 80px;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            position: relative;
        }

        .target-bar {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .target-bar.achieved {
            background: linear-gradient(90deg, var(--positive), #3d9970);
        }

        .target-bar.close {
            background: linear-gradient(90deg, var(--neutral), #d4a017);
        }

        .target-bar.behind {
            background: linear-gradient(90deg, var(--negative), #d35d6e);
        }

        .target-context {
            font-size: var(--font-micro);
            color: var(--text-muted);
            font-weight: 500;
        }

        /* ============================================
           TOOLTIP STYLES
           ============================================ */
        .scorecard-tooltip {
            position: fixed;
            background: var(--navy);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: var(--font-body-sm);
            pointer-events: none;
            z-index: 1000;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            display: none;
            max-width: 280px;
        }

        .scorecard-tooltip.visible {
            display: block;
        }

        .scorecard-tooltip-title {
            font-weight: 700;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .scorecard-tooltip-row {
            display: flex;
            justify-content: space-between;
            gap: 16px;
            margin-bottom: 4px;
        }

        .scorecard-tooltip-row:last-child {
            margin-bottom: 0;
        }

        .scorecard-tooltip-label {
            opacity: 0.8;
        }

        .scorecard-tooltip-value {
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }

        /* ============================================
           FOOTER HINTS & LEGEND
           ============================================ */
        .scorecard-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--light-steel);
        }

        .scorecard-click-hint {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: var(--font-caption);
            color: var(--text-muted);
        }

        .scorecard-click-hint svg {
            width: 16px;
            height: 16px;
            opacity: 0.7;
        }

        .scorecard-sort-hint {
            font-size: var(--font-caption);
            color: var(--text-muted);
            font-style: italic;
        }

        /* ============================================
           RESPONSIVE ADJUSTMENTS
           ============================================ */
        @media (max-width: 1200px) {
            .scorecard-table tbody td,
            .scorecard-table thead tr.header-columns th {
                padding: 12px 8px;
                font-size: var(--font-body-sm);
            }

            .variance-context,
            .target-context {
                display: none;
            }
        }

        /* ============================================
           MARKET COMPARISON STYLES
           ============================================ */

        /* Market Rankings Widget (Summary Tab) */
        .market-rankings-widget {
            background: var(--white);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--light-steel);
        }

        .market-rankings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .market-rankings-title {
            font-size: var(--font-h3);
            font-weight: 700;
            color: var(--navy);
        }

        .market-rankings-subtitle {
            font-size: var(--font-caption);
            color: var(--text-muted);
            margin-top: 2px;
        }

        .market-rankings-link {
            font-size: var(--font-body-sm);
            color: var(--navy);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: opacity 0.2s;
        }

        .market-rankings-link:hover {
            opacity: 0.7;
        }

        .market-rank-item {
            display: grid;
            grid-template-columns: 32px 140px 1fr 100px 70px;
            align-items: center;
            gap: 16px;
            padding: 14px 0;
            border-bottom: 1px solid rgba(184, 212, 232, 0.3);
        }

        .market-rank-item:last-child {
            border-bottom: none;
        }

        .market-rank-position {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: var(--font-body-sm);
        }

        .market-rank-position.rank-1 {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: white;
        }

        .market-rank-position.rank-2 {
            background: linear-gradient(135deg, #C0C0C0, #A0A0A0);
            color: white;
        }

        .market-rank-position.rank-3 {
            background: linear-gradient(135deg, #CD7F32, #B87333);
            color: white;
        }

        .market-rank-position.rank-other {
            background: var(--light-bg);
            color: var(--text-muted);
        }

        .market-rank-name {
            font-weight: 600;
            color: var(--navy);
            font-size: var(--font-body);
        }

        .market-rank-bar-container {
            height: 24px;
            background: rgba(184, 212, 232, 0.2);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .market-rank-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
            position: relative;
        }

        .market-rank-bar.positive {
            background: linear-gradient(90deg, var(--positive), var(--positive-soft));
        }

        .market-rank-bar.negative {
            background: linear-gradient(90deg, var(--negative), var(--negative-soft));
        }

        .market-rank-bar.neutral {
            background: linear-gradient(90deg, var(--navy), var(--steel-blue));
        }

        .market-rank-value {
            font-weight: 700;
            color: var(--navy);
            font-size: var(--font-body);
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        .market-rank-change {
            font-weight: 600;
            font-size: var(--font-body-sm);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .market-rank-change.up { color: var(--positive); }
        .market-rank-change.down { color: var(--negative); }
        .market-rank-change.neutral { color: var(--neutral); }

        /* Market Comparison Page Layout */
        .market-comparison-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
        }

        .market-comparison-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 20px;
        }

        .market-comparison-filters {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        /* Comparison Bars Section */
        .comparison-bars-card {
            background: var(--white);
            border-radius: 16px;
            padding: 28px;
            border: 1px solid var(--light-steel);
        }

        .comparison-bars-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .comparison-bars-title {
            font-size: var(--font-h2);
            font-weight: 700;
            color: var(--navy);
        }

        .comparison-bars-toggles {
            display: flex;
            gap: 4px;
            background: var(--light-bg);
            padding: 4px;
            border-radius: 8px;
        }

        .comparison-toggle {
            padding: 8px 16px;
            font-size: var(--font-body-sm);
            font-weight: 500;
            color: var(--text-muted);
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .comparison-toggle.active {
            background: var(--white);
            color: var(--navy);
            font-weight: 600;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .comparison-toggle:hover:not(.active) {
            color: var(--navy);
        }

        .comparison-bar-row {
            display: grid;
            grid-template-columns: 140px 1fr 110px 80px;
            align-items: center;
            gap: 20px;
            padding: 16px 0;
            border-bottom: 1px solid rgba(184, 212, 232, 0.25);
        }

        .comparison-bar-row:last-child {
            border-bottom: none;
        }

        .comparison-bar-market {
            font-weight: 600;
            color: var(--navy);
            font-size: var(--font-body);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .comparison-bar-rank {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--light-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-caption);
            font-weight: 700;
            color: var(--text-muted);
        }

        .comparison-bar-rank.rank-1 { background: linear-gradient(135deg, #FFD700, #FFA500); color: white; }
        .comparison-bar-rank.rank-2 { background: linear-gradient(135deg, #C0C0C0, #A0A0A0); color: white; }
        .comparison-bar-rank.rank-3 { background: linear-gradient(135deg, #CD7F32, #B87333); color: white; }

        .comparison-bar-track {
            height: 32px;
            background: rgba(184, 212, 232, 0.15);
            border-radius: 6px;
            position: relative;
            overflow: hidden;
        }

        .comparison-bar-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.6s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 12px;
            min-width: 60px;
        }

        .comparison-bar-fill.positive {
            background: linear-gradient(90deg, rgba(46, 125, 90, 0.85), rgba(61, 153, 112, 0.85));
        }

        .comparison-bar-fill.negative {
            background: linear-gradient(90deg, rgba(196, 49, 75, 0.85), rgba(211, 93, 110, 0.85));
        }

        .comparison-bar-fill.neutral {
            background: linear-gradient(90deg, rgba(27, 54, 93, 0.85), rgba(143, 175, 212, 0.85));
        }

        .comparison-bar-fill-label {
            color: white;
            font-size: var(--font-caption);
            font-weight: 600;
            white-space: nowrap;
        }

        .comparison-bar-value {
            font-weight: 700;
            color: var(--navy);
            font-size: var(--font-value-sm);
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        .comparison-bar-change {
            font-weight: 600;
            font-size: var(--font-body);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .comparison-bar-change.up { color: var(--positive); }
        .comparison-bar-change.down { color: var(--negative); }
        .comparison-bar-change.neutral { color: var(--neutral); }

        .comparison-bar-axis {
            display: flex;
            justify-content: space-between;
            padding: 12px 0 0 160px;
            margin-right: 210px;
            border-top: 1px solid var(--light-steel);
            margin-top: 8px;
        }

        .comparison-bar-axis-label {
            font-size: var(--font-caption);
            color: var(--text-muted);
            font-variant-numeric: tabular-nums;
        }

        /* Gap Analysis Section */
        .gap-analysis-card {
            background: var(--white);
            border-radius: 16px;
            padding: 28px;
            border: 1px solid var(--light-steel);
        }

        .gap-analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .gap-analysis-title {
            font-size: var(--font-h3);
            font-weight: 700;
            color: var(--navy);
        }

        .gap-analysis-benchmark {
            font-size: var(--font-body-sm);
            color: var(--text-muted);
        }

        .gap-analysis-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }

        .gap-analysis-item {
            background: var(--light-bg);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .gap-analysis-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(27, 54, 93, 0.1);
        }

        .gap-analysis-market {
            font-weight: 600;
            color: var(--navy);
            font-size: var(--font-body);
            margin-bottom: 12px;
        }

        .gap-analysis-value {
            font-size: var(--font-value-lg);
            font-weight: 700;
            margin-bottom: 6px;
        }

        .gap-analysis-value.above { color: var(--positive); }
        .gap-analysis-value.below { color: var(--negative); }
        .gap-analysis-value.at { color: var(--neutral); }

        .gap-analysis-label {
            font-size: var(--font-caption);
            color: var(--text-muted);
        }

        /* Trend Comparison Section */
        .trend-comparison-card {
            background: var(--white);
            border-radius: 16px;
            padding: 28px;
            border: 1px solid var(--light-steel);
        }

        .trend-comparison-title {
            font-size: var(--font-h3);
            font-weight: 700;
            color: var(--navy);
            margin-bottom: 24px;
        }

        .trend-comparison-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        .trend-card {
            background: var(--light-bg);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .trend-card-market {
            font-weight: 600;
            color: var(--navy);
            font-size: var(--font-body);
            margin-bottom: 16px;
        }

        .trend-card-sparkline {
            height: 60px;
            margin-bottom: 12px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 3px;
        }

        .trend-card-sparkline svg {
            width: 100%;
            height: 60px;
        }

        .trend-card-change {
            font-size: var(--font-body);
            font-weight: 700;
        }

        .trend-card-change.up { color: var(--positive); }
        .trend-card-change.down { color: var(--negative); }
        .trend-card-change.neutral { color: var(--neutral); }

        .trend-card-label {
            font-size: var(--font-caption);
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Quick Stats Row */
        .quick-stats-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .quick-stat-card {
            background: var(--white);
            border-radius: 12px;
            padding: 20px 24px;
            border: 1px solid var(--light-steel);
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .quick-stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .quick-stat-icon.leader {
            background: rgba(46, 125, 90, 0.12);
            color: var(--positive);
        }

        .quick-stat-icon.laggard {
            background: rgba(196, 49, 75, 0.12);
            color: var(--negative);
        }

        .quick-stat-icon.gap {
            background: rgba(27, 54, 93, 0.08);
            color: var(--navy);
        }

        .quick-stat-content {
            flex: 1;
        }

        .quick-stat-label {
            font-size: var(--font-caption);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .quick-stat-value {
            font-size: var(--font-body-lg);
            font-weight: 700;
            color: var(--navy);
        }

        .quick-stat-detail {
            font-size: var(--font-caption);
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* Multi-KPI Matrix */
        .kpi-matrix-card {
            background: var(--white);
            border-radius: 16px;
            padding: 28px;
            border: 1px solid var(--light-steel);
        }

        .kpi-matrix-title {
            font-size: var(--font-h3);
            font-weight: 700;
            color: var(--navy);
            margin-bottom: 24px;
        }

        .kpi-matrix-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .kpi-matrix-table th {
            padding: 14px 12px;
            text-align: center;
            font-size: var(--font-caption);
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 700;
            background: var(--navy);
        }

        .kpi-matrix-table th:first-child {
            text-align: left;
            border-radius: 8px 0 0 0;
            min-width: 160px;
        }

        .kpi-matrix-table th:last-child {
            border-radius: 0 8px 0 0;
        }

        .kpi-matrix-table td {
            padding: 14px 12px;
            font-size: var(--font-body-sm);
            border-bottom: 1px solid rgba(184, 212, 232, 0.3);
            vertical-align: middle;
        }

        .kpi-matrix-table tr:last-child td {
            border-bottom: none;
        }

        .kpi-matrix-kpi-cell {
            font-weight: 600;
            color: var(--navy);
        }

        .kpi-matrix-value-cell {
            text-align: center;
        }

        .kpi-matrix-mini-bar {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .kpi-matrix-rank-badge {
            font-size: var(--font-micro);
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 10px;
            color: white;
        }

        .kpi-matrix-rank-badge.rank-1 { background: linear-gradient(135deg, #FFD700, #FFA500); }
        .kpi-matrix-rank-badge.rank-2 { background: linear-gradient(135deg, #C0C0C0, #A0A0A0); }
        .kpi-matrix-rank-badge.rank-3 { background: linear-gradient(135deg, #CD7F32, #B87333); }
        .kpi-matrix-rank-badge.rank-4 { background: var(--light-steel); color: var(--text-muted); }

        .kpi-matrix-bar-wrapper {
            width: 100%;
            max-width: 80px;
            height: 6px;
            background: rgba(184, 212, 232, 0.3);
            border-radius: 3px;
            overflow: hidden;
            margin: 0 auto;
        }

        .kpi-matrix-bar-fill {
            height: 100%;
            border-radius: 3px;
            background: var(--navy);
        }

        .kpi-matrix-variance {
            font-size: var(--font-caption);
            font-weight: 600;
        }

        .kpi-matrix-variance.up { color: var(--positive); }
        .kpi-matrix-variance.down { color: var(--negative); }
        .kpi-matrix-variance.neutral { color: var(--neutral); }

        @media (max-width: 1200px) {
            .gap-analysis-grid,
            .trend-comparison-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .quick-stats-row {
                grid-template-columns: 1fr;
            }

            .market-rank-item {
                grid-template-columns: 32px 100px 1fr 80px 60px;
                gap: 12px;
            }

            .comparison-bar-row {
                grid-template-columns: 120px 1fr 90px 70px;
                gap: 12px;
            }

            .market-comparison-layout > div[style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }
        }

        @media (max-width: 768px) {
            .gap-analysis-grid,
            .trend-comparison-grid {
                grid-template-columns: 1fr;
            }

            .market-rank-item {
                grid-template-columns: 28px 80px 1fr;
            }

            .market-rank-value,
            .market-rank-change {
                display: none;
            }

            .comparison-bar-row {
                grid-template-columns: 100px 1fr;
            }

            .comparison-bar-value,
            .comparison-bar-change {
                display: none;
            }

            .kpi-matrix-table {
                font-size: var(--font-caption);
            }

            .kpi-matrix-table th,
            .kpi-matrix-table td {
                padding: 8px 6px;
            }
        }
    </style>
</head>
<body>
    <div id="app"></div>
    <div class="chart-tooltip" id="chartTooltip"></div>
    <div class="scorecard-tooltip" id="scorecardTooltip"></div>

    <script>
    (function() {
        const MONTHS = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
        const MONTH_MAP = {
            '01 - Jan':'JAN','02 - Feb':'FEB','03 - Mar':'MAR','04 - Apr':'APR','05 - May':'MAY','06 - Jun':'JUN',
            '07 - Jul':'JUL','08 - Aug':'AUG','09 - Sep':'SEP','10 - Oct':'OCT','11 - Nov':'NOV','12 - Dec':'DEC',
            '01-Jan':'JAN','02-Feb':'FEB','03-Mar':'MAR','04-Apr':'APR','05-May':'MAY','06-Jun':'JUN',
            '07-Jul':'JUL','08-Aug':'AUG','09-Sep':'SEP','10-Oct':'OCT','11-Nov':'NOV','12-Dec':'DEC',
            'Jan-24':'JAN','Feb-24':'FEB','Mar-24':'MAR','Apr-24':'APR','May-24':'MAY','Jun-24':'JUN',
            'Jul-24':'JUL','Aug-24':'AUG','Sep-24':'SEP','Oct-24':'OCT','Nov-24':'NOV','Dec-24':'DEC',
            'Jan-25':'JAN','Feb-25':'FEB','Mar-25':'MAR','Apr-25':'APR','May-25':'MAY','Jun-25':'JUN',
            'Jul-25':'JUL','Aug-25':'AUG','Sep-25':'SEP','Oct-25':'OCT','Nov-25':'NOV','Dec-25':'DEC',
            'Jan':'JAN','Feb':'FEB','Mar':'MAR','Apr':'APR','May':'MAY','Jun':'JUN',
            'Jul':'JUL','Aug':'AUG','Sep':'SEP','Oct':'OCT','Nov':'NOV','Dec':'DEC',
            '1':'JAN','2':'FEB','3':'MAR','4':'APR','5':'MAY','6':'JUN',
            '7':'JUL','8':'AUG','9':'SEP','10':'OCT','11':'NOV','12':'DEC',
            'JAN':'JAN','FEB':'FEB','MAR':'MAR','APR':'APR','MAY':'MAY','JUN':'JUN',
            'JUL':'JUL','AUG':'AUG','SEP':'SEP','OCT':'OCT','NOV':'NOV','DEC':'DEC'
        };

        // MUSE KPI configurations
        const KPI_CONFIG = {
            'SLS_TTL': { name: 'Total Sales', format: 'currency', good: 'up', hasShare: true },
            'SLS_PEN': { name: 'Sales Penetration', format: 'percent', good: 'up', hasShare: false },
            'MBR_TTL': { name: 'Transacting Members', format: 'number', good: 'up', hasShare: true },
            'MBR_NEW': { name: 'New Members', format: 'number', good: 'up', hasShare: true },
            'MBR_RTN': { name: 'Returning Members', format: 'number', good: 'up', hasShare: true },
            'AVG_ATF': { name: 'Avg Frequency', format: 'decimal', good: 'up', hasShare: false },
            'AVG_AOV': { name: 'Avg Order Value', format: 'currency_small', good: 'up', hasShare: false },
            'PCT_RDM': { name: 'Redeeming Members %', format: 'percent', good: 'up', loyalty: true, hasShare: false },
            'PCT_XBP': { name: 'Cross Brand Plus %', format: 'percent', good: 'up', loyalty: true, hasShare: false },
            'PCT_NBA': { name: 'New Brand Adopters %', format: 'percent', good: 'up', loyalty: true, hasShare: false },
            'AVG_BRD': { name: 'Avg Brands Shopped', format: 'decimal', good: 'up', hasShare: false },
            'PTS_BRN': { name: 'Points Burned Value', format: 'currency', good: 'up', hasShare: true }
        };

        // Map human-readable KPI names to internal keys
        const KPI_NAME_MAP = {
            'Total Sales': 'SLS_TTL',
            'Sales Penetration': 'SLS_PEN',
            'Transacting Members': 'MBR_TTL',
            'New Members': 'MBR_NEW',
            'Returning Members': 'MBR_RTN',
            'Avg Frequency': 'AVG_ATF',
            'Average Frequency': 'AVG_ATF',
            'Avg Order Value': 'AVG_AOV',
            'Average Order Value': 'AVG_AOV',
            'AOV': 'AVG_AOV',
            'Redeeming Members %': 'PCT_RDM',
            'Redeeming Members': 'PCT_RDM',
            'Cross Brand Plus %': 'PCT_XBP',
            'Cross Brand Plus': 'PCT_XBP',
            'New Brand Adopters %': 'PCT_NBA',
            'New Brand Adopters': 'PCT_NBA',
            'Avg Brands Shopped': 'AVG_BRD',
            'Average Brands Shopped': 'AVG_BRD',
            'Points Burned Value': 'PTS_BRN',
            'Points Burned': 'PTS_BRN'
        };

        // Preferred market order
        const PREFERRED_MARKET_ORDER = ['All', 'All Markets', 'United Arab Emirates', 'Saudi Arabia', 'Kuwait', 'Bahrain', 'Qatar', 'Oman', 'Egypt', 'Jordan', 'Lebanon'];

        // Company Logo
        const LOGO_SVG = `<img src="logo.png" alt="Company Logo" style="height: 60px; width: auto;" onerror="this.style.display='none'">`;

        // Year configuration
        const CURRENT_YEAR = 2025;
        const PREVIOUS_YEAR = 2024;

        // CSV files to try for auto-detection (in order of preference)
        const CSV_FILES_TO_TRY = [
            'muse_data.csv',
            'data.csv',
            'muse.csv',
            'kpi_data.csv'
        ];

        let state = {
            data: null,
            selectedMarket: null,
            selectedKPI: null,
            selectedKPIMonth: null,
            activeTab: 'summary',
            dataLoaded: false,
            loading: true,
            autoDetectFailed: false,
            scorecardMarket: null,
            scorecardMonth: null,
            scorecardSort: { column: null, direction: 'asc' },
            // Market Comparison state
            marketCompareKPI: 'SLS_TTL',
            marketCompareMonth: null,
            marketCompareMode: 'vsLY' // 'vsLY', 'vsTarget', 'absolute'
        };

        // Helper functions
        function isAggregateValue(value, dimension) {
            if (value === null) return true;
            if (dimension === 'market') {
                return value === 'All' || value === 'All Markets';
            }
            return false;
        }

        function getAggregateValue(dimension) {
            if (!state.data) return 'All';
            if (dimension === 'market') {
                const markets = [...new Set(state.data.map(d => d.Market))];
                if (markets.includes('All')) return 'All';
                if (markets.includes('All Markets')) return 'All Markets';
                return markets[0];
            }
            return 'All';
        }

        function getMarkets() {
            if (!state.data) return [];
            const markets = [...new Set(state.data.map(d => d.Market))].filter(m => m);
            return markets.sort((a, b) => {
                const aIsAgg = isAggregateValue(a, 'market');
                const bIsAgg = isAggregateValue(b, 'market');
                if (aIsAgg && !bIsAgg) return -1;
                if (!aIsAgg && bIsAgg) return 1;
                const aIdx = PREFERRED_MARKET_ORDER.indexOf(a);
                const bIdx = PREFERRED_MARKET_ORDER.indexOf(b);
                if (aIdx !== -1 && bIdx !== -1) return aIdx - bIdx;
                if (aIdx !== -1) return -1;
                if (bIdx !== -1) return 1;
                return a.localeCompare(b);
            });
        }

        function getKPIs() {
            if (!state.data) return [];
            return [...new Set(state.data.map(d => d.Key))].filter(k => KPI_CONFIG[k]);
        }

        function formatValue(value, format) {
            if (value === null || value === undefined || isNaN(value)) return '—';
            switch(format) {
                case 'currency':
                    if (value >= 1e9) return '$' + (value/1e9).toFixed(2) + 'B';
                    if (value >= 1e6) return '$' + (value/1e6).toFixed(1) + 'M';
                    if (value >= 1e3) return '$' + (value/1e3).toFixed(0) + 'K';
                    return '$' + value.toFixed(0);
                case 'currency_small':
                    return '$' + value.toFixed(0);
                case 'percent':
                    return (value * 100).toFixed(1) + '%';
                case 'number':
                    if (value >= 1e6) return (value/1e6).toFixed(2) + 'M';
                    if (value >= 1e3) return (value/1e3).toFixed(0) + 'K';
                    return value.toLocaleString();
                case 'decimal':
                    return value.toFixed(2);
                default:
                    return value.toString();
            }
        }

        function calcChange(current, previous, format) {
            if (!current || !previous || previous === 0) return null;
            if (format === 'percent') {
                const curr = parseFloat((current * 100).toFixed(1));
                const prev = parseFloat((previous * 100).toFixed(1));
                return curr - prev;
            }
            return ((current / previous) - 1) * 100;
        }

        function calcTargetGap(current, target, format) {
            if (!current || !target || target === 0) return null;
            if (format === 'percent') {
                const curr = parseFloat((current * 100).toFixed(1));
                const tgt = parseFloat((target * 100).toFixed(1));
                return curr - tgt;
            }
            return ((current / target) - 1) * 100;
        }

        function formatChange(change, format) {
            if (change === null) return '—';
            const sign = change >= 0 ? '+' : '';
            if (format === 'percent') {
                return sign + change.toFixed(1) + ' PP';
            }
            return sign + change.toFixed(1) + '%';
        }

        function getChangeClass(change, format) {
            if (change === null) return '';
            const threshold = format === 'percent' ? 0.1 : 1;
            if (Math.abs(change) < threshold) return 'neutral';
            return change >= 0 ? 'up' : 'down';
        }

        // Parse CSV
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                if (values.length < 3) continue;
                const row = {};
                headers.forEach((h, idx) => {
                    let val = values[idx]?.trim();
                    if (['YTD', 'LYTD', 'R12M', 'LMR12M', 'Target'].includes(h)) {
                        row[h] = val === '' || val === undefined ? null : parseFloat(val);
                    } else if (h === 'KPI') {
                        row['Key'] = KPI_NAME_MAP[val] || val;
                    } else if (h === 'Key') {
                        row['Key'] = val;
                    } else if (h === 'Month') {
                        if (val && val.match(/^\d{2}-[A-Za-z]{3}$/)) {
                            val = val.replace('-', ' - ');
                        }
                        row[h] = val;
                    } else {
                        row[h] = val;
                    }
                });
                if (!row.BU) row.BU = 'MUSE';
                if (row.Market && row.Key) data.push(row);
            }
            return data;
        }

        // Get latest data
        function getLatestData(market, kpiKey) {
            if (!state.data) return null;
            let rows = state.data.filter(d => d.Market === market && d.Key === kpiKey);
            const decRow = rows.find(d =>
                d.Month === '12 - Dec' ||
                d.Month === 'Dec-25' ||
                d.Month?.includes('Dec')
            );
            return decRow || rows[rows.length - 1];
        }

        // Get monthly data
        function getMonthlyData(market, kpiKey) {
            if (!state.data) return [];
            let rows = state.data.filter(d => d.Market === market && d.Key === kpiKey);
            return rows.sort((a, b) => (a.Month || '').localeCompare(b.Month || ''));
        }

        // Icons
        const METRIC_ICONS = {
            'SLS_TTL': '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>',
            'MBR_TTL': '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
            'AVG_AOV': '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>',
            'AVG_ATF': '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
            'SLS_PEN': '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>',
            'PCT_NBA': '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>',
            'PCT_XBP': '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>',
            'PCT_RDM': '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 12v10H4V12"/><path d="M2 7h20v5H2z"/><path d="M12 22V7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/></svg>'
        };

        // Render functions
        function render() {
            const app = document.getElementById('app');
            if (state.loading) {
                app.innerHTML = renderLoading();
            } else if (!state.dataLoaded) {
                app.innerHTML = renderUpload();
            } else {
                app.innerHTML = renderDashboard();
            }
            attachEvents();
        }

        function renderLoading() {
            return `
                <div class="upload-overlay">
                    <div class="upload-box">
                        <div class="upload-logo">${LOGO_SVG}</div>
                        <div class="loading-state">
                            <div class="loading-spinner"></div>
                            <div class="loading-text">Auto-detecting data file...</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderUpload() {
            return `
                <div class="upload-overlay">
                    <div class="upload-box">
                        <div class="upload-logo">${LOGO_SVG}</div>
                        <h2>MUSE Performance Review</h2>
                        <p>No data file found. Please upload a CSV file.</p>
                        <div class="dropzone" id="dropzone">
                            <input type="file" id="fileInput" accept=".csv" style="display:none">
                            <p class="dropzone-text"><span>Click to browse</span> or drag and drop</p>
                            <p class="dropzone-text" style="font-size: 12px; margin-top: 8px;">Supports .csv files</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDashboard() {
            return `
                <header class="header">
                    <div class="header-left">
                        <div class="logo-container">${LOGO_SVG}</div>
                        <div class="header-text">
                            <h1>${CURRENT_YEAR} MUSE Performance Review</h1>
                            <p>Year-over-Year Analysis | Loyalty Dashboard</p>
                        </div>
                    </div>
                    <span class="header-badge">MUSE</span>
                </header>
                <nav class="nav-tabs">
                    <div class="nav-tab ${state.activeTab === 'summary' ? 'active' : ''}" data-tab="summary">Executive Summary</div>
                    <div class="nav-tab ${state.activeTab === 'scorecard' ? 'active' : ''}" data-tab="scorecard">Scorecard</div>
                    <div class="nav-tab ${state.activeTab === 'markets' ? 'active' : ''}" data-tab="markets">Market Comparison</div>
                    <div class="nav-tab ${state.activeTab === 'kpi' ? 'active' : ''}" data-tab="kpi">KPI Deep Dive</div>
                </nav>
                <main class="main">
                    ${state.activeTab === 'summary' ? renderSummaryTab() : ''}
                    ${state.activeTab === 'scorecard' ? renderScorecardTab() : ''}
                    ${state.activeTab === 'markets' ? renderMarketsTab() : ''}
                    ${state.activeTab === 'kpi' ? renderKPITab() : ''}
                </main>
            `;
        }

        function renderSummaryTab() {
            const market = getAggregateValue('market');
            const allKPIs = ['SLS_TTL', 'MBR_TTL', 'AVG_AOV', 'AVG_ATF', 'SLS_PEN', 'PCT_NBA', 'PCT_XBP', 'PCT_RDM'];

            return `
                <div class="section-header">
                    <div>
                        <div class="section-title">Key Performance Indicators</div>
                        <div class="section-subtitle">Full Year ${CURRENT_YEAR} vs ${PREVIOUS_YEAR} | ${market}</div>
                    </div>
                </div>
                <div class="exec-summary">
                    ${allKPIs.map(key => renderMetricCard(market, key)).join('')}
                </div>

                ${renderMarketRankingsWidget()}
            `;
        }

        function renderMetricCard(market, kpiKey) {
            const config = KPI_CONFIG[kpiKey];
            const data = getLatestData(market, kpiKey);
            if (!data || !config) return '';

            const changeVsLY = calcChange(data.YTD, data.LYTD, config.format);
            const targetGap = data.Target ? calcTargetGap(data.YTD, data.Target, config.format) : null;

            const arrowUp = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 15l-6-6-6 6"/></svg>';
            const arrowDown = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M6 9l6 6 6-6"/></svg>';
            const arrowNeutral = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14"/></svg>';

            let targetRow = '';
            if (data.Target) {
                const gapClass = getChangeClass(targetGap, config.format);
                targetRow = `
                    <div class="metric-target-row">
                        <div class="metric-target-left">
                            <span>Target:</span>
                            <span class="metric-target-val">${formatValue(data.Target, config.format)}</span>
                        </div>
                        <span class="metric-target-badge ${gapClass}">${formatChange(targetGap, config.format)}</span>
                    </div>
                `;
            }

            const vsLYClass = getChangeClass(changeVsLY, config.format);
            const vsArrow = vsLYClass === 'up' ? arrowUp : (vsLYClass === 'down' ? arrowDown : arrowNeutral);

            return `
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-icon">${METRIC_ICONS[kpiKey] || ''}</div>
                        <div class="metric-label">${config.name}</div>
                    </div>
                    <div class="metric-value">${formatValue(data.YTD, config.format)}</div>
                    ${targetRow}
                    <div class="metric-vs-row">
                        <span class="metric-vs-arrow ${vsLYClass}">
                            ${vsArrow}
                            ${formatChange(changeVsLY, config.format)}
                        </span>
                        <span>vs LY</span>
                    </div>
                </div>
            `;
        }

        function renderMarketRankingsWidget() {
            const markets = getMarkets();
            const config = KPI_CONFIG['SLS_TTL'];

            // Get individual markets sorted by Sales YTD
            const marketData = markets
                .filter(m => !isAggregateValue(m, 'market'))
                .map(m => {
                    const data = getLatestData(m, 'SLS_TTL');
                    const change = data ? calcChange(data.YTD, data.LYTD, config.format) : null;
                    return {
                        market: m,
                        value: data?.YTD || 0,
                        change: change,
                        changeClass: getChangeClass(change, config.format)
                    };
                })
                .sort((a, b) => b.value - a.value);

            const maxValue = marketData[0]?.value || 1;

            return `
                <div class="market-rankings-widget">
                    <div class="market-rankings-header">
                        <div>
                            <div class="market-rankings-title">Market Rankings</div>
                            <div class="market-rankings-subtitle">By Total Sales YTD</div>
                        </div>
                        <div class="market-rankings-link" onclick="document.querySelector('[data-tab=markets]').click()">
                            View Full Comparison
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M5 12h14M12 5l7 7-7 7"/>
                            </svg>
                        </div>
                    </div>
                    <div class="market-rankings-list">
                        ${marketData.map((item, index) => {
                            const barWidth = (item.value / maxValue) * 100;
                            const rankClass = index < 3 ? `rank-${index + 1}` : 'rank-other';
                            const barClass = item.change >= 0 ? (item.change > 2 ? 'positive' : 'neutral') : 'negative';
                            const changeArrow = item.change >= 0 ? '↑' : '↓';

                            return `
                                <div class="market-rank-item">
                                    <div class="market-rank-position ${rankClass}">${index + 1}</div>
                                    <div class="market-rank-name">${item.market}</div>
                                    <div class="market-rank-bar-container">
                                        <div class="market-rank-bar ${barClass}" style="width: ${barWidth}%"></div>
                                    </div>
                                    <div class="market-rank-value">${formatValue(item.value, config.format)}</div>
                                    <div class="market-rank-change ${item.changeClass}">
                                        ${changeArrow} ${formatChange(item.change, config.format)}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function renderMarketsTab() {
            const kpis = getKPIs();
            const months = getAvailableMonths();
            const selectedKPI = state.marketCompareKPI || 'SLS_TTL';
            const selectedMonth = state.marketCompareMonth || months[months.length - 1];
            const selectedMode = state.marketCompareMode || 'vsLY';

            return `
                <div class="section-header">
                    <div>
                        <div class="section-title">Market Comparison</div>
                        <div class="section-subtitle">Compare performance across markets and identify leaders & laggards</div>
                    </div>
                </div>
                <div class="filter-row" style="margin-bottom: 24px;">
                    <div class="filter-group">
                        <label>KPI Metric</label>
                        <select class="filter-select" id="marketCompareKpiSelect">
                            ${kpis.map(k => `<option value="${k}" ${k === selectedKPI ? 'selected' : ''}>${KPI_CONFIG[k]?.name || k}</option>`).join('')}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Month</label>
                        <select class="filter-select" id="marketCompareMonthSelect">
                            ${months.map(m => `<option value="${m}" ${m === selectedMonth ? 'selected' : ''}>${m}</option>`).join('')}
                        </select>
                    </div>
                </div>
                <div id="marketComparisonContent">
                    ${renderMarketComparisonContent(selectedKPI, selectedMonth, selectedMode)}
                </div>
            `;
        }

        function renderMarketComparisonContent(kpiKey, month, mode) {
            const config = KPI_CONFIG[kpiKey];
            if (!config) return '<p>No data available</p>';

            return `
                <div class="market-comparison-layout">
                    <!-- Quick Stats Row -->
                    ${renderQuickStats(kpiKey, month)}

                    <!-- Main Comparison Bars -->
                    ${renderComparisonBars(kpiKey, month, mode)}

                    <!-- Two Column Layout: Gap Analysis + Trend Comparison -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                        ${renderGapAnalysis(kpiKey, month)}
                        ${renderTrendComparison(kpiKey)}
                    </div>

                    <!-- Multi-KPI Matrix -->
                    ${renderKPIMatrix(month)}
                </div>
            `;
        }

        function renderQuickStats(kpiKey, month) {
            const config = KPI_CONFIG[kpiKey];
            const markets = getMarkets().filter(m => !isAggregateValue(m, 'market'));

            // Get market data for the selected month
            const marketData = markets.map(m => {
                const data = getDataForMonth(m, kpiKey, month);
                const change = data ? calcChange(data.YTD, data.LYTD, config.format) : null;
                return { market: m, data, change };
            }).filter(d => d.data);

            // Sort by change to find leader and laggard
            const sortedByChange = [...marketData].sort((a, b) => (b.change || 0) - (a.change || 0));
            const leader = sortedByChange[0];
            const laggard = sortedByChange[sortedByChange.length - 1];

            // Calculate gap
            const gap = leader && laggard ? Math.abs((leader.change || 0) - (laggard.change || 0)) : 0;
            const gapFormatted = config.format === 'percent' ? gap.toFixed(1) + ' PP' : gap.toFixed(1) + '%';

            return `
                <div class="quick-stats-row">
                    <div class="quick-stat-card">
                        <div class="quick-stat-icon leader">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                        </div>
                        <div class="quick-stat-content">
                            <div class="quick-stat-label">Leader</div>
                            <div class="quick-stat-value">${leader?.market || '—'}</div>
                            <div class="quick-stat-detail" style="color: var(--positive)">${leader ? formatChange(leader.change, config.format) + ' vs LY' : ''}</div>
                        </div>
                    </div>
                    <div class="quick-stat-card">
                        <div class="quick-stat-icon laggard">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="12" y1="8" x2="12" y2="12"/>
                                <line x1="12" y1="16" x2="12.01" y2="16"/>
                            </svg>
                        </div>
                        <div class="quick-stat-content">
                            <div class="quick-stat-label">Needs Attention</div>
                            <div class="quick-stat-value">${laggard?.market || '—'}</div>
                            <div class="quick-stat-detail" style="color: var(--negative)">${laggard ? formatChange(laggard.change, config.format) + ' vs LY' : ''}</div>
                        </div>
                    </div>
                    <div class="quick-stat-card">
                        <div class="quick-stat-icon gap">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 12H3M21 12l-4-4m4 4l-4 4M3 12l4-4m-4 4l4 4"/>
                            </svg>
                        </div>
                        <div class="quick-stat-content">
                            <div class="quick-stat-label">Performance Gap</div>
                            <div class="quick-stat-value">${gapFormatted}</div>
                            <div class="quick-stat-detail">Between ${leader?.market || '—'} and ${laggard?.market || '—'}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderComparisonBars(kpiKey, month, mode) {
            const config = KPI_CONFIG[kpiKey];
            const markets = getMarkets().filter(m => !isAggregateValue(m, 'market'));

            // Get market data
            const marketData = markets.map(m => {
                const data = getDataForMonth(m, kpiKey, month);
                if (!data) return null;
                const change = calcChange(data.YTD, data.LYTD, config.format);
                const targetGap = data.Target ? calcTargetGap(data.YTD, data.Target, config.format) : null;
                return {
                    market: m,
                    value: data.YTD,
                    lytd: data.LYTD,
                    target: data.Target,
                    change,
                    targetGap,
                    changeClass: getChangeClass(change, config.format),
                    targetClass: targetGap !== null ? getChangeClass(targetGap, config.format) : null
                };
            }).filter(d => d).sort((a, b) => b.value - a.value);

            const maxValue = marketData[0]?.value || 1;

            // Determine what to show based on mode
            const getBarInfo = (item, index) => {
                let barWidth, barClass, displayChange, displayClass;

                if (mode === 'absolute') {
                    barWidth = (item.value / maxValue) * 100;
                    barClass = 'neutral';
                    displayChange = '';
                    displayClass = '';
                } else if (mode === 'vsTarget' && item.targetGap !== null) {
                    barWidth = (item.value / maxValue) * 100;
                    barClass = item.targetClass;
                    displayChange = formatChange(item.targetGap, config.format);
                    displayClass = item.targetClass;
                } else {
                    barWidth = (item.value / maxValue) * 100;
                    barClass = item.changeClass;
                    displayChange = formatChange(item.change, config.format);
                    displayClass = item.changeClass;
                }

                return { barWidth, barClass, displayChange, displayClass };
            };

            // Calculate axis labels
            const axisLabels = [0, maxValue * 0.25, maxValue * 0.5, maxValue * 0.75, maxValue];

            return `
                <div class="comparison-bars-card">
                    <div class="comparison-bars-header">
                        <div class="comparison-bars-title">${config.name} — YTD thru ${month}</div>
                        <div class="comparison-bars-toggles">
                            <button class="comparison-toggle ${mode === 'vsLY' ? 'active' : ''}" data-mode="vsLY">vs Last Year</button>
                            <button class="comparison-toggle ${mode === 'vsTarget' ? 'active' : ''}" data-mode="vsTarget">vs Target</button>
                            <button class="comparison-toggle ${mode === 'absolute' ? 'active' : ''}" data-mode="absolute">Absolute</button>
                        </div>
                    </div>
                    <div class="comparison-bars-body">
                        ${marketData.map((item, index) => {
                            const { barWidth, barClass, displayChange, displayClass } = getBarInfo(item, index);
                            const rankClass = index < 3 ? `rank-${index + 1}` : '';
                            const changeArrow = item.change >= 0 ? '↑' : '↓';

                            return `
                                <div class="comparison-bar-row">
                                    <div class="comparison-bar-market">
                                        <span class="comparison-bar-rank ${rankClass}">${index + 1}</span>
                                        ${item.market}
                                    </div>
                                    <div class="comparison-bar-track">
                                        <div class="comparison-bar-fill ${barClass}" style="width: ${barWidth}%">
                                            ${barWidth > 15 ? `<span class="comparison-bar-fill-label">${displayChange}</span>` : ''}
                                        </div>
                                    </div>
                                    <div class="comparison-bar-value">${formatValue(item.value, config.format)}</div>
                                    <div class="comparison-bar-change ${displayClass}">
                                        ${mode !== 'absolute' ? `${changeArrow} ${displayChange}` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div class="comparison-bar-axis">
                        ${axisLabels.map(v => `<span class="comparison-bar-axis-label">${formatValue(v, config.format)}</span>`).join('')}
                    </div>
                </div>
            `;
        }

        function renderGapAnalysis(kpiKey, month) {
            const config = KPI_CONFIG[kpiKey];
            const markets = getMarkets().filter(m => !isAggregateValue(m, 'market'));
            const totalMarket = getAggregateValue('market');
            const totalData = getDataForMonth(totalMarket, kpiKey, month);

            // Calculate average (use total if available, otherwise calculate mean)
            let benchmarkValue;
            if (totalData) {
                benchmarkValue = totalData.YTD / markets.length; // Average per market
            } else {
                const allValues = markets.map(m => getDataForMonth(m, kpiKey, month)?.YTD || 0);
                benchmarkValue = allValues.reduce((a, b) => a + b, 0) / allValues.length;
            }

            // Get market data with gap from average
            const marketData = markets.map(m => {
                const data = getDataForMonth(m, kpiKey, month);
                if (!data) return null;
                const gapFromAvg = benchmarkValue > 0 ? ((data.YTD - benchmarkValue) / benchmarkValue) * 100 : 0;
                return {
                    market: m,
                    value: data.YTD,
                    gap: gapFromAvg
                };
            }).filter(d => d).sort((a, b) => b.gap - a.gap);

            return `
                <div class="gap-analysis-card">
                    <div class="gap-analysis-header">
                        <div class="gap-analysis-title">Gap from Average</div>
                        <div class="gap-analysis-benchmark">Benchmark: ${formatValue(benchmarkValue, config.format)} avg/market</div>
                    </div>
                    <div class="gap-analysis-grid">
                        ${marketData.map(item => {
                            const gapClass = item.gap > 2 ? 'above' : (item.gap < -2 ? 'below' : 'at');
                            const gapSign = item.gap >= 0 ? '+' : '';
                            const gapLabel = item.gap > 2 ? 'above average' : (item.gap < -2 ? 'below average' : 'at average');

                            return `
                                <div class="gap-analysis-item">
                                    <div class="gap-analysis-market">${item.market}</div>
                                    <div class="gap-analysis-value ${gapClass}">${gapSign}${item.gap.toFixed(1)}%</div>
                                    <div class="gap-analysis-label">${gapLabel}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function renderTrendComparison(kpiKey) {
            const config = KPI_CONFIG[kpiKey];
            const markets = getMarkets().filter(m => !isAggregateValue(m, 'market'));
            const months = getAvailableMonths();

            // Get trend data for each market
            const trendData = markets.map(m => {
                const monthlyValues = months.map(month => {
                    const data = getDataForMonth(m, kpiKey, month);
                    return data?.YTD || null;
                });

                // Calculate overall YTD change (latest month)
                const latestData = getLatestData(m, kpiKey);
                const change = latestData ? calcChange(latestData.YTD, latestData.LYTD, config.format) : 0;

                return {
                    market: m,
                    values: monthlyValues,
                    change,
                    changeClass: getChangeClass(change, config.format)
                };
            });

            // Render sparkline SVG
            function renderSparkline(values, changeClass) {
                const validValues = values.filter(v => v !== null);
                if (validValues.length < 2) return '<div style="color: var(--text-muted); font-style: italic;">Insufficient data</div>';

                const minVal = Math.min(...validValues);
                const maxVal = Math.max(...validValues);
                const range = maxVal - minVal || 1;

                const width = 120;
                const height = 50;
                const padding = 4;

                // Create path points
                let pathD = '';
                let validIndex = 0;
                values.forEach((v, i) => {
                    if (v !== null) {
                        const x = padding + (validIndex / (validValues.length - 1)) * (width - padding * 2);
                        const y = height - padding - ((v - minVal) / range) * (height - padding * 2);
                        pathD += (validIndex === 0 ? 'M' : 'L') + `${x},${y}`;
                        validIndex++;
                    }
                });

                const strokeColor = changeClass === 'up' ? 'var(--positive)' : (changeClass === 'down' ? 'var(--negative)' : 'var(--navy)');

                return `
                    <svg width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">
                        <path d="${pathD}" fill="none" stroke="${strokeColor}" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                `;
            }

            return `
                <div class="trend-comparison-card">
                    <div class="trend-comparison-title">Monthly Trend — ${config.name}</div>
                    <div class="trend-comparison-grid">
                        ${trendData.map(item => {
                            const changeArrow = item.change >= 0 ? '↑' : '↓';
                            return `
                                <div class="trend-card">
                                    <div class="trend-card-market">${item.market}</div>
                                    <div class="trend-card-sparkline">
                                        ${renderSparkline(item.values, item.changeClass)}
                                    </div>
                                    <div class="trend-card-change ${item.changeClass}">
                                        ${changeArrow} ${formatChange(item.change, config.format)}
                                    </div>
                                    <div class="trend-card-label">YTD vs LY</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function renderKPIMatrix(month) {
            const markets = getMarkets().filter(m => !isAggregateValue(m, 'market'));
            const keyKPIs = ['SLS_TTL', 'MBR_TTL', 'PCT_NBA', 'PCT_XBP', 'PCT_RDM', 'AVG_AOV'];

            return `
                <div class="kpi-matrix-card">
                    <div class="kpi-matrix-title">Multi-KPI Performance Matrix — ${month}</div>
                    <table class="kpi-matrix-table">
                        <thead>
                            <tr>
                                <th>KPI</th>
                                ${markets.map(m => `<th>${m}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${keyKPIs.map(kpiKey => {
                                const config = KPI_CONFIG[kpiKey];
                                if (!config) return '';

                                // Get data for all markets
                                const marketValues = markets.map(m => {
                                    const data = getDataForMonth(m, kpiKey, month);
                                    if (!data) return { market: m, value: null, change: null };
                                    const change = calcChange(data.YTD, data.LYTD, config.format);
                                    return { market: m, value: data.YTD, change };
                                });

                                // Rank markets by value
                                const sortedByValue = [...marketValues].filter(v => v.value !== null).sort((a, b) => b.value - a.value);
                                const maxValue = sortedByValue[0]?.value || 1;
                                const rankings = {};
                                sortedByValue.forEach((item, idx) => {
                                    rankings[item.market] = idx + 1;
                                });

                                return `
                                    <tr>
                                        <td class="kpi-matrix-kpi-cell">${config.name}</td>
                                        ${marketValues.map(item => {
                                            if (item.value === null) {
                                                return '<td class="kpi-matrix-value-cell"><span class="cell-na">—</span></td>';
                                            }

                                            const rank = rankings[item.market] || 4;
                                            const barWidth = (item.value / maxValue) * 100;
                                            const changeClass = getChangeClass(item.change, config.format);
                                            const changeArrow = item.change >= 0 ? '↑' : '↓';

                                            return `
                                                <td class="kpi-matrix-value-cell">
                                                    <div class="kpi-matrix-mini-bar">
                                                        <span class="kpi-matrix-rank-badge rank-${rank}">#${rank}</span>
                                                        <div class="kpi-matrix-bar-wrapper">
                                                            <div class="kpi-matrix-bar-fill" style="width: ${barWidth}%"></div>
                                                        </div>
                                                        <span class="kpi-matrix-variance ${changeClass}">${changeArrow} ${formatChange(item.change, config.format)}</span>
                                                    </div>
                                                </td>
                                            `;
                                        }).join('')}
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Helper function to get data for a specific month
        function getDataForMonth(market, kpiKey, month) {
            if (!state.data) return null;
            return state.data.find(row =>
                row.Market === market &&
                row.Month === month &&
                row.Key === kpiKey
            );
        }

        function renderKPITab() {
            const kpis = getKPIs();
            const markets = getMarkets();
            const months = getAvailableMonths();
            const defaultKPI = kpis.includes('SLS_TTL') ? 'SLS_TTL' : kpis[0];
            const defaultMarket = getAggregateValue('market');
            const defaultMonth = months[months.length - 1]; // Latest month by default

            const selectedKPI = state.selectedKPI || defaultKPI;
            const selectedMarket = state.selectedMarket || defaultMarket;
            const selectedMonth = state.selectedKPIMonth || defaultMonth;

            return `
                <div class="section-header">
                    <div>
                        <div class="section-title">KPI Deep Dive</div>
                        <div class="section-subtitle">Detailed monthly trend analysis and performance tracking</div>
                    </div>
                </div>
                <div class="filter-row">
                    <div class="filter-group">
                        <label>Market</label>
                        <select class="filter-select" id="kpiMarketSelect">
                            ${markets.map(m => `<option value="${m}" ${m === selectedMarket ? 'selected' : ''}>${m}</option>`).join('')}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>KPI Metric</label>
                        <select class="filter-select" id="kpiSelect">
                            ${kpis.map(k => `<option value="${k}" ${k === selectedKPI ? 'selected' : ''}>${KPI_CONFIG[k]?.name || k}</option>`).join('')}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Month (Hero Card)</label>
                        <select class="filter-select" id="kpiMonthSelect">
                            ${months.map(m => `<option value="${m}" ${m === selectedMonth ? 'selected' : ''}>${m}</option>`).join('')}
                        </select>
                    </div>
                </div>
                <div id="kpiDetailContent">
                    ${renderKPIDetail(selectedMarket, selectedKPI, selectedMonth)}
                </div>
            `;
        }

        function renderKPIDetail(market, kpiKey, selectedMonth = null) {
            const config = KPI_CONFIG[kpiKey];
            const monthlyData = getMonthlyData(market, kpiKey);
            const latestData = getLatestData(market, kpiKey);

            if (!config || monthlyData.length === 0) {
                return '<p>No data available for selection</p>';
            }

            // Get hero card data for the selected month (or latest if not specified)
            const months = getAvailableMonths();
            const heroMonth = selectedMonth || months[months.length - 1];
            const heroData = monthlyData.find(d => d.Month === heroMonth) || latestData;

            const ytdVsLytd = calcChange(heroData?.YTD, heroData?.LYTD, config.format);
            const r12mVsLr12m = calcChange(heroData?.R12M, heroData?.LMR12M, config.format);
            const ytdVsTarget = heroData?.Target ? calcTargetGap(heroData.YTD, heroData.Target, config.format) : null;

            const chartData = MONTHS.map(month => {
                const row = monthlyData.find(d => MONTH_MAP[d.Month] === month);
                return {
                    month,
                    ytd: row?.YTD ?? null,
                    lytd: row?.LYTD ?? null,
                    target: row?.Target ?? null
                };
            });

            const width = 900, height = 390;
            const marginLeft = 70, marginRight = 30, marginTop = 20, marginBottom = 40;
            const chartWidth = width - marginLeft - marginRight;
            const chartHeight = height - marginTop - marginBottom;

            const allVals = chartData.flatMap(d => [d.ytd, d.lytd, d.target]).filter(v => v !== null && !isNaN(v));

            if (allVals.length === 0) {
                return '<div class="chart-container"><p style="text-align:center; padding:40px; color:var(--text-muted);">No chart data available for this selection</p></div>';
            }

            const minVal = Math.min(...allVals) * 0.9;
            const maxVal = Math.max(...allVals) * 1.1;
            const valueRange = maxVal - minVal || 1;

            const xScale = i => marginLeft + (i * chartWidth / 11);
            const yScale = v => marginTop + chartHeight - ((v - minVal) / valueRange) * chartHeight;

            let pathYTD = '', pathLYTD = '', pathTarget = '';
            let dotsYTD = '', dotsLYTD = '';
            let fillAreas = '';

            for (let i = 0; i < chartData.length - 1; i++) {
                const d1 = chartData[i];
                const d2 = chartData[i + 1];
                if (d1.ytd !== null && d1.lytd !== null && d2.ytd !== null && d2.lytd !== null) {
                    const x1 = xScale(i);
                    const x2 = xScale(i + 1);
                    const y1_ytd = yScale(d1.ytd);
                    const y1_lytd = yScale(d1.lytd);
                    const y2_ytd = yScale(d2.ytd);
                    const y2_lytd = yScale(d2.lytd);

                    const avgYtd = (d1.ytd + d2.ytd) / 2;
                    const avgLytd = (d1.lytd + d2.lytd) / 2;
                    const fillColor = avgYtd >= avgLytd ? 'rgba(46, 125, 90, 0.15)' : 'rgba(196, 49, 75, 0.15)';

                    fillAreas += `<path d="M${x1},${y1_ytd} L${x2},${y2_ytd} L${x2},${y2_lytd} L${x1},${y1_lytd} Z" fill="${fillColor}"/>`;
                }
            }

            chartData.forEach((d, i) => {
                const x = xScale(i);
                if (d.ytd !== null) {
                    const y = yScale(d.ytd);
                    pathYTD += (pathYTD ? ' L' : 'M') + `${x},${y}`;
                    const tooltipData = JSON.stringify({month: d.month, ytd: d.ytd, lytd: d.lytd, target: d.target, format: config.format}).replace(/"/g, '&quot;');
                    dotsYTD += `<circle cx="${x}" cy="${y}" r="5" fill="var(--navy)" class="chart-dot" data-info="${tooltipData}" style="cursor:pointer"/>`;
                }
                if (d.lytd !== null) {
                    const y = yScale(d.lytd);
                    pathLYTD += (pathLYTD ? ' L' : 'M') + `${x},${y}`;
                    const tooltipData = JSON.stringify({month: d.month, ytd: d.ytd, lytd: d.lytd, target: d.target, format: config.format}).replace(/"/g, '&quot;');
                    dotsLYTD += `<circle cx="${x}" cy="${y}" r="5" fill="var(--steel-blue)" class="chart-dot" data-info="${tooltipData}" style="cursor:pointer"/>`;
                }
                if (d.target !== null) {
                    const y = yScale(d.target);
                    pathTarget += (pathTarget ? ' L' : 'M') + `${x},${y}`;
                }
            });

            let yAxisHTML = '';
            for (let i = 0; i <= 5; i++) {
                const v = minVal + (maxVal - minVal) * (i / 5);
                const y = yScale(v);
                yAxisHTML += `<text x="${marginLeft-10}" y="${y+4}" text-anchor="end" fill="var(--text-muted)" font-size="11">${formatValue(v, config.format)}</text>`;
                yAxisHTML += `<line x1="${marginLeft}" y1="${y}" x2="${width-marginRight}" y2="${y}" stroke="var(--light-steel)" stroke-dasharray="3,3"/>`;
            }

            let xAxisHTML = MONTHS.map((m, i) => `<text x="${xScale(i)}" y="${height-12}" text-anchor="middle" fill="var(--text-muted)" font-size="11">${m}</text>`).join('');

            const badgesHTML = chartData.map(d => {
                const change = calcChange(d.ytd, d.lytd, config.format);
                const changeClass = getChangeClass(change, config.format);
                return `
                    <div class="trend-badge">
                        <div class="trend-badge-month">${d.month}</div>
                        <div class="trend-badge-actual">${formatValue(d.ytd, config.format)}</div>
                        <div class="trend-badge-value ${changeClass}">${formatChange(change, config.format)} <span class="trend-badge-label">vs LY</span></div>
                    </div>
                `;
            }).join('');

            const isAllMarkets = isAggregateValue(market, 'market');
            const marketBreakdown = isAllMarkets ? getMarkets()
                .filter(m => !isAggregateValue(m, 'market'))
                .map(m => {
                    const data = getLatestData(m, kpiKey);
                    return { market: m, value: data?.YTD || 0 };
                })
                .sort((a, b) => b.value - a.value) : [];

            const totalValue = latestData?.YTD || 1;
            const maxMarketValue = marketBreakdown[0]?.value || 1;

            return `
                <div class="kpi-hero-row">
                    <div class="kpi-hero-card">
                        <div class="kpi-hero-label">${config.name} — YTD thru ${heroMonth} 2025${!isAllMarkets ? ` (${market})` : ''}</div>
                        <div class="kpi-hero-content">
                            <div class="kpi-hero-main">
                                <div class="kpi-hero-value">${formatValue(heroData?.YTD, config.format)}</div>
                                ${ytdVsTarget !== null ? `
                                <div class="kpi-hero-target">
                                    <div class="kpi-hero-target-info">
                                        <span class="kpi-hero-target-label">vs Target</span>
                                        <span class="kpi-hero-target-detail">Target: ${formatValue(heroData?.Target, config.format)}</span>
                                    </div>
                                    <span class="kpi-hero-target-badge ${getChangeClass(ytdVsTarget, config.format)}">${formatChange(ytdVsTarget, config.format)}</span>
                                </div>
                                ` : ''}
                            </div>
                            <div class="kpi-hero-secondary">
                                <div class="kpi-secondary-item">
                                    <div class="kpi-secondary-info">
                                        <span class="kpi-secondary-label">vs LY</span>
                                        <span class="kpi-secondary-detail">2024: ${formatValue(heroData?.LYTD, config.format)}</span>
                                    </div>
                                    <span class="kpi-secondary-value ${getChangeClass(ytdVsLytd, config.format)}">${formatChange(ytdVsLytd, config.format)}</span>
                                </div>
                                ${r12mVsLr12m !== null ? `
                                <div class="kpi-secondary-item">
                                    <div class="kpi-secondary-info">
                                        <span class="kpi-secondary-label">R12M Momentum</span>
                                        <span class="kpi-secondary-detail">R12M: ${formatValue(heroData?.R12M, config.format)} vs LMR12M: ${formatValue(heroData?.LMR12M, config.format)}</span>
                                    </div>
                                    <span class="kpi-secondary-value ${getChangeClass(r12mVsLr12m, config.format)}">${formatChange(r12mVsLr12m, config.format)}</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    ${isAllMarkets ? `
                    <div class="market-breakdown-card">
                        <div class="market-breakdown-title">By Market</div>
                        <div class="market-breakdown-list">
                            ${marketBreakdown.slice(0, 4).map((item, i) => {
                                const share = totalValue > 0 ? ((item.value / totalValue) * 100).toFixed(0) : 0;
                                const barWidth = (item.value / maxMarketValue) * 100;
                                return `
                                    <div class="market-breakdown-item">
                                        <div class="market-breakdown-header">
                                            <span class="market-breakdown-name">${item.market}</span>
                                            <span class="market-breakdown-value">${formatValue(item.value, config.format)} (${share}%)</span>
                                        </div>
                                        <div class="market-breakdown-bar-bg">
                                            <div class="market-breakdown-bar bar-${i + 1}" style="width: ${barWidth}%"></div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    ` : `
                    <div class="market-breakdown-card">
                        <div class="market-breakdown-title">Market</div>
                        <div class="breakdown-single-value">${market}</div>
                    </div>
                    `}
                </div>

                <div class="chart-with-badges">
                    <div class="chart-container chart-left">
                        <div class="chart-header">
                            <div class="chart-title">Monthly Trend — ${config.name}</div>
                            <div class="chart-legend">
                                <div class="legend-item"><div class="legend-dot solid"></div> 2025</div>
                                <div class="legend-item"><div class="legend-dot dashed"></div> 2024</div>
                                ${pathTarget ? '<div class="legend-item"><div class="legend-dot target"></div> Target</div>' : ''}
                            </div>
                        </div>
                        <svg class="chart-svg" viewBox="0 0 ${width} ${height}">
                            ${yAxisHTML}
                            ${xAxisHTML}
                            ${fillAreas}
                            ${pathTarget ? `<path d="${pathTarget}" fill="none" stroke="var(--positive)" stroke-width="2" stroke-dasharray="4,4"/>` : ''}
                            <path d="${pathLYTD}" fill="none" stroke="var(--steel-blue)" stroke-width="2" stroke-dasharray="5,5"/>
                            <path d="${pathYTD}" fill="none" stroke="var(--navy)" stroke-width="3"/>
                            ${dotsLYTD}
                            ${dotsYTD}
                        </svg>
                    </div>
                    <div class="trend-badges-right">${badgesHTML}</div>
                </div>
            `;
        }

        function getAvailableMonths() {
            if (!state.data) return [];
            const months = [...new Set(state.data.map(d => d.Month))].filter(m => m);
            // Sort by month order
            return months.sort((a, b) => {
                const aMonth = MONTH_MAP[a] || a;
                const bMonth = MONTH_MAP[b] || b;
                const aIdx = MONTHS.indexOf(aMonth);
                const bIdx = MONTHS.indexOf(bMonth);
                return aIdx - bIdx;
            });
        }

        function getMonthDisplayName(month) {
            // Convert "01-Jan" or similar to "January"
            const monthNames = {
                'JAN': 'January', 'FEB': 'February', 'MAR': 'March', 'APR': 'April',
                'MAY': 'May', 'JUN': 'June', 'JUL': 'July', 'AUG': 'August',
                'SEP': 'September', 'OCT': 'October', 'NOV': 'November', 'DEC': 'December'
            };
            const normalized = MONTH_MAP[month] || month;
            return monthNames[normalized] || month;
        }

        function renderScorecardTab() {
            const markets = getMarkets();
            const months = getAvailableMonths();
            const defaultMarket = state.scorecardMarket || getAggregateValue('market');
            const defaultMonth = state.scorecardMonth || months[months.length - 1]; // Latest month

            return `
                <div class="section-header">
                    <div>
                        <div class="section-title">Performance Scorecard</div>
                        <div class="section-subtitle">Comprehensive KPI overview with variance analysis</div>
                    </div>
                </div>
                <div class="filter-row">
                    <div class="filter-group">
                        <label>Market</label>
                        <select class="filter-select" id="scorecardMarketSelect">
                            ${markets.map(m => `<option value="${m}" ${m === defaultMarket ? 'selected' : ''}>${m}</option>`).join('')}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Period</label>
                        <select class="filter-select" id="scorecardMonthSelect">
                            ${months.map(m => `<option value="${m}" ${m === defaultMonth ? 'selected' : ''}>${getMonthDisplayName(m)}</option>`).join('')}
                        </select>
                    </div>
                </div>
                <div id="scorecardContent">
                    ${renderScorecardTable(defaultMarket, defaultMonth)}
                </div>
            `;
        }

        function renderScorecardTable(market, month) {
            // Get all KPIs in the desired order
            const kpiOrder = ['SLS_TTL', 'SLS_PEN', 'MBR_TTL', 'MBR_NEW', 'MBR_RTN', 'AVG_ATF', 'AVG_AOV', 'PCT_RDM', 'PCT_XBP', 'PCT_NBA', 'AVG_BRD', 'PTS_BRN'];
            const availableKPIs = getKPIs();
            const kpis = kpiOrder.filter(k => availableKPIs.includes(k));

            // Get data for each KPI with original order
            let rows = kpis.map((kpiKey, index) => {
                const config = KPI_CONFIG[kpiKey];
                if (!config) return null;

                const dataRow = state.data.find(d =>
                    d.Market === market &&
                    d.Month === month &&
                    d.Key === kpiKey
                );

                if (!dataRow) return null;

                // Calculate variances
                const vsTarget = dataRow.Target ? calcTargetGap(dataRow.YTD, dataRow.Target, config.format) : null;
                const vsLYTD = calcChange(dataRow.YTD, dataRow.LYTD, config.format);
                const vsLMR12M = calcChange(dataRow.R12M, dataRow.LMR12M, config.format);
                const vsLYR12M = vsLYTD; // At year-end, these are equivalent

                return {
                    key: kpiKey,
                    name: config.name,
                    format: config.format,
                    order: index + 1, // Original order (1-based)
                    ytd: dataRow.YTD,
                    target: dataRow.Target,
                    lytd: dataRow.LYTD,
                    r12m: dataRow.R12M,
                    lmr12m: dataRow.LMR12M,
                    vsTarget,
                    vsLYTD,
                    vsLMR12M,
                    vsLYR12M
                };
            }).filter(r => r !== null);

            if (rows.length === 0) {
                return `
                    <div class="scorecard-container">
                        <p style="text-align: center; padding: 40px; color: var(--text-muted);">
                            No data available for the selected market and period.
                        </p>
                    </div>
                `;
            }

            // Apply sorting if set
            if (state.scorecardSort.column) {
                const col = state.scorecardSort.column;
                const dir = state.scorecardSort.direction === 'asc' ? 1 : -1;
                rows = [...rows].sort((a, b) => {
                    let aVal = a[col];
                    let bVal = b[col];
                    // Handle nulls
                    if (aVal === null && bVal === null) return 0;
                    if (aVal === null) return 1;
                    if (bVal === null) return -1;
                    // Handle strings (KPI name)
                    if (typeof aVal === 'string') return dir * aVal.localeCompare(bVal);
                    // Handle numbers
                    return dir * (aVal - bVal);
                });
            }

            // Helper: Determine row status based on vs Target performance
            function getRowStatus(vsTarget) {
                if (vsTarget === null) return '';
                if (vsTarget >= 0) return 'status-positive';
                if (vsTarget >= -5) return 'status-warning';
                return 'status-negative';
            }

            // Helper: Determine variance intensity class
            function getVarianceIntensity(variance, format) {
                if (variance === null) return 'neutral';
                const threshold = format === 'percent' ? 2 : 10; // 2 PP or 10%
                const absVar = Math.abs(variance);
                const isPositive = variance >= 0;
                const neutralThreshold = format === 'percent' ? 0.1 : 1;

                if (absVar < neutralThreshold) return 'neutral';
                if (isPositive) {
                    return absVar >= threshold ? 'positive-strong' : 'positive';
                } else {
                    return absVar >= threshold ? 'negative-strong' : 'negative';
                }
            }

            // Helper: Get trend arrow with color class
            function getTrendArrow(variance) {
                if (variance === null) return { arrow: '', colorClass: '' };
                if (variance > 0.5) return { arrow: '↑', colorClass: 'arrow-up' };
                if (variance < -0.5) return { arrow: '↓', colorClass: 'arrow-down' };
                return { arrow: '→', colorClass: 'arrow-neutral' };
            }

            // Helper: Format variance cell with all enhancements
            function formatEnhancedVarianceCell(variance, format, contextLabel, contextValue, extraClasses = '') {
                if (variance === null) {
                    return `<td class="variance-cell neutral ${extraClasses}">
                        <div class="variance-content">
                            <span class="variance-main">—</span>
                        </div>
                    </td>`;
                }

                const intensityClass = getVarianceIntensity(variance, format);
                const { arrow, colorClass } = getTrendArrow(variance);
                const formattedVariance = formatChange(variance, format);
                const contextDisplay = contextValue !== null ? formatValue(contextValue, format) : '';

                return `<td class="variance-cell ${intensityClass} ${extraClasses}"
                    data-tooltip-title="${contextLabel}"
                    data-tooltip-value="${contextDisplay}"
                    data-tooltip-variance="${formattedVariance}">
                    <div class="variance-content">
                        <span class="variance-main">
                            <span class="variance-arrow ${colorClass}">${arrow}</span>
                            ${formattedVariance}
                        </span>
                        ${contextDisplay ? `<span class="variance-context">${contextLabel}: ${contextDisplay}</span>` : ''}
                    </div>
                </td>`;
            }

            // Helper: Format target cell with progress bar
            function formatTargetCell(row) {
                if (row.vsTarget === null || row.target === null) {
                    return `<td class="variance-cell target-cell neutral section-divider">
                        <div class="target-content">
                            <span class="target-variance">—</span>
                        </div>
                    </td>`;
                }

                const intensityClass = getVarianceIntensity(row.vsTarget, row.format);
                const { arrow, colorClass } = getTrendArrow(row.vsTarget);
                const formattedVariance = formatChange(row.vsTarget, row.format);
                const formattedTarget = formatValue(row.target, row.format);

                // Calculate progress percentage (capped at 100% for display)
                let progressPct;
                if (row.format === 'percent') {
                    // For percentages, compare directly
                    progressPct = row.target > 0 ? Math.min(100, (row.ytd / row.target) * 100) : 0;
                } else {
                    progressPct = row.target > 0 ? Math.min(100, (row.ytd / row.target) * 100) : 0;
                }

                // Determine bar color class
                let barClass = 'behind';
                if (row.vsTarget >= 0) barClass = 'achieved';
                else if (row.vsTarget >= -5) barClass = 'close';

                return `<td class="variance-cell target-cell ${intensityClass} section-divider"
                    data-tooltip-title="Target"
                    data-tooltip-value="${formattedTarget}"
                    data-tooltip-variance="${formattedVariance}"
                    data-tooltip-actual="${formatValue(row.ytd, row.format)}">
                    <div class="target-content">
                        <span class="target-variance">
                            <span class="variance-arrow ${colorClass}">${arrow}</span>
                            ${formattedVariance}
                        </span>
                        <div class="target-bar-container">
                            <div class="target-bar ${barClass}" style="width: ${progressPct}%"></div>
                        </div>
                        <span class="target-context">TGT: ${formattedTarget}</span>
                    </div>
                </td>`;
            }

            // Helper: Get sort class for header
            function getSortClass(columnKey) {
                if (state.scorecardSort.column !== columnKey) return '';
                return `sorted sorted-${state.scorecardSort.direction}`;
            }

            return `
                <div class="scorecard-container">
                    <div class="scorecard-header">
                        <div class="scorecard-header-left">
                            <div class="scorecard-title">KPI Performance Summary</div>
                            <div class="scorecard-subtitle">${market} • ${getMonthDisplayName(month)} ${CURRENT_YEAR} YTD</div>
                        </div>
                        <div class="scorecard-header-right">
                            <div class="scorecard-legend">
                                <div class="scorecard-legend-item">
                                    <div class="scorecard-legend-dot positive"></div>
                                    <span>On/Above Target</span>
                                </div>
                                <div class="scorecard-legend-item">
                                    <div class="scorecard-legend-dot neutral"></div>
                                    <span>Near Target</span>
                                </div>
                                <div class="scorecard-legend-item">
                                    <div class="scorecard-legend-dot negative"></div>
                                    <span>Below Target</span>
                                </div>
                            </div>
                            <div class="scorecard-tolerance">Near Target: 0% to -5% (or 0 to -5 PP for percentage KPIs)</div>
                        </div>
                    </div>
                    <table class="scorecard-table">
                        <thead>
                            <tr class="header-group">
                                <th class="order-header sortable-col ${getSortClass('order')}" rowspan="2" data-sort="order"># <span class="sort-indicator"></span></th>
                                <th class="kpi-header" rowspan="2">KPI</th>
                                <th class="group-ytd" colspan="3">YTD Performance</th>
                                <th class="group-r12m" colspan="3">Rolling 12 Months</th>
                            </tr>
                            <tr class="header-columns">
                                <th class="ytd-section sortable-col ${getSortClass('ytd')}" data-sort="ytd">
                                    Value <span class="sort-indicator"></span>
                                </th>
                                <th class="ytd-section sortable-col ${getSortClass('vsTarget')}" data-sort="vsTarget">
                                    vs Target <span class="sort-indicator"></span>
                                </th>
                                <th class="ytd-section ytd-section-last sortable-col ${getSortClass('vsLYTD')}" data-sort="vsLYTD">
                                    vs LY YTD <span class="sort-indicator"></span>
                                </th>
                                <th class="r12m-section sortable-col ${getSortClass('r12m')}" data-sort="r12m">
                                    Value <span class="sort-indicator"></span>
                                </th>
                                <th class="r12m-section sortable-col ${getSortClass('vsLMR12M')}" data-sort="vsLMR12M">
                                    vs LM R12M <span class="sort-indicator"></span>
                                </th>
                                <th class="r12m-section sortable-col ${getSortClass('vsLYR12M')}" data-sort="vsLYR12M">
                                    vs LY R12M <span class="sort-indicator"></span>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows.map(row => `
                                <tr data-kpi="${row.key}" class="scorecard-row ${getRowStatus(row.vsTarget)}">
                                    <td class="order-cell">${row.order}</td>
                                    <td class="kpi-name-cell">${row.name}</td>
                                    <td class="value-cell">
                                        <span class="value-main">${formatValue(row.ytd, row.format)}</span>
                                    </td>
                                    ${formatTargetCell(row)}
                                    ${formatEnhancedVarianceCell(row.vsLYTD, row.format, 'LY YTD', row.lytd, 'section-divider')}
                                    <td class="value-cell r12m-section">
                                        <span class="value-main">${formatValue(row.r12m, row.format)}</span>
                                    </td>
                                    ${formatEnhancedVarianceCell(row.vsLMR12M, row.format, 'LM R12M', row.lmr12m, 'r12m-section')}
                                    ${formatEnhancedVarianceCell(row.vsLYR12M, row.format, 'LY R12M', row.lytd, 'r12m-section')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div class="scorecard-footer">
                        <div class="scorecard-click-hint">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5"/>
                            </svg>
                            <span>Click any row to view detailed KPI analysis</span>
                        </div>
                        <div class="scorecard-sort-hint">Click column headers to sort</div>
                    </div>
                </div>
            `;
        }

        function attachEvents() {
            const dropzone = document.getElementById('dropzone');
            const fileInput = document.getElementById('fileInput');

            if (dropzone) {
                dropzone.onclick = () => fileInput.click();
                dropzone.ondragover = e => { e.preventDefault(); dropzone.style.background = 'var(--light-bg)'; };
                dropzone.ondragleave = () => { dropzone.style.background = ''; };
                dropzone.ondrop = e => {
                    e.preventDefault();
                    dropzone.style.background = '';
                    const file = e.dataTransfer.files[0];
                    if (file && file.name.endsWith('.csv')) loadFile(file);
                };
            }

            if (fileInput) {
                fileInput.onchange = e => { if (e.target.files[0]) loadFile(e.target.files[0]); };
            }

            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.onclick = () => {
                    state.activeTab = tab.dataset.tab;
                    render();
                };
            });

            // Market Comparison event handlers
            const marketCompareKpiSelect = document.getElementById('marketCompareKpiSelect');
            const marketCompareMonthSelect = document.getElementById('marketCompareMonthSelect');

            if (marketCompareKpiSelect) {
                marketCompareKpiSelect.onchange = () => {
                    state.marketCompareKPI = marketCompareKpiSelect.value;
                    updateMarketComparison();
                };
            }

            if (marketCompareMonthSelect) {
                marketCompareMonthSelect.onchange = () => {
                    state.marketCompareMonth = marketCompareMonthSelect.value;
                    updateMarketComparison();
                };
            }

            // Mode toggle buttons
            document.querySelectorAll('.comparison-toggle').forEach(btn => {
                btn.onclick = () => {
                    state.marketCompareMode = btn.dataset.mode;
                    updateMarketComparison();
                };
            });

            function updateMarketComparison() {
                const months = getAvailableMonths();
                const content = document.getElementById('marketComparisonContent');
                if (content) {
                    content.innerHTML = renderMarketComparisonContent(
                        state.marketCompareKPI || 'SLS_TTL',
                        state.marketCompareMonth || months[months.length - 1],
                        state.marketCompareMode || 'vsLY'
                    );
                    // Re-attach toggle handlers after re-render
                    document.querySelectorAll('.comparison-toggle').forEach(btn => {
                        btn.onclick = () => {
                            state.marketCompareMode = btn.dataset.mode;
                            updateMarketComparison();
                        };
                    });
                }
            }

            const kpiMarketSelect = document.getElementById('kpiMarketSelect');
            const kpiSelect = document.getElementById('kpiSelect');
            const kpiMonthSelect = document.getElementById('kpiMonthSelect');

            const defaultKPI = 'SLS_TTL';
            const defaultMarket = getAggregateValue('market');
            const defaultMonth = getAvailableMonths()[getAvailableMonths().length - 1];

            if (kpiMarketSelect) {
                kpiMarketSelect.onchange = () => {
                    state.selectedMarket = kpiMarketSelect.value;
                    const content = document.getElementById('kpiDetailContent');
                    if (content) {
                        content.innerHTML = renderKPIDetail(state.selectedMarket, state.selectedKPI || defaultKPI, state.selectedKPIMonth || defaultMonth);
                        attachChartTooltips();
                    }
                };
            }

            if (kpiSelect) {
                kpiSelect.onchange = () => {
                    state.selectedKPI = kpiSelect.value;
                    const content = document.getElementById('kpiDetailContent');
                    if (content) {
                        content.innerHTML = renderKPIDetail(state.selectedMarket || defaultMarket, state.selectedKPI, state.selectedKPIMonth || defaultMonth);
                        attachChartTooltips();
                    }
                };
            }

            if (kpiMonthSelect) {
                kpiMonthSelect.onchange = () => {
                    state.selectedKPIMonth = kpiMonthSelect.value;
                    const content = document.getElementById('kpiDetailContent');
                    if (content) {
                        content.innerHTML = renderKPIDetail(state.selectedMarket || defaultMarket, state.selectedKPI || defaultKPI, state.selectedKPIMonth);
                        attachChartTooltips();
                    }
                };
            }

            // Scorecard event handlers
            const scorecardMarketSelect = document.getElementById('scorecardMarketSelect');
            const scorecardMonthSelect = document.getElementById('scorecardMonthSelect');

            if (scorecardMarketSelect) {
                scorecardMarketSelect.onchange = () => {
                    state.scorecardMarket = scorecardMarketSelect.value;
                    const content = document.getElementById('scorecardContent');
                    if (content) {
                        content.innerHTML = renderScorecardTable(
                            state.scorecardMarket,
                            state.scorecardMonth || getAvailableMonths()[getAvailableMonths().length - 1]
                        );
                        attachScorecardRowHandlers();
                    }
                };
            }

            if (scorecardMonthSelect) {
                scorecardMonthSelect.onchange = () => {
                    state.scorecardMonth = scorecardMonthSelect.value;
                    const content = document.getElementById('scorecardContent');
                    if (content) {
                        content.innerHTML = renderScorecardTable(
                            state.scorecardMarket || getAggregateValue('market'),
                            state.scorecardMonth
                        );
                        attachScorecardRowHandlers();
                    }
                };
            }

            attachScorecardRowHandlers();
            attachChartTooltips();
        }

        function attachScorecardRowHandlers() {
            // Row click handlers - navigate to KPI Deep Dive
            const rows = document.querySelectorAll('.scorecard-row');
            rows.forEach(row => {
                row.onclick = () => {
                    const kpiKey = row.dataset.kpi;
                    if (kpiKey) {
                        state.selectedKPI = kpiKey;
                        state.selectedMarket = state.scorecardMarket || getAggregateValue('market');
                        state.selectedKPIMonth = state.scorecardMonth || getAvailableMonths()[getAvailableMonths().length - 1];
                        state.activeTab = 'kpi';
                        render();
                    }
                };
            });

            // Sortable column headers
            const sortableCols = document.querySelectorAll('.sortable-col');
            sortableCols.forEach(col => {
                col.onclick = (e) => {
                    e.stopPropagation();
                    const sortKey = col.dataset.sort;
                    if (!sortKey) return;

                    // Toggle sort direction if same column, otherwise default to descending
                    if (state.scorecardSort.column === sortKey) {
                        state.scorecardSort.direction = state.scorecardSort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        state.scorecardSort.column = sortKey;
                        state.scorecardSort.direction = 'desc'; // Default to descending (show worst/best first)
                    }

                    // Re-render the scorecard table
                    const content = document.getElementById('scorecardContent');
                    if (content) {
                        content.innerHTML = renderScorecardTable(
                            state.scorecardMarket || getAggregateValue('market'),
                            state.scorecardMonth || getAvailableMonths()[getAvailableMonths().length - 1]
                        );
                        attachScorecardRowHandlers(); // Re-attach handlers
                    }
                };
            });

            // Tooltip handlers for variance cells
            const tooltip = document.getElementById('scorecardTooltip');
            const varianceCells = document.querySelectorAll('.scorecard-table .variance-cell[data-tooltip-title]');

            varianceCells.forEach(cell => {
                cell.addEventListener('mouseenter', (e) => {
                    const title = cell.dataset.tooltipTitle;
                    const value = cell.dataset.tooltipValue;
                    const variance = cell.dataset.tooltipVariance;
                    const actual = cell.dataset.tooltipActual;

                    if (!title) return;

                    // Show comparison value name with its value at the top in bold
                    let html = `<div class="scorecard-tooltip-title">${title}: ${value || '—'}</div>`;

                    if (actual) {
                        html += `<div class="scorecard-tooltip-row">
                            <span class="scorecard-tooltip-label">Actual:</span>
                            <span class="scorecard-tooltip-value">${actual}</span>
                        </div>`;
                    }

                    if (variance) {
                        html += `<div class="scorecard-tooltip-row">
                            <span class="scorecard-tooltip-label">Variance:</span>
                            <span class="scorecard-tooltip-value">${variance}</span>
                        </div>`;
                    }

                    tooltip.innerHTML = html;
                    tooltip.classList.add('visible');
                });

                cell.addEventListener('mousemove', (e) => {
                    tooltip.style.left = (e.clientX + 12) + 'px';
                    tooltip.style.top = (e.clientY - 10) + 'px';
                });

                cell.addEventListener('mouseleave', () => {
                    tooltip.classList.remove('visible');
                });
            });
        }

        function attachChartTooltips() {
            const tooltip = document.getElementById('chartTooltip');
            const dots = document.querySelectorAll('.chart-dot');

            dots.forEach(dot => {
                dot.addEventListener('mouseenter', (e) => {
                    const info = JSON.parse(e.target.dataset.info);
                    const changeVsLY = calcChange(info.ytd, info.lytd, info.format);
                    const changeVsTarget = info.target ? calcTargetGap(info.ytd, info.target, info.format) : null;
                    tooltip.innerHTML = `
                        <div class="tooltip-title">${info.month}</div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">2025:</span>
                            <span class="tooltip-value">${formatValue(info.ytd, info.format)}</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">vs LY:</span>
                            <span class="tooltip-value">${formatValue(info.lytd, info.format)} <span style="color:${changeVsLY >= 0 ? '#2E7D5A' : '#C4314B'}">(${formatChange(changeVsLY, info.format)})</span></span>
                        </div>
                        ${info.target ? `
                        <div class="tooltip-row">
                            <span class="tooltip-label">vs Target:</span>
                            <span class="tooltip-value">${formatValue(info.target, info.format)} <span style="color:${changeVsTarget >= 0 ? '#2E7D5A' : '#C4314B'}">(${formatChange(changeVsTarget, info.format)})</span></span>
                        </div>
                        ` : ''}
                    `;
                    tooltip.classList.add('visible');
                });

                dot.addEventListener('mousemove', (e) => {
                    tooltip.style.left = (e.clientX + 15) + 'px';
                    tooltip.style.top = (e.clientY - 10) + 'px';
                });

                dot.addEventListener('mouseleave', () => {
                    tooltip.classList.remove('visible');
                });
            });
        }

        function loadFile(file) {
            const reader = new FileReader();
            reader.onload = e => {
                const data = parseCSV(e.target.result);
                if (data.length > 0) {
                    state.data = data;
                    state.dataLoaded = true;
                    state.loading = false;
                    state.activeTab = 'summary';
                    render();
                } else {
                    alert('Could not parse CSV. Please check the format.');
                }
            };
            reader.readAsText(file);
        }

        // Auto-detect CSV files
        async function autoDetectCSV() {
            for (const filename of CSV_FILES_TO_TRY) {
                try {
                    const response = await fetch(filename);
                    if (response.ok) {
                        const text = await response.text();
                        const data = parseCSV(text);
                        if (data.length > 0) {
                            state.data = data;
                            state.dataLoaded = true;
                            state.loading = false;
                            console.log(`Auto-loaded data from: ${filename}`);
                            render();
                            return;
                        }
                    }
                } catch (e) {
                    // File not found or error, try next
                }
            }

            // No file found, show upload UI
            state.loading = false;
            state.autoDetectFailed = true;
            render();
        }

        // Initialize
        render();
        autoDetectCSV();
    })();
    </script>
</body>
</html>
